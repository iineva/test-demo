<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>星伴 - 完整交互原型</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #F472B6;
            --accent: #34D399;
            --warning: #FBBF24;
            --bg-gradient: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #1E1B4B;
            --text-secondary: #6B7280;
            --text-muted: #6B7280;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            --shadow-soft: 0 4px 20px rgba(124, 58, 237, 0.1);
            --shadow-float: 0 10px 40px rgba(124, 58, 237, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            font-family: 'Nunito', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: var(--text-primary);
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Fredoka', sans-serif;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-gradient);
            position: relative;
            overflow: hidden;
        }

        /* ===== Header ===== */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid rgba(124, 58, 237, 0.08);
            position: relative;
            z-index: 10;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info .user-name {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 15px;
        }

        .user-info .user-streak {
            font-size: 12px;
            color: var(--warning);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-size: 14px;
        }

        .menu-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* ===== Pages Container ===== */
        .pages-container {
            height: calc(100vh - 56px - 64px);
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 100px;
            /* 增加底部间距，确保不被导航栏遮挡 */
            display: none;
            animation: fadeIn 0.25s ease-out;
            /* 关键修复：添加不透明背景防止重叠 */
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 1;
        }

        .page.active {
            display: block;
            z-index: 5;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ===== Bottom Navigation - 优化版 ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 420px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            padding: 4px 12px 8px;
            /* 极简 padding */
            /* 减小 padding 使导航栏更紧凑 */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(124, 58, 237, 0.1);
            box-shadow: 0 -4px 20px rgba(124, 58, 237, 0.08);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .bottom-nav.minimal {
            padding: 8px 16px 24px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            /* 最小间距 */
            padding: 4px 10px;
            /* 最小内边距 */
            border-radius: 12px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 24px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item .nav-icon {
            display: block;
            width: 24px;
            height: 24px;
            margin: 0 auto 2px auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* [已废弃] 旧的 SVG 子元素样式，现改用 background-image
        .nav-item .nav-icon svg { ... }
        .nav-item.active .nav-icon svg { ... }
        */

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        /* 图标背景图定义 - 默认状态 (灰色) */
        .nav-item .nav-icon.icon-home {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTIwIDJINGMtMS4xIDAtMiAuOS0yIDJ2MThsNC00aDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bTAgMTRINS4xN0w0IDE3LjE3VjRoMTZ2MTJ6Ii8+PC9zdmc+');
        }

        .nav-item .nav-icon.icon-tasks {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTE5IDNINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDVWNWgxNHYxNHpNMTcuOTkgOWwtMS40MS0xLjQyLTYuNTkgNi41OS0yLjU4LTIuNTctMS40MiAxLjQxIDQgMy45OXoiLz48L3N2Zz4=');
        }

        .nav-item .nav-icon.icon-rewards {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTIwIDZoLTIuMThjLjExLS4zMS4xOC0uNjUuMTgtMSAwLTEuNjYtMS4zNC0zLTMtMy0xLjA1IDAtMS45Ni41NC0yLjUgMS4zNWwtLjUuNjctLjUtLjY4QzEwLjk2IDIuNTQgMTAuMDUgMiA5IDIgNy4zNCAyIDYgMy4zNCA2IDVjMCAuMzUuMDcuNjkuMTggMUg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOWMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS01LTJjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXpNOSA0Yy41NSAwIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxLTEtLjQ1LTEtMSAuNDUtMSAxLTF6bTExIDE1SDR2LTJoMTZ2MnptMC01SDRWOGg1LjA4TDcgMTAuODMgOC42MiAxMiAxMiA3LjRsMy4zOCA0LjZMMTcgMTAuODMgMTQuOTIgOEgyMHY2eiIvPjwvc3ZnPg==');
        }

        .nav-item .nav-icon.icon-profile {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==');
        }

        /* 图标背景图定义 - 激活状态 (紫色) */
        .nav-item.active .nav-icon.icon-home {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTIwIDJINGMtMS4xIDAtMiAuOS0yIDJ2MThsNC00aDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bTAgMTRINS4xN0w0IDE3LjE3VjRoMTZ2MTJ6Ii8+PC9zdmc+');
        }

        .nav-item.active .nav-icon.icon-tasks {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTE5IDNINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDVWNWgxNHYxNHpNMTcuOTkgOWwtMS40MS0xLjQyLTYuNTkgNi41OS0yLjU4LTIuNTctMS40MiAxLjQxIDQgMy45OXoiLz48L3N2Zz4=');
        }

        .nav-item.active .nav-icon.icon-rewards {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTIwIDZoLTIuMThjLjExLS4zMS4xOC0uNjUuMTgtMSAwLTEuNjYtMS4zNC0zLTMtMy0xLjA1IDAtMS45Ni41NC0yLjUgMS4zNWwtLjUuNjctLjUtLjY4QzEwLjk2IDIuNTQgMTAuMDUgMiA5IDIgNy4zNCAyIDYgMy4zNCA2IDVjMCAuMzUuMDcuNjkuMTggMUg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOWMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS01LTJjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXpNOSA0Yy41NSAwIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxLTEtLjQ1LTEtMSAuNDUtMSAxLTF6bTExIDE1SDR2LTJoMTZ2MnptMC01SDRWOGg1LjA4TDcgMTAuODMgOC42MiAxMiAxMiA3LjRsMy4zOCA0LjZMMTcgMTAuODMgMTQuOTIgOEgyMHY2eiIvPjwvc3ZnPg==');
        }

        .nav-item.active .nav-icon.icon-profile {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==');
        }

        .nav-item .nav-label {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.25s;
        }

        .nav-item.active .nav-label {
            color: var(--primary);
            font-weight: 700;
        }

        .nav-item:hover {
            background: rgba(124, 58, 237, 0.06);
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 10px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #EF4444, #F472B6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* ===== 对话页 (HOME) ===== */
        #page-home {
            display: none;
            flex-direction: column;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
        }

        #page-home.active {
            display: flex;
            z-index: 5;
        }

        /* ===== 伙伴展示舞台 ===== */
        .partner-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px 16px;
            position: relative;
        }

        .stage-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.6;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
        }

        .partner-character {
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .partner-character:hover {
            transform: scale(1.05);
        }

        .partner-character:active {
            transform: scale(0.98);
        }

        .partner-image {
            width: 140px;
            height: 140px;
            object-fit: contain;
            filter: drop-shadow(0 8px 16px rgba(124, 58, 237, 0.2));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .partner-expression {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .partner-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 12px;
            z-index: 2;
        }

        .partner-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .partner-level {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .level-badge {
            padding: 3px 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 20px;
        }

        .level-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .level-progress {
            width: 120px;
            height: 6px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .level-hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ===== 对话气泡 ===== */
        .partner-dialog {
            padding: 0 20px;
            margin-bottom: 16px;
        }

        .dialog-bubble {
            background: var(--bg-card);
            padding: 14px 18px;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .dialog-bubble::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--bg-card);
        }

        .dialog-bubble p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            text-align: center;
        }

        /* ===== 快捷标签区 ===== */
        .quick-section {
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-tag {
            padding: 10px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.15);
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
        }

        .quick-tag:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        /* ===== 今日任务预览 ===== */
        .today-tasks-preview {
            margin: 0 16px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .preview-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .preview-count {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(124, 58, 237, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .view-all-btn {
            margin-left: auto;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
        }

        .preview-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(124, 58, 237, 0.03);
            border-radius: 12px;
        }

        .preview-item.done {
            opacity: 0.6;
        }

        .preview-item.done .item-name {
            text-decoration: line-through;
        }

        .item-check {
            font-size: 16px;
        }

        .item-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .item-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        /* ===== 对话扩展区 ===== */
        .chat-expand-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-expand-area.hidden {
            display: none;
        }

        /* ===== 输入区域 ===== */
        .input-area {
            padding: 12px 16px 16px;
            background: var(--bg-card);
            border-top: 1px solid rgba(124, 58, 237, 0.08);
            margin-top: auto;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(124, 58, 237, 0.12);
            border-radius: var(--radius-full);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .input-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .voice-btn {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* 保留消息样式用于对话扩展区 */
        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: msgIn 0.3s ease-out;
        }

        /* 思考动画 */
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            margin: 8px 0;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: thinkPulse 1.4s ease-in-out infinite;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinkPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.partner {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            line-height: 1.5;
        }

        .message.partner .msg-bubble {
            background: var(--bg-card);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-soft);
        }

        .message.user .msg-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 0 4px;
        }

        .quick-tag {
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.15);
            transition: all 0.2s;
        }

        .quick-tag:hover {
            background: var(--primary);
            color: white;
        }

        .input-area {
            padding: 12px 16px 16px;
            background: var(--bg-card);
            border-top: 1px solid rgba(124, 58, 237, 0.08);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(124, 58, 237, 0.12);
            border-radius: var(--radius-full);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .input-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .voice-btn {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* Task Plan Card */
        .task-plan {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-float);
            margin: 8px 0;
        }

        .plan-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(244, 114, 182, 0.08));
        }

        .plan-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .plan-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .plan-steps {
            padding: 8px 16px;
        }

        .step-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .step-row:last-child {
            border-bottom: none;
        }

        .step-num {
            width: 26px;
            height: 26px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-icon {
            font-size: 20px;
        }

        .step-info {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            font-size: 14px;
        }

        .step-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .step-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        .plan-bonus {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(52, 211, 153, 0.1));
        }

        .bonus-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .bonus-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
        }

        .action-btns {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius-full);
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.35);
        }

        .action-btn.secondary {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        /* 任务调整选项 */
        .adjust-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 16px 0;
        }

        .adjust-option {
            padding: 14px 12px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            box-shadow: var(--shadow-soft);
            transition: all 0.2s;
        }

        .adjust-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-float);
        }

        .adjust-option:active {
            transform: scale(0.97);
        }

        .adjust-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .adjust-action-btn {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-full);
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            transition: all 0.2s;
        }

        .adjust-action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .task-plan.compact {
            padding: 10px 14px;
            margin-top: 10px;
        }

        .task-plan.compact .step-row {
            padding: 8px 0;
        }

        /* 家长任务提示 */
        .parent-task-note {
            background: rgba(244, 114, 182, 0.1);
            border-radius: var(--radius-md);
            padding: 12px;
            font-size: 13px;
            color: var(--secondary);
            text-align: center;
            margin: 12px 0;
        }

        /* ===== 任务页 (TASKS) ===== */
        .page-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 20px;
        }

        .view-toggle {
            display: flex;
            background: rgba(124, 58, 237, 0.08);
            border-radius: var(--radius-full);
            padding: 3px;
        }

        .toggle-btn {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: var(--radius-full);
        }

        .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-soft);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 16px 0 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-card.in-progress {
            border-left: 4px solid var(--primary);
        }

        .task-card.parent-task {
            border-left: 4px solid var(--secondary);
        }

        .task-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .task-progress {
            font-size: 12px;
            color: var(--primary);
            margin-top: 4px;
        }

        .task-action-btn {
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .task-action-btn.continue {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .task-action-btn.start {
            background: rgba(52, 211, 153, 0.15);
            color: var(--accent);
        }

        .plan-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-soft);
        }

        .plan-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .plan-card-icon {
            font-size: 24px;
        }

        .plan-card-title {
            font-weight: 600;
            font-size: 15px;
        }

        .plan-card-day {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar.large {
            height: 10px;
            overflow: visible;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ===== 长期计划卡片增强版 ===== */
        .long-plan-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-float);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .long-plan-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .plan-card-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .plan-icon-wrap {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(244, 114, 182, 0.15));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plan-emoji {
            font-size: 26px;
        }

        .plan-main-info {
            flex: 1;
        }

        .plan-title {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .plan-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .plan-streak {
            display: flex;
            align-items: center;
            gap: 2px;
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            padding: 6px 10px;
            border-radius: 20px;
        }

        .streak-fire {
            font-size: 14px;
        }

        .streak-num {
            font-size: 14px;
            font-weight: 700;
            color: #D97706;
        }

        .plan-stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            margin-bottom: 12px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .plan-stat {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .plan-progress-section {
            margin-bottom: 14px;
        }

        .progress-milestone {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .milestone-dot {
            display: block;
            width: 14px;
            height: 14px;
            background: white;
            border: 3px solid rgba(124, 58, 237, 0.3);
            border-radius: 50%;
        }

        .milestone-dot.done {
            background: var(--accent);
            border-color: var(--accent);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .progress-labels .current {
            color: var(--primary);
            font-weight: 600;
        }

        .plan-today-task {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
        }

        .today-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .today-content {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .today-start-btn {
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            flex-shrink: 0;
        }

        .today-start-btn:hover {
            transform: scale(1.05);
        }

        .create-plan-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            background: rgba(124, 58, 237, 0.08);
            border: 2px dashed rgba(124, 58, 237, 0.3);
            border-radius: var(--radius-lg);
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .create-plan-btn:hover {
            background: rgba(124, 58, 237, 0.15);
            border-color: var(--primary);
        }

        .create-icon {
            font-size: 20px;
            font-weight: 300;
        }

        .section-count {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .task-from-plan {
            font-size: 11px;
            color: var(--primary);
            margin-top: 2px;
        }

        /* 家长发布的任务样式 */
        .task-card.parent-task {
            border-left: 3px solid var(--secondary);
            background: linear-gradient(90deg, rgba(244, 114, 182, 0.05) 0%, var(--bg-card) 20%);
        }

        .task-from-parent {
            font-size: 11px;
            color: var(--secondary);
            margin-top: 2px;
            font-weight: 500;
        }

        /* 新任务通知徽章 */
        .new-task-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* ===== 家长中心样式 ===== */
        .parent-center-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .parent-center-overlay.active {
            display: flex;
        }

        .parent-center-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
        }

        .parent-center-title {
            font-size: 18px;
            font-weight: 700;
        }

        .parent-center-close {
            font-size: 20px;
            padding: 8px;
            color: white;
            cursor: pointer;
        }

        .parent-center-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .parent-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .parent-menu-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            transition: all 0.2s;
        }

        .parent-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .parent-menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .parent-menu-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .parent-menu-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* 任务管理面板 */
        .task-manage-section {
            margin-top: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-header h3 {
            font-size: 16px;
            color: var(--text-primary);
        }

        .add-task-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .parent-task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .parent-task-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-soft);
        }

        .parent-task-item.pending {
            border-left: 3px solid var(--warning);
        }

        .parent-task-item.sent {
            border-left: 3px solid var(--primary);
        }

        .parent-task-item.completed {
            border-left: 3px solid var(--success);
            opacity: 0.8;
        }

        .parent-task-info {
            flex: 1;
        }

        .parent-task-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .parent-task-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .parent-task-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .parent-task-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .parent-task-status.sent {
            background: rgba(124, 58, 237, 0.15);
            color: var(--primary);
        }

        .parent-task-status.completed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        /* 发布任务表单弹窗 */
        .create-task-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .create-task-modal.active {
            display: flex;
        }

        .create-task-content {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .create-task-header {
            padding: 20px 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .create-task-header h3 {
            font-size: 18px;
            color: var(--text-primary);
        }

        .create-task-close {
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .create-task-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: var(--radius-md);
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: white;
        }

        .reward-slider {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reward-slider input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }

        .reward-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            min-width: 60px;
            text-align: right;
        }

        .quick-task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-task-tag {
            padding: 8px 14px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: var(--radius-full);
            font-size: 13px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-task-tag:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .submit-task-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-full);
            font-size: 16px;
            font-weight: 700;
            margin-top: 8px;
            cursor: pointer;
        }

        .submit-task-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===== 奖励页 (REWARDS) ===== */
        .reward-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .reward-tab {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            color: var(--text-secondary);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
        }

        .reward-tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }

        .shop-item-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .shop-item-price {
            font-size: 13px;
            color: var(--warning);
            font-weight: 600;
        }

        .shop-item-owned {
            font-size: 12px;
            color: var(--accent);
        }

        .shop-item.owned {
            opacity: 0.7;
        }

        .shop-item.locked {
            opacity: 0.5;
        }

        .shop-item-price.vip {
            color: var(--primary);
        }

        /* Tab内容切换 */
        .reward-content {
            display: none;
        }

        .reward-content.active {
            display: block;
            animation: fadeIn 0.25s ease-out;
        }

        /* ===== 装扮试穿系统样式 ===== */
        .dressup-preview-area {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.08) 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .dressup-preview-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(180deg);
            }
        }

        .dressup-character {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dressup-body {
            font-size: 80px;
            z-index: 1;
        }

        .dressup-body img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .dressup-layer {
            position: absolute;
            font-size: 32px;
            z-index: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dressup-layer.head {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dressup-layer.back {
            bottom: 5px;
            right: -10px;
            font-size: 28px;
        }

        .dressup-layer.trying {
            animation: bounce 0.5s ease-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.2);
            }
        }

        .dressup-status {
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .trying-label {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .equipped-label {
            color: var(--text-muted);
        }

        /* 已装备槽位 */
        .equipped-items {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .equipped-slot {
            background: var(--bg-card);
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 16px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .equipped-slot:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .equipped-slot.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .slot-icon {
            font-size: 20px;
        }

        .slot-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 分类标签 */
        .dressup-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .category-btn {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid rgba(124, 58, 237, 0.15);
            background: var(--bg-card);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-color: transparent;
        }

        /* 装扮物品网格 */
        .dressup-items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .dressup-item {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .dressup-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.15);
        }

        .dressup-item.trying {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
        }

        .dressup-item.equipped {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
        }

        .dressup-item.locked {
            opacity: 0.5;
        }

        .item-preview {
            font-size: 36px;
            margin-bottom: 6px;
        }

        .item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .item-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .item-price {
            font-size: 11px;
            color: var(--warning);
            font-weight: 600;
        }

        .item-status {
            font-size: 10px;
            font-weight: 500;
        }

        .item-status.owned {
            color: var(--accent);
        }

        .item-status.equipped {
            color: var(--primary);
        }

        .item-locked {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* 操作栏 */
        .dressup-actions {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            animation: slideUp 0.3s ease-out;
        }

        .action-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.cancel {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-secondary);
        }

        .action-btn.confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .action-btn.confirm:hover {
            transform: scale(1.02);
        }

        #action-price {
            margin-left: 6px;
            opacity: 0.9;
        }

        /* ===== 进化页样式 ===== */
        .evolve-partner-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }

        .evolve-partner-img {
            position: relative;
        }

        .evolve-partner-img img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            animation: float 3s ease-in-out infinite;
        }

        .evolve-level-badge {
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .evolve-partner-info {
            flex: 1;
        }

        .evolve-partner-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .evolve-partner-stage {
            font-size: 14px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .evolve-progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .evolve-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        .evolve-progress-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        .evolve-stages {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 12px;
            margin-bottom: 16px;
        }

        .evolve-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .evolve-stage:last-child {
            border-bottom: none;
        }

        .stage-icon {
            font-size: 28px;
        }

        .stage-info {
            flex: 1;
        }

        .stage-name {
            font-weight: 600;
            font-size: 15px;
        }

        .stage-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stage-status {
            font-size: 18px;
        }

        .evolve-stage.done .stage-name {
            color: var(--accent);
        }

        .evolve-stage.current .stage-name {
            color: var(--primary);
        }

        .evolve-stage.locked {
            opacity: 0.5;
        }

        .evolve-tip {
            background: rgba(251, 191, 36, 0.15);
            border-radius: var(--radius-md);
            padding: 14px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
        }

        /* ===== 心愿页样式 ===== */
        .wish-balance {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }

        .wish-balance-icon {
            font-size: 28px;
        }

        .wish-balance-num {
            font-family: 'Fredoka', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .wish-balance-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .wish-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .wish-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        .wish-icon {
            font-size: 32px;
        }

        .wish-info {
            flex: 1;
        }

        .wish-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .wish-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .wish-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .wish-price span {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .wish-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .wish-btn.disabled {
            background: #ccc;
            color: #888;
        }

        .wish-btn.add {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .wish-history {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .history-icon {
            font-size: 20px;
        }

        .history-name {
            flex: 1;
            font-size: 14px;
        }

        .history-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-status {
            font-size: 12px;
        }

        .history-status.done {
            color: var(--accent);
        }

        /* ===== 我的页 (PROFILE) ===== */
        .profile-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-stat {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .profile-badge {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: var(--radius-full);
        }

        .profile-badge.free {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-secondary);
        }

        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .menu-icon.gold {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        }

        .menu-icon.blue {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        }

        .menu-icon.pink {
            background: linear-gradient(135deg, #FCE7F3, #FBCFE8);
        }

        .menu-icon.purple {
            background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
        }

        .menu-icon.gray {
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
        }

        .menu-content {
            flex: 1;
        }

        .menu-title {
            font-weight: 600;
            font-size: 15px;
        }

        .menu-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .menu-arrow {
            color: var(--text-muted);
            font-size: 18px;
        }

        .menu-item:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* ===== 成长数据统计 ===== */
        .stats-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .stats-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }

        .stat-item {
            text-align: center;
            padding: 10px 4px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
        }

        .stat-num {
            display: block;
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .stats-week {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .week-label {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .week-dots {
            display: flex;
            gap: 6px;
            flex: 1;
            justify-content: space-between;
        }

        .week-dots .dot {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            border-radius: 50%;
            background: rgba(124, 58, 237, 0.1);
            color: var(--text-muted);
        }

        .week-dots .dot.done {
            background: var(--accent);
            color: white;
        }

        .week-dots .dot.current {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }

        /* ===== 徽章墙 ===== */
        .badges-section {
            margin-bottom: 16px;
        }

        .badge-count {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s;
        }

        .badge-item:active {
            transform: scale(0.95);
        }

        .badge-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .badge-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        .badge-item.owned {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(244, 114, 182, 0.08));
        }

        .badge-item.owned .badge-name {
            color: var(--primary);
        }

        .badge-item.locked {
            opacity: 0.5;
        }

        /* ===== 执行模式 ===== */
        .execution-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .execution-overlay.active {
            display: flex;
        }

        .exec-header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
        }

        .exec-back {
            font-size: 22px;
            padding: 8px;
            margin-right: 8px;
        }

        .exec-title {
            font-size: 17px;
            font-weight: 600;
        }

        .exec-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .exec-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-float);
        }

        .exec-step-num {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 16px;
        }

        .exec-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .exec-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .exec-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .exec-timer {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: var(--radius-full);
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .exec-encourage {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            max-width: 300px;
            box-shadow: var(--shadow-soft);
        }

        .exec-encourage img {
            width: 44px;
            height: 44px;
            object-fit: contain;
        }

        .exec-encourage-text {
            font-size: 14px;
            text-align: left;
        }

        .exec-complete-btn {
            width: 100%;
            max-width: 260px;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #10B981);
            color: white;
            font-size: 17px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4);
        }

        .exec-progress {
            display: flex;
            gap: 6px;
            margin-top: 20px;
            max-width: 260px;
        }

        .exec-progress-dot {
            flex: 1;
            height: 6px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 3px;
        }

        .exec-progress-dot.done {
            background: var(--accent);
        }

        .exec-progress-dot.current {
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        /* ===== V2.0 时间追踪样式 ===== */

        .exec-timer-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .exec-time-section {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 20px 0;
            padding: 16px;
            background: rgba(124, 58, 237, 0.05);
            border-radius: var(--radius-lg);
        }

        .exec-timer-display,
        .exec-estimated-display {
            text-align: center;
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .timer-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--primary);
        }

        .timer-value.timer-estimated {
            color: var(--text-secondary);
            font-size: 24px;
        }

        .timer-value.warning {
            color: var(--warning);
        }

        .timer-value.overtime {
            color: #EF4444;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .time-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(52, 211, 153, 0.1);
            border-radius: var(--radius-full);
            color: var(--accent);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .time-status.paused {
            background: rgba(251, 191, 36, 0.1);
            color: var(--warning);
        }

        .time-status.overtime {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .time-adjust-hint {
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .time-adjust-hint:hover {
            background: rgba(124, 58, 237, 0.05);
            color: var(--primary);
        }

        .exec-btn-group {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        .exec-pause-btn {
            flex: 0 0 auto;
            padding: 16px 20px;
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-full);
            transition: all 0.2s;
        }

        .exec-pause-btn:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .exec-pause-btn.paused {
            background: var(--warning);
            color: white;
        }

        /* ===== 庆祝弹窗 ===== */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .celebration-overlay.active {
            display: flex;
        }

        .cel-icon {
            font-size: 72px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .cel-title {
            font-size: 28px;
            font-weight: 700;
            margin: 12px 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cel-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .cel-reward {
            font-size: 42px;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 28px;
        }

        .cel-btn {
            padding: 14px 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 17px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        }

        /* ===== 计划详情弹窗 ===== */
        .plan-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 300;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .plan-detail-overlay.active {
            display: flex;
        }

        .plan-detail-modal {
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            background: var(--bg-gradient);
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .plan-detail-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
        }

        .back-btn {
            font-size: 20px;
            padding: 8px;
            color: var(--text-primary);
        }

        .plan-detail-title {
            flex: 1;
            text-align: center;
            font-family: 'Fredoka', sans-serif;
            font-size: 17px;
            font-weight: 600;
        }

        .more-btn {
            font-size: 18px;
            padding: 8px;
            color: var(--text-secondary);
        }

        .plan-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* 进度环 */
        .progress-ring-section {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .progress-ring {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .ring-bg {
            fill: none;
            stroke: rgba(124, 58, 237, 0.1);
            stroke-width: 8;
        }

        .ring-fill {
            fill: none;
            stroke: url(#gradient) var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 264;
            transition: stroke-dashoffset 0.5s ease;
        }

        .ring-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .ring-day {
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .ring-total {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ring-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ring-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ring-stat-icon {
            font-size: 16px;
        }

        .ring-stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .ring-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* 通用section标题 */
        .section-heading {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* 阶段进度 */
        .phases-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .phase-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .phase-status {
            font-size: 18px;
        }

        .phase-info {
            flex: 1;
        }

        .phase-name {
            font-weight: 600;
            font-size: 14px;
        }

        .phase-days {
            font-size: 12px;
            color: var(--text-muted);
        }

        .phase-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        .phase-reward.claimed {
            color: var(--accent);
        }

        .phase-item.done .phase-name {
            color: var(--accent);
        }

        .phase-item.current .phase-name {
            color: var(--primary);
        }

        .phase-item.locked {
            opacity: 0.5;
        }

        /* 本周打卡 */
        .week-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .week-grid {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .day-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .day-status {
            font-size: 18px;
        }

        .week-day.done .day-label {
            color: var(--accent);
        }

        .week-day.current {
            background: rgba(124, 58, 237, 0.1);
            padding: 6px 10px;
            border-radius: 10px;
            margin: -6px -4px;
        }

        .week-day.current .day-label {
            color: var(--primary);
        }

        .week-bonus {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            padding-top: 8px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
        }

        /* 今日任务 */
        .today-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .today-task-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .today-task-icon {
            font-size: 28px;
        }

        .today-task-info {
            flex: 1;
        }

        .today-task-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .today-task-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .start-today-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.35);
        }

        .start-today-btn:hover {
            transform: translateY(-2px);
        }

        /* 操作按钮 */
        .plan-actions {
            display: flex;
            gap: 10px;
            padding: 16px 0;
        }

        .plan-action-btn {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 12px;
            text-align: center;
        }

        .plan-action-btn.pause {
            background: rgba(251, 191, 36, 0.15);
            color: #D97706;
        }

        .plan-action-btn.adjust {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .plan-action-btn.quit {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="user-section" onclick="showUserProfile()">
                <img src="assets/partner_kuqi.png" alt="" class="user-avatar">
                <div class="user-info">
                    <div class="user-name">小星星</div>
                    <div class="user-streak">🔥 连续7天</div>
                </div>
            </div>
            <div class="header-right">
                <div class="header-stats">
                    <div class="stat" onclick="showStarDetail()">🌟 <span id="star-count">128</span></div>
                    <div class="stat" onclick="showDiamondDetail()">💎 <span id="diamond-count">45</span></div>
                </div>
                <button class="menu-btn" onclick="showHeaderMenu()">⋯</button>
            </div>
        </header>

        <!-- Pages -->
        <div class="pages-container">
            <!-- 对话页 - 突出伙伴展示 -->
            <div id="page-home" class="page active">
                <!-- 伙伴展示舞台 -->
                <div class="partner-stage">
                    <div class="stage-glow"></div>
                    <div class="partner-character" id="partner-display" onclick="interactPartner()">
                        <img src="assets/partner_kuqi.png" alt="酷奇" class="partner-image">
                        <div class="partner-expression" id="partner-expr"></div>
                    </div>
                    <div class="partner-info">
                        <span class="partner-name">酷奇</span>
                        <div class="partner-level">
                            <span class="level-badge">Lv.2</span>
                            <span class="level-text">成长期</span>
                        </div>
                        <div class="level-progress">
                            <div class="level-bar" style="width: 65%"></div>
                        </div>
                        <span class="level-hint">还需105活跃度进化</span>
                    </div>
                </div>

                <!-- 对话气泡 -->
                <div class="partner-dialog">
                    <div class="dialog-bubble" id="dialog-bubble">
                        <p id="partner-message">嗨~小星星！今天想完成什么目标呀？告诉我，我来帮你规划！✨</p>
                    </div>
                </div>

                <!-- 快捷标签 -->
                <div class="quick-section">
                    <div class="quick-tags" id="quick-tags">
                        <button class="quick-tag" onclick="selectGoal('整理房间')">🛏️ 整理房间</button>
                        <button class="quick-tag" onclick="selectGoal('写作业')">📝 写作业</button>
                        <button class="quick-tag" onclick="selectGoal('阅读')">📖 阅读</button>
                        <button class="quick-tag" onclick="selectGoal('运动')">⚽ 运动</button>
                    </div>
                </div>

                <!-- 今日任务预览 -->
                <div class="today-tasks-preview">
                    <div class="preview-header">
                        <span class="preview-title">📋 今日任务</span>
                        <span class="preview-count">2/5 已完成</span>
                        <button class="view-all-btn" onclick="switchPage('tasks')">查看全部 →</button>
                    </div>
                    <div class="preview-list">
                        <div class="preview-item done">
                            <span class="item-check">✅</span>
                            <span class="item-name">整理书桌</span>
                            <span class="item-reward">🌟+5</span>
                        </div>
                        <div class="preview-item">
                            <span class="item-check">⭕</span>
                            <span class="item-name">阅读30分钟</span>
                            <span class="item-reward">🌟+15</span>
                        </div>
                    </div>
                </div>

                <!-- 对话扩展区（用于AI拆解时展示） -->
                <div class="chat-expand-area hidden" id="chat-expand-area"></div>

                <!-- 输入区域 -->
                <div class="input-area">
                    <div class="input-wrapper">
                        <input type="text" class="chat-input" id="chat-input" placeholder="告诉酷奇你想做什么...">
                        <button class="input-btn voice-btn">🎤</button>
                        <button class="input-btn send-btn" onclick="submitGoal()">➤</button>
                    </div>
                </div>
            </div>

            <!-- 任务页 -->
            <div id="page-tasks" class="page">
                <div class="page-title-bar">
                    <h2 class="page-title">📋 我的任务</h2>
                    <div class="view-toggle">
                        <button class="toggle-btn active">📋 列表</button>
                        <button class="toggle-btn">📅 日历</button>
                    </div>
                </div>

                <div class="section-title">⚡ 正在进行</div>
                <div class="task-card in-progress" onclick="continueTask()">
                    <div class="task-icon">🛏️</div>
                    <div class="task-content">
                        <div class="task-name">整理房间</div>
                        <div class="task-meta">还剩15分钟</div>
                        <div class="task-progress">进度 2/4</div>
                    </div>
                    <button class="task-action-btn continue">继续</button>
                </div>

                <div class="section-title">📅 今日待办</div>
                <div class="task-card" onclick="startNewTask()">
                    <div class="task-icon">📖</div>
                    <div class="task-content">
                        <div class="task-name">阅读《小王子》30分钟</div>
                        <div class="task-meta">今天 19:00前 · 🌟+15</div>
                        <div class="task-from-plan">📆 来自：30天阅读计划</div>
                    </div>
                    <button class="task-action-btn start">开始</button>
                </div>
                <div class="task-card">
                    <div class="task-icon">💪</div>
                    <div class="task-content">
                        <div class="task-name">跳绳100个</div>
                        <div class="task-meta">今天 · 🌟+10</div>
                    </div>
                    <button class="task-action-btn start">开始</button>
                </div>

                <!-- 家长发布的任务 -->
                <div class="task-card parent-task" onclick="showParentTask()">
                    <div class="task-icon">📝</div>
                    <div class="task-content">
                        <div class="task-name">完成今天的作业</div>
                        <div class="task-meta">今天 20:00前 · 🌟+25</div>
                        <div class="task-from-parent">📩 来自：妈妈</div>
                    </div>
                    <button class="task-action-btn start">开始</button>
                </div>
                <div class="task-card parent-task">
                    <div class="task-icon">🎹</div>
                    <div class="task-content">
                        <div class="task-name">练琴30分钟</div>
                        <div class="task-meta">今天 · 🌟+20</div>
                        <div class="task-from-parent">📩 来自：爸爸</div>
                    </div>
                    <button class="task-action-btn start">开始</button>
                </div>

                <div class="section-title">📆 进行中的计划 <span class="section-count">2个</span></div>

                <!-- 长期计划卡片 - 增强版 -->
                <div class="long-plan-card" onclick="openPlanDetail('reading')">
                    <div class="plan-card-top">
                        <div class="plan-icon-wrap">
                            <span class="plan-emoji">📖</span>
                        </div>
                        <div class="plan-main-info">
                            <div class="plan-title">30天阅读计划</div>
                            <div class="plan-subtitle">阅读《哈利波特与魔法石》</div>
                        </div>
                        <div class="plan-streak">
                            <span class="streak-fire">🔥</span>
                            <span class="streak-num">12</span>
                        </div>
                    </div>

                    <div class="plan-stats-row">
                        <div class="plan-stat">
                            <span class="stat-value">Day 12</span>
                            <span class="stat-label">/ 30天</span>
                        </div>
                        <div class="plan-stat">
                            <span class="stat-value">🌟 95</span>
                            <span class="stat-label">已获得</span>
                        </div>
                        <div class="plan-stat">
                            <span class="stat-value">阶段2</span>
                            <span class="stat-label">成长期</span>
                        </div>
                    </div>

                    <div class="plan-progress-section">
                        <div class="progress-bar large">
                            <div class="progress-fill" style="width: 40%"></div>
                            <div class="progress-milestone" style="left: 33%">
                                <span class="milestone-dot done"></span>
                            </div>
                            <div class="progress-milestone" style="left: 66%">
                                <span class="milestone-dot"></span>
                            </div>
                        </div>
                        <div class="progress-labels">
                            <span>入门期 ✓</span>
                            <span class="current">成长期</span>
                            <span>冲刺期</span>
                        </div>
                    </div>

                    <div class="plan-today-task">
                        <span class="today-label">📌 今日任务</span>
                        <span class="today-content">阅读第12章（约30分钟）</span>
                        <button class="today-start-btn"
                            onclick="event.stopPropagation();startPlanDailyTask('reading')">开始</button>
                    </div>
                </div>

                <!-- 第二个长期计划 -->
                <div class="long-plan-card" onclick="openPlanDetail('bike')">
                    <div class="plan-card-top">
                        <div class="plan-icon-wrap">
                            <span class="plan-emoji">🚲</span>
                        </div>
                        <div class="plan-main-info">
                            <div class="plan-title">15天学骑车</div>
                            <div class="plan-subtitle">从辅助轮到独立骑行</div>
                        </div>
                        <div class="plan-streak">
                            <span class="streak-fire">🔥</span>
                            <span class="streak-num">3</span>
                        </div>
                    </div>

                    <div class="plan-stats-row">
                        <div class="plan-stat">
                            <span class="stat-value">Day 3</span>
                            <span class="stat-label">/ 15天</span>
                        </div>
                        <div class="plan-stat">
                            <span class="stat-value">🌟 25</span>
                            <span class="stat-label">已获得</span>
                        </div>
                        <div class="plan-stat">
                            <span class="stat-value">阶段1</span>
                            <span class="stat-label">基础期</span>
                        </div>
                    </div>

                    <div class="plan-progress-section">
                        <div class="progress-bar large">
                            <div class="progress-fill" style="width: 20%"></div>
                            <div class="progress-milestone" style="left: 33%">
                                <span class="milestone-dot"></span>
                            </div>
                            <div class="progress-milestone" style="left: 66%">
                                <span class="milestone-dot"></span>
                            </div>
                        </div>
                        <div class="progress-labels">
                            <span class="current">基础期</span>
                            <span>进阶期</span>
                            <span>冲刺期</span>
                        </div>
                    </div>

                    <div class="plan-today-task">
                        <span class="today-label">📌 今日任务</span>
                        <span class="today-content">练习平衡20分钟</span>
                        <button class="today-start-btn"
                            onclick="event.stopPropagation();startPlanDailyTask('bike')">开始</button>
                    </div>
                </div>

                <!-- 创建新计划按钮 -->
                <button class="create-plan-btn" onclick="showCreatePlanDialog()">
                    <span class="create-icon">+</span>
                    <span>创建新的长期计划</span>
                </button>
            </div>

            <!-- 奖励页 -->
            <div id="page-rewards" class="page">
                <h2 class="page-title" style="margin-bottom:16px;">🎁 奖励商城</h2>
                <div class="reward-tabs">
                    <button class="reward-tab active" onclick="switchRewardTab('dress')">🛍️ 装扮</button>
                    <button class="reward-tab" onclick="switchRewardTab('evolve')">✨ 进化</button>
                    <button class="reward-tab" onclick="switchRewardTab('wish')">🎁 心愿</button>
                </div>

                <!-- 装扮Tab内容 - 所见即所得试穿系统 -->
                <div class="reward-content active" id="reward-dress">
                    <!-- 角色预览区 -->
                    <div class="dressup-preview-area">
                        <div class="dressup-character" id="dressup-character">
                            <!-- 装扮层：头饰 -->
                            <div class="dressup-layer head" id="layer-head"></div>
                            <!-- 角色本体 -->
                            <div class="dressup-body">
                                <img src="assets/partner_kuqi.png" alt="酷奇"
                                    onerror="this.style.display='none';this.parentElement.innerHTML='🦁';">
                            </div>
                            <!-- 装扮层：背饰 -->
                            <div class="dressup-layer back" id="layer-back"></div>
                        </div>
                        <div class="dressup-status">
                            <span class="trying-label" id="trying-label" style="display:none;">✨ 试穿中</span>
                            <span class="equipped-label" id="equipped-label">当前装扮</span>
                        </div>
                    </div>

                    <!-- 已穿戴装扮展示 -->
                    <div class="equipped-items" id="equipped-items">
                        <div class="equipped-slot" id="slot-head" onclick="removeEquipped('head')">
                            <span class="slot-icon">👑</span>
                            <span class="slot-name">蝴蝶结</span>
                        </div>
                        <div class="equipped-slot empty" id="slot-back" onclick="removeEquipped('back')">
                            <span class="slot-icon">➕</span>
                            <span class="slot-name">背饰</span>
                        </div>
                    </div>

                    <!-- 分类标签 -->
                    <div class="dressup-categories">
                        <button class="category-btn active" onclick="switchDressCategory('head')">👑 头饰</button>
                        <button class="category-btn" onclick="switchDressCategory('back')">🎒 背饰</button>
                        <button class="category-btn" onclick="switchDressCategory('effect')">✨ 特效</button>
                    </div>

                    <!-- 装扮物品网格 -->
                    <div class="dressup-items-grid" id="dressup-items">
                        <!-- 头饰物品 -->
                        <div class="dressup-item owned equipped" data-id="ribbon" data-category="head" data-emoji="🎀"
                            onclick="tryOnItem(this)">
                            <div class="item-preview">🎀</div>
                            <div class="item-info">
                                <span class="item-name">蝴蝶结</span>
                                <span class="item-status equipped">穿戴中</span>
                            </div>
                        </div>
                        <div class="dressup-item owned" data-id="crown" data-category="head" data-emoji="👑"
                            data-price="50" onclick="tryOnItem(this)">
                            <div class="item-preview">👑</div>
                            <div class="item-info">
                                <span class="item-name">小皇冠</span>
                                <span class="item-status owned">已拥有</span>
                            </div>
                        </div>
                        <div class="dressup-item" data-id="cap" data-category="head" data-emoji="🧢" data-price="30"
                            onclick="tryOnItem(this)">
                            <div class="item-preview">🧢</div>
                            <div class="item-info">
                                <span class="item-name">棒球帽</span>
                                <span class="item-price">🌟 30</span>
                            </div>
                        </div>
                        <div class="dressup-item" data-id="flower" data-category="head" data-emoji="🌸" data-price="25"
                            onclick="tryOnItem(this)">
                            <div class="item-preview">🌸</div>
                            <div class="item-info">
                                <span class="item-name">樱花发饰</span>
                                <span class="item-price">🌟 25</span>
                            </div>
                        </div>
                        <div class="dressup-item locked" data-id="star-crown" data-category="head" data-emoji="⭐"
                            onclick="tryOnItem(this)">
                            <div class="item-preview">⭐</div>
                            <div class="item-info">
                                <span class="item-name">星光头环</span>
                                <span class="item-locked">🔒 会员</span>
                            </div>
                        </div>
                        <!-- 背饰物品（默认隐藏） -->
                        <div class="dressup-item" data-id="wings" data-category="back" data-emoji="🦋" data-price="80"
                            onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">🦋</div>
                            <div class="item-info">
                                <span class="item-name">彩虹翅膀</span>
                                <span class="item-price">🌟 80</span>
                            </div>
                        </div>
                        <div class="dressup-item owned" data-id="rainbow-tail" data-category="back" data-emoji="🌈"
                            onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">🌈</div>
                            <div class="item-info">
                                <span class="item-name">彩虹尾巴</span>
                                <span class="item-status owned">已拥有</span>
                            </div>
                        </div>
                        <div class="dressup-item" data-id="cape" data-category="back" data-emoji="🧣" data-price="60"
                            onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">🧣</div>
                            <div class="item-info">
                                <span class="item-name">英雄披风</span>
                                <span class="item-price">🌟 60</span>
                            </div>
                        </div>
                        <div class="dressup-item" data-id="backpack" data-category="back" data-emoji="🎒"
                            data-price="40" onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">🎒</div>
                            <div class="item-info">
                                <span class="item-name">星星背包</span>
                                <span class="item-price">🌟 40</span>
                            </div>
                        </div>
                        <!-- 特效物品（默认隐藏） -->
                        <div class="dressup-item" data-id="sparkle" data-category="effect" data-emoji="✨"
                            data-price="100" onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">✨</div>
                            <div class="item-info">
                                <span class="item-name">闪亮光环</span>
                                <span class="item-price">🌟 100</span>
                            </div>
                        </div>
                        <div class="dressup-item locked" data-id="fire" data-category="effect" data-emoji="🔥"
                            onclick="tryOnItem(this)" style="display:none;">
                            <div class="item-preview">🔥</div>
                            <div class="item-info">
                                <span class="item-name">火焰特效</span>
                                <span class="item-locked">🔒 VIP</span>
                            </div>
                        </div>
                    </div>

                    <!-- 试穿操作栏 -->
                    <div class="dressup-actions" id="dressup-actions" style="display:none;">
                        <button class="action-btn cancel" onclick="cancelTryOn()">取消试穿</button>
                        <button class="action-btn confirm" id="confirm-btn" onclick="confirmDressup()">
                            <span id="action-text">穿上它！</span>
                            <span id="action-price"></span>
                        </button>
                    </div>
                </div>

                <!-- 进化Tab内容 -->
                <div class="reward-content" id="reward-evolve">
                    <div class="evolve-partner-card">
                        <div class="evolve-partner-img">
                            <img src="assets/partner_kuqi.png" alt="酷奇">
                            <div class="evolve-level-badge">Lv.2</div>
                        </div>
                        <div class="evolve-partner-info">
                            <div class="evolve-partner-name">酷奇</div>
                            <div class="evolve-partner-stage">成长期</div>
                            <div class="evolve-progress">
                                <div class="evolve-progress-bar">
                                    <div class="evolve-progress-fill" style="width:65%"></div>
                                </div>
                                <span class="evolve-progress-text">还需 105 活跃度进化</span>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">🌟 进化之路</div>
                    <div class="evolve-stages">
                        <div class="evolve-stage done">
                            <div class="stage-icon">🥚</div>
                            <div class="stage-info">
                                <div class="stage-name">萌芽期</div>
                                <div class="stage-desc">Lv.1 · 已完成</div>
                            </div>
                            <div class="stage-status">✅</div>
                        </div>
                        <div class="evolve-stage current">
                            <div class="stage-icon">🌱</div>
                            <div class="stage-info">
                                <div class="stage-name">成长期</div>
                                <div class="stage-desc">Lv.2 · 进行中</div>
                            </div>
                            <div class="stage-status">🔵</div>
                        </div>
                        <div class="evolve-stage locked">
                            <div class="stage-icon">🌿</div>
                            <div class="stage-info">
                                <div class="stage-name">成熟期</div>
                                <div class="stage-desc">Lv.3 · 需要300活跃度</div>
                            </div>
                            <div class="stage-status">🔒</div>
                        </div>
                        <div class="evolve-stage locked">
                            <div class="stage-icon">🌳</div>
                            <div class="stage-info">
                                <div class="stage-name">璀璨期</div>
                                <div class="stage-desc">Lv.4 · 需要500活跃度</div>
                            </div>
                            <div class="stage-status">🔒</div>
                        </div>
                    </div>

                    <div class="evolve-tip">
                        💡 完成任务获得活跃度，积累足够后可进化！<br>
                        每次进化解锁新外观和能力~
                    </div>
                </div>

                <!-- 心愿Tab内容 -->
                <div class="reward-content" id="reward-wish">
                    <div class="wish-balance">
                        <span class="wish-balance-icon">💎</span>
                        <span class="wish-balance-num">45</span>
                        <span class="wish-balance-label">心愿币</span>
                    </div>

                    <div class="section-title">🎁 可兑换心愿</div>
                    <div class="wish-list">
                        <div class="wish-item">
                            <div class="wish-icon">🍦</div>
                            <div class="wish-info">
                                <div class="wish-name">一支冰淇淋</div>
                                <div class="wish-desc">让爸爸妈妈买一支冰淇淋</div>
                            </div>
                            <div class="wish-price">
                                <span>💎 20</span>
                                <button class="wish-btn" onclick="exchangeWish('ice')">兑换</button>
                            </div>
                        </div>
                        <div class="wish-item">
                            <div class="wish-icon">🎮</div>
                            <div class="wish-info">
                                <div class="wish-name">游戏时间30分钟</div>
                                <div class="wish-desc">额外的游戏时间</div>
                            </div>
                            <div class="wish-price">
                                <span>💎 30</span>
                                <button class="wish-btn" onclick="exchangeWish('game')">兑换</button>
                            </div>
                        </div>
                        <div class="wish-item">
                            <div class="wish-icon">🎬</div>
                            <div class="wish-info">
                                <div class="wish-name">看一部电影</div>
                                <div class="wish-desc">周末和家人看电影</div>
                            </div>
                            <div class="wish-price">
                                <span>💎 50</span>
                                <button class="wish-btn disabled">余额不足</button>
                            </div>
                        </div>
                        <div class="wish-item">
                            <div class="wish-icon">🎁</div>
                            <div class="wish-info">
                                <div class="wish-name">自定义心愿</div>
                                <div class="wish-desc">和爸爸妈妈商量添加</div>
                            </div>
                            <div class="wish-price">
                                <span>💎 ?</span>
                                <button class="wish-btn add" onclick="addCustomWish()">+ 添加</button>
                            </div>
                        </div>
                    </div>

                    <div class="wish-history">
                        <div class="section-title">📜 兑换记录</div>
                        <div class="history-item">
                            <span class="history-icon">🍦</span>
                            <span class="history-name">一支冰淇淋</span>
                            <span class="history-date">1月8日</span>
                            <span class="history-status done">✅ 已实现</span>
                        </div>
                        <div class="history-item">
                            <span class="history-icon">🎮</span>
                            <span class="history-name">游戏时间30分钟</span>
                            <span class="history-date">1月5日</span>
                            <span class="history-status done">✅ 已实现</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 我的页 -->
            <div id="page-profile" class="page">
                <div class="profile-card">
                    <img src="assets/partner_kuqi.png" alt="" class="profile-avatar">
                    <div class="profile-info">
                        <div class="profile-name">小星星</div>
                        <div class="profile-stat">📅 已坚持 42 天 · ✅ 完成 156 任务</div>
                    </div>
                    <span class="profile-badge free">免费版</span>
                </div>

                <!-- 成长数据统计 -->
                <div class="stats-card">
                    <div class="stats-title">📊 本周成长数据</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-num">12</span>
                            <span class="stat-label">完成任务</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num">🔥7</span>
                            <span class="stat-label">连续天数</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num">98</span>
                            <span class="stat-label">获得星星</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-num">3h</span>
                            <span class="stat-label">专注时长</span>
                        </div>
                    </div>
                    <div class="stats-week">
                        <span class="week-label">本周打卡</span>
                        <div class="week-dots">
                            <span class="dot done">一</span>
                            <span class="dot done">二</span>
                            <span class="dot done">三</span>
                            <span class="dot done">四</span>
                            <span class="dot done">五</span>
                            <span class="dot done">六</span>
                            <span class="dot current">日</span>
                        </div>
                    </div>
                </div>

                <!-- 徽章墙 -->
                <div class="badges-section">
                    <div class="section-title">🏅 我的徽章 <span class="badge-count">6/24</span>
                        <button class="view-all-badges" onclick="showAllBadges()">查看全部 →</button>
                    </div>
                    <div class="badges-grid">
                        <div class="badge-item owned" onclick="showBadgeDetail('bookworm')" data-id="bookworm"
                            data-name="书虫" data-emoji="📚" data-desc="累计阅读时长达到10小时" data-date="2026-01-05">
                            <span class="badge-icon">📚</span>
                            <span class="badge-name">书虫</span>
                        </div>
                        <div class="badge-item owned" onclick="showBadgeDetail('earlybird')" data-id="earlybird"
                            data-name="早起鸟" data-emoji="🌅" data-desc="连续7天在8点前开始任务" data-date="2026-01-08">
                            <span class="badge-icon">🌅</span>
                            <span class="badge-name">早起鸟</span>
                        </div>
                        <div class="badge-item owned" onclick="showBadgeDetail('streak7')" data-id="streak7"
                            data-name="7天连续" data-emoji="🔥" data-desc="连续7天完成每日任务" data-date="2026-01-10">
                            <span class="badge-icon">🔥</span>
                            <span class="badge-name">7天连续</span>
                        </div>
                        <div class="badge-item owned" onclick="showBadgeDetail('organizer')" data-id="organizer"
                            data-name="整理达人" data-emoji="🏠" data-desc="完成10次整理房间任务" data-date="2026-01-09">
                            <span class="badge-icon">🏠</span>
                            <span class="badge-name">整理达人</span>
                        </div>
                        <div class="badge-item owned" onclick="showBadgeDetail('star100')" data-id="star100"
                            data-name="首个100星" data-emoji="⭐" data-desc="累计获得100颗星星" data-date="2026-01-03">
                            <span class="badge-icon">⭐</span>
                            <span class="badge-name">首个100星</span>
                        </div>
                        <div class="badge-item owned" onclick="showBadgeDetail('firstplan')" data-id="firstplan"
                            data-name="首个计划" data-emoji="🎯" data-desc="创建第一个长期计划" data-date="2026-01-06">
                            <span class="badge-icon">🎯</span>
                            <span class="badge-name">首个计划</span>
                        </div>
                        <div class="badge-item locked" onclick="showBadgeDetail('streak30')" data-id="streak30"
                            data-name="30天连续" data-emoji="🏆" data-desc="连续30天完成每日任务" data-progress="7" data-total="30">
                            <span class="badge-icon">🔒</span>
                            <span class="badge-name">30天连续</span>
                        </div>
                        <div class="badge-item locked" onclick="showBadgeDetail('readmaster')" data-id="readmaster"
                            data-name="阅读大师" data-emoji="📖" data-desc="累计阅读时长达到100小时" data-progress="12"
                            data-total="100">
                            <span class="badge-icon">🔒</span>
                            <span class="badge-name">阅读大师</span>
                        </div>
                    </div>
                </div>

                <div class="menu-list">
                    <div class="menu-item" onclick="showVipInfo()">
                        <div class="menu-icon gold">👑</div>
                        <div class="menu-content">
                            <div class="menu-title">开通会员</div>
                            <div class="menu-desc">解锁完整功能</div>
                        </div>
                        <span class="menu-arrow">›</span>
                    </div>
                    <div class="menu-item" onclick="showGrowthData()">
                        <div class="menu-icon blue">📊</div>
                        <div class="menu-content">
                            <div class="menu-title">成长数据</div>
                            <div class="menu-desc">查看你的进步轨迹</div>
                        </div>
                        <span class="menu-arrow">›</span>
                    </div>
                    <div class="menu-item" onclick="showWarehouse()">
                        <div class="menu-icon pink">🎽</div>
                        <div class="menu-content">
                            <div class="menu-title">我的仓库</div>
                            <div class="menu-desc">已收集 8 件装饰</div>
                        </div>
                        <span class="menu-arrow">›</span>
                    </div>
                    <div class="menu-item" onclick="showParentSettings()">
                        <div class="menu-icon purple">👨‍👩‍👧</div>
                        <div class="menu-content">
                            <div class="menu-title">家长设置</div>
                            <div class="menu-desc">管理任务、查看报告</div>
                        </div>
                        <span class="menu-arrow">›</span>
                    </div>
                    <div class="menu-item" onclick="showSettings()">
                        <div class="menu-icon gray">⚙️</div>
                        <div class="menu-content">
                            <div class="menu-title">设置</div>
                            <div class="menu-desc">音效、通知、关于</div>
                        </div>
                        <span class="menu-arrow">›</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="bottom-nav">
            <button class="nav-item active" onclick="switchPage('home')">
                <span class="nav-icon icon-home"></span>
                <span class="nav-label">对话</span>
            </button>
            <button class="nav-item" onclick="switchPage('tasks')" style="position:relative;">
                <span class="nav-icon icon-tasks"></span>
                <span class="nav-label">任务</span>
                <span class="nav-badge">2</span>
            </button>
            <button class="nav-item" onclick="switchPage('rewards')">
                <span class="nav-icon icon-rewards"></span>
                <span class="nav-label">奖励</span>
            </button>
            <button class="nav-item" onclick="switchPage('profile')">
                <span class="nav-icon icon-profile"></span>
                <span class="nav-label">我的</span>
            </button>
        </nav>
    </div>

    <!-- 执行模式 - V2.0 时间追踪版 -->
    <div class="execution-overlay" id="exec-overlay">
        <header class="exec-header">
            <button class="exec-back" onclick="exitExec()">←</button>
            <span class="exec-title">正在进行中</span>
            <span class="exec-timer-badge" id="exec-timer-mini">00:00</span>
        </header>
        <div class="exec-body">
            <div class="exec-card">
                <div class="exec-step-num" id="exec-step-num">步骤 1 / 4</div>
                <div class="exec-icon" id="exec-icon">🛏️</div>
                <div class="exec-name" id="exec-name">铺好床铺</div>
                <div class="exec-desc" id="exec-desc">把被子叠整齐，枕头放好~</div>

                <!-- V2.0 时间追踪区域 -->
                <div class="exec-time-section">
                    <div class="exec-timer-display">
                        <div class="timer-label">已用时间</div>
                        <div class="timer-value" id="exec-timer">00:00</div>
                    </div>
                    <div class="exec-estimated-display">
                        <div class="timer-label">预估时间</div>
                        <div class="timer-value timer-estimated" id="exec-estimated">05:00</div>
                    </div>
                </div>

                <!-- 时间状态指示 -->
                <div class="time-status" id="time-status">
                    <span class="time-status-icon">⏱️</span>
                    <span class="time-status-text" id="time-status-text">正在计时...</span>
                </div>

                <!-- 时间调整入口 -->
                <div class="time-adjust-hint" id="time-adjust-hint" onclick="showStepTimeAdjust()">
                    💡 时间不够？点这里调整
                </div>
            </div>

            <div class="exec-encourage">
                <img src="assets/partner_kuqi.png" alt="">
                <div class="exec-encourage-text">加油！你一定可以的！<br>完成后点下面的按钮~</div>
            </div>

            <!-- 操作按钮 -->
            <div class="exec-btn-group">
                <button class="exec-pause-btn" id="exec-pause-btn" onclick="togglePause()">⏸️ 暂停</button>
                <button class="exec-complete-btn" onclick="completeStep()">✅ 我完成了！</button>
            </div>

            <div class="exec-progress" id="exec-progress">
                <div class="exec-progress-dot current"></div>
                <div class="exec-progress-dot"></div>
                <div class="exec-progress-dot"></div>
                <div class="exec-progress-dot"></div>
            </div>
        </div>
    </div>

    <!-- 庆祝弹窗 -->
    <div class="celebration-overlay" id="cel-overlay">
        <div>
            <div class="cel-icon">🎉</div>
            <div class="cel-title">太棒了！</div>
            <div class="cel-text" id="cel-text">你完成了「铺好床铺」</div>
            <div class="cel-reward" id="cel-reward">+5 🌟</div>
            <button class="cel-btn" onclick="continueAfterCel()">继续下一步 →</button>
        </div>
    </div>

    <!-- 家长中心 -->
    <div class="parent-center-overlay" id="parent-center-overlay">
        <header class="parent-center-header">
            <span class="parent-center-close" onclick="closeParentCenter()">←</span>
            <span class="parent-center-title">👨‍👩‍👧 家长中心</span>
            <span style="width: 36px;"></span>
        </header>
        <div class="parent-center-body">
            <!-- 功能入口 -->
            <div class="parent-menu-grid">
                <div class="parent-menu-item" onclick="showParentTaskManage()">
                    <div class="parent-menu-icon">📋</div>
                    <div class="parent-menu-label">任务管理</div>
                    <div class="parent-menu-desc">发布和查看任务</div>
                </div>
                <div class="parent-menu-item" onclick="showParentWishManage()">
                    <div class="parent-menu-icon">🎁</div>
                    <div class="parent-menu-label">心愿审批</div>
                    <div class="parent-menu-desc">审批心愿兑换</div>
                </div>
                <div class="parent-menu-item" onclick="showParentReport()">
                    <div class="parent-menu-icon">📊</div>
                    <div class="parent-menu-label">成长报告</div>
                    <div class="parent-menu-desc">查看完成情况</div>
                </div>
                <div class="parent-menu-item" onclick="showParentRewardSetting()">
                    <div class="parent-menu-icon">⚙️</div>
                    <div class="parent-menu-label">奖励设置</div>
                    <div class="parent-menu-desc">自定义奖励规则</div>
                </div>
            </div>

            <!-- 任务管理区 -->
            <div class="task-manage-section" id="task-manage-section">
                <div class="section-header">
                    <h3>📋 已发布的任务</h3>
                    <button class="add-task-btn" onclick="showCreateTaskModal()">+ 发布任务</button>
                </div>
                <div class="parent-task-list" id="parent-task-list">
                    <!-- 动态生成任务列表 -->
                </div>
            </div>

            <!-- 快速发布区 -->
            <div class="task-manage-section">
                <div class="section-header">
                    <h3>⚡ 快速发布</h3>
                </div>
                <div class="quick-task-tags">
                    <span class="quick-task-tag" onclick="quickCreateTask('完成今天的作业')">📝 完成作业</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('练琴30分钟')">🎹 练琴</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('阅读30分钟')">📖 阅读</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('整理房间')">🛏️ 整理房间</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('运动锻炼')">💪 运动</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 发布任务弹窗 -->
    <div class="create-task-modal" id="create-task-modal">
        <div class="create-task-content">
            <div class="create-task-header">
                <h3>📝 发布新任务</h3>
                <span class="create-task-close" onclick="closeCreateTaskModal()">×</span>
            </div>
            <div class="create-task-form">
                <div class="form-group">
                    <label class="form-label">任务内容</label>
                    <input type="text" class="form-input" id="new-task-title" placeholder="例如：完成数学作业">
                </div>
                <div class="form-group">
                    <label class="form-label">截止时间</label>
                    <select class="form-select" id="new-task-deadline">
                        <option value="">不限时间</option>
                        <option value="18:00">今天 18:00 前</option>
                        <option value="19:00">今天 19:00 前</option>
                        <option value="20:00">今天 20:00 前</option>
                        <option value="21:00">今天 21:00 前</option>
                        <option value="tomorrow">明天完成</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">心愿币奖励</label>
                    <div class="reward-slider">
                        <input type="range" id="new-task-reward" min="5" max="50" value="20"
                            oninput="updateRewardDisplay()">
                        <span class="reward-value" id="reward-display">💎 20</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">发布者</label>
                    <select class="form-select" id="new-task-from">
                        <option value="妈妈">妈妈</option>
                        <option value="爸爸">爸爸</option>
                        <option value="奶奶">奶奶</option>
                        <option value="爷爷">爷爷</option>
                    </select>
                </div>
                <button class="submit-task-btn" onclick="submitNewTask()">📤 发布任务</button>
            </div>
        </div>
    </div>

    <!-- AI拆解预览弹窗 -->
    <div class="create-task-modal" id="ai-decompose-modal">
        <div class="create-task-content" style="max-width: 420px;">
            <div class="create-task-header">
                <h3>🤖 AI智能拆解预览</h3>
                <span class="create-task-close" onclick="closeDecomposeModal()">×</span>
            </div>
            <div class="create-task-form" id="decompose-content">
                <!-- 动态生成拆解内容 -->
            </div>
        </div>
    </div>

    <!-- 家长验证弹窗 -->
    <div class="create-task-modal" id="parent-verify-modal">
        <div class="create-task-content" style="max-width: 320px;">
            <div class="create-task-header">
                <h3>🔐 家长验证</h3>
                <span class="create-task-close" onclick="closeParentVerifyModal()">×</span>
            </div>
            <div class="create-task-form">
                <p style="text-align:center;color:var(--text-secondary);margin-bottom:16px;">请计算以下算式，验证家长身份</p>
                <div style="text-align:center;font-size:24px;font-weight:700;color:var(--primary);margin-bottom:16px;"
                    id="verify-question-text">15 × 8 = ?</div>
                <div class="form-group">
                    <input type="number" class="form-input" id="verify-input" placeholder="请输入答案"
                        style="text-align:center;font-size:18px;">
                </div>
                <button class="submit-task-btn" onclick="verifyParentAnswer()">确认验证</button>
                <p id="verify-error" style="color:#EF4444;text-align:center;margin-top:12px;display:none;">答案不正确，请重试~
                </p>
            </div>
        </div>
    </div>

    <!-- 家长确认任务完成弹窗 -->
    <div class="modal" id="parent-confirm-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-card); width: 90%; max-width: 340px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">

            <!-- 阶段1: 孩子提交等待 -->
            <div id="child-waiting-view" style="padding: 32px 24px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 24px; animation: bounce 2s infinite;">📱</div>
                <h3 style="font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 12px;">任务已提交</h3>
                <p style="font-size: 15px; color: var(--text-muted); line-height: 1.6; margin-bottom: 32px;">
                    太棒啦！🎉<br>请把手机交给爸爸/妈妈<br>确认你的任务完成情况哦
                </p>
                <button class="primary-btn" onclick="switchToParentCheck()"
                    style="width: 100%; padding: 14px; font-size: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
                    我是家长，开始验收
                </button>
            </div>

            <!-- 阶段2: 家长验收 -->
            <div id="parent-checking-view" style="display: none; padding: 24px;">
                <div
                    style="text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--text-main);">任务验收</h3>
                </div>

                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">任务名称</div>
                    <div id="confirm-task-title" style="font-size: 20px; font-weight: 700; color: var(--text-main);">
                        整理书房</div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <div
                        style="background: rgba(124, 58, 237, 0.1); padding: 12px; border-radius: 12px; flex: 1; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">实际用时</div>
                        <div id="confirm-task-time" style="font-size: 16px; font-weight: 700; color: var(--primary);">
                            25分钟</div>
                    </div>
                    <div
                        style="background: rgba(14, 165, 233, 0.1); padding: 12px; border-radius: 12px; flex: 1; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">奖励内容</div>
                        <div style="font-size: 16px; font-weight: 700; color: #0EA5E9;">💎 <span
                                id="confirm-task-reward">50</span></div>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">给孩子的鼓励（选填）</label>
                    <textarea id="parent-feedback" placeholder="做得真棒！继续加油！"
                        style="width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; resize: none; font-size: 14px; background: var(--bg-main); color: var(--text-main); font-family: inherit;"></textarea>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button class="secondary-btn" onclick="closeConfirmModal()"
                        style="flex: 1; padding: 12px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 12px;">暂不确认</button>
                    <button class="primary-btn" onclick="confirmTaskCompletion()"
                        style="flex: 1.5; padding: 12px; background: linear-gradient(135deg, #0EA5E9 0%, #3B82F6 100%); color: white; border: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);">确认并发放</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 计划详情弹窗 -->
    <div class="plan-detail-overlay" id="plan-detail-overlay">
        <div class="plan-detail-modal">
            <header class="plan-detail-header">
                <button class="back-btn" onclick="closePlanDetail()">←</button>
                <span class="plan-detail-title" id="plan-detail-title">📖 30天阅读计划</span>
                <button class="more-btn">⋯</button>
            </header>

            <div class="plan-detail-body">
                <!-- 进度环 -->
                <div class="progress-ring-section">
                    <div class="progress-ring">
                        <svg viewBox="0 0 100 100">
                            <circle class="ring-bg" cx="50" cy="50" r="42" />
                            <circle class="ring-fill" cx="50" cy="50" r="42" style="stroke-dashoffset: 158;" />
                        </svg>
                        <div class="ring-content">
                            <span class="ring-day" id="ring-day">Day 12</span>
                            <span class="ring-total">/ 30天</span>
                        </div>
                    </div>
                    <div class="ring-stats">
                        <div class="ring-stat">
                            <span class="ring-stat-icon">🔥</span>
                            <span class="ring-stat-value" id="ring-streak">12</span>
                            <span class="ring-stat-label">连续天数</span>
                        </div>
                        <div class="ring-stat">
                            <span class="ring-stat-icon">🌟</span>
                            <span class="ring-stat-value" id="ring-stars">95</span>
                            <span class="ring-stat-label">已获得</span>
                        </div>
                        <div class="ring-stat">
                            <span class="ring-stat-icon">💎</span>
                            <span class="ring-stat-value">10</span>
                            <span class="ring-stat-label">最终奖励</span>
                        </div>
                    </div>
                </div>

                <!-- 阶段进度 -->
                <div class="phases-section">
                    <h3 class="section-heading">📊 阶段进度</h3>
                    <div class="phase-item done">
                        <div class="phase-status">✅</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段1：入门期</div>
                            <div class="phase-days">Day 1-10</div>
                        </div>
                        <div class="phase-reward claimed">🌟+50 已领取</div>
                    </div>
                    <div class="phase-item current">
                        <div class="phase-status">🔵</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段2：成长期</div>
                            <div class="phase-days">Day 11-20</div>
                        </div>
                        <div class="phase-reward">🌟+80</div>
                    </div>
                    <div class="phase-item locked">
                        <div class="phase-status">🔒</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段3：冲刺期</div>
                            <div class="phase-days">Day 21-30</div>
                        </div>
                        <div class="phase-reward">🌟+100</div>
                    </div>
                </div>

                <!-- 本周打卡 -->
                <div class="week-section">
                    <h3 class="section-heading">📆 本周打卡</h3>
                    <div class="week-grid">
                        <div class="week-day done">
                            <span class="day-label">一</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day done">
                            <span class="day-label">二</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day done">
                            <span class="day-label">三</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day current">
                            <span class="day-label">四</span>
                            <span class="day-status">🔵</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">五</span>
                            <span class="day-status">⭕</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">六</span>
                            <span class="day-status">⭕</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">日</span>
                            <span class="day-status">⭕</span>
                        </div>
                    </div>
                    <div class="week-bonus">本周全勤额外奖励：🌟+15</div>
                </div>

                <!-- 今日任务 -->
                <div class="today-section">
                    <h3 class="section-heading">📌 今日任务</h3>
                    <div class="today-task-card">
                        <div class="today-task-icon">📕</div>
                        <div class="today-task-info">
                            <div class="today-task-name">阅读《哈利波特》第12章</div>
                            <div class="today-task-meta">⏱️ 预计30分钟 · 🌟+8</div>
                        </div>
                    </div>
                    <button class="start-today-btn" onclick="startPlanDailyTask('reading')">🚀 开始今日任务</button>
                </div>

                <!-- 操作按钮 -->
                <div class="plan-actions">
                    <button class="plan-action-btn pause" onclick="pausePlan()">⏸️ 暂停计划</button>
                    <button class="plan-action-btn adjust" onclick="adjustPlan()">✏️ 调整计划</button>
                    <button class="plan-action-btn quit" onclick="quitPlan()">🚪 放弃计划</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用信息模态框 -->
    <div class="info-modal-overlay" id="info-modal-overlay" onclick="closeInfoModal()">
        <div class="info-modal" onclick="event.stopPropagation()">
            <div class="info-modal-icon" id="info-modal-icon">🌟</div>
            <h3 class="info-modal-title" id="info-modal-title">标题</h3>
            <div class="info-modal-content" id="info-modal-content">内容</div>
            <button class="info-modal-btn" onclick="closeInfoModal()">知道了</button>
        </div>
    </div>

    <!-- 徽章详情模态框 -->
    <div class="badge-modal-overlay" id="badge-modal-overlay" onclick="closeBadgeModal()">
        <div class="badge-modal" onclick="event.stopPropagation()">
            <div class="badge-modal-icon" id="badge-modal-icon">🏅</div>
            <h3 class="badge-modal-name" id="badge-modal-name">徽章名称</h3>
            <div class="badge-modal-status" id="badge-modal-status">
                <span class="status-tag owned">已获得</span>
            </div>
            <div class="badge-modal-desc" id="badge-modal-desc">徽章描述</div>
            <div class="badge-modal-date" id="badge-modal-date">获得时间：2026-01-01</div>
            <div class="badge-modal-progress" id="badge-modal-progress" style="display:none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="badge-progress-fill"></div>
                </div>
                <span class="progress-text" id="badge-progress-text">7/30</span>
            </div>
            <button class="badge-modal-btn" onclick="closeBadgeModal()">关闭</button>
        </div>
    </div>

    <!-- 付费墙模态框 -->
    <div class="paywall-overlay" id="paywall-overlay" onclick="closePaywall()">
        <div class="paywall-modal" onclick="event.stopPropagation()">
            <!-- 顶部装饰 -->
            <div class="paywall-header">
                <div class="paywall-close" onclick="closePaywall()">×</div>
                <div class="paywall-badge">✨</div>
                <h2 class="paywall-title">星伴会员</h2>
                <p class="paywall-subtitle">解锁完整体验，陪伴孩子成长</p>
            </div>

            <!-- 特权列表 -->
            <div class="paywall-benefits">
                <div class="benefit-item">
                    <span class="benefit-icon">🔮</span>
                    <span class="benefit-text">AI规划无限次</span>
                    <span class="benefit-tag free">免费2次/天</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📋</span>
                    <span class="benefit-text">长期目标完整规划</span>
                    <span class="benefit-tag free">仅阶段1</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">🦁</span>
                    <span class="benefit-text">伙伴进化至传说期</span>
                    <span class="benefit-tag free">最高Lv.3</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">✨</span>
                    <span class="benefit-text">专属特效&装饰槽位</span>
                    <span class="benefit-tag vip">VIP专享</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📊</span>
                    <span class="benefit-text">家长AI报告无限查看</span>
                    <span class="benefit-tag free">限2次</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📝</span>
                    <span class="benefit-text">家长任务无限发布</span>
                    <span class="benefit-tag free">3个/天</span>
                </div>
            </div>

            <!-- 套餐选择 -->
            <div class="paywall-plans">
                <div class="plan-card" id="plan-monthly" onclick="selectPlan('monthly')">
                    <div class="plan-badge">推荐</div>
                    <div class="plan-name">月度会员</div>
                    <div class="plan-price">
                        <span class="price-currency">¥</span>
                        <span class="price-amount">9.9</span>
                        <span class="price-unit">/月</span>
                    </div>
                    <div class="plan-desc">自动续费，可随时取消</div>
                </div>
                <div class="plan-card selected" id="plan-lifetime" onclick="selectPlan('lifetime')">
                    <div class="plan-badge hot">最划算</div>
                    <div class="plan-name">终身会员</div>
                    <div class="plan-price">
                        <span class="price-currency">¥</span>
                        <span class="price-amount">99</span>
                        <span class="price-unit">永久</span>
                    </div>
                    <div class="plan-desc">一次付费，终身使用</div>
                    <div class="plan-save">省 ¥20/年</div>
                </div>
            </div>


            <!-- 购买按钮 -->
            <button class="paywall-buy-btn" onclick="startPayment()">
                <span id="buy-btn-text">立即开通 ¥99</span>
            </button>
            <p class="paywall-terms">点击即同意《用户协议》和《隐私政策》</p>
        </div>
    </div>

    <!-- 验证模态框（防止儿童误购） -->
    <div class="verify-overlay" id="verify-overlay">
        <div class="verify-modal">
            <div class="verify-title">👨‍👩‍👧 家长验证</div>
            <p class="verify-desc">为防止儿童误操作，请回答以下问题：</p>
            <div class="verify-question" id="verify-question">12 × 7 + 15 = ?</div>
            <input type="number" class="verify-input" id="verify-input" placeholder="请输入答案">
            <div class="verify-buttons">
                <button class="verify-btn cancel" onclick="closeVerify()">取消</button>
                <button class="verify-btn confirm" onclick="checkVerifyAnswer()">确认</button>
            </div>
            <p class="verify-error" id="verify-error" style="display:none;">答案不正确，请重试</p>
        </div>
    </div>

    <!-- 支付成功模态框 -->
    <div class="payment-success-overlay" id="payment-success-overlay">
        <div class="payment-success-modal">
            <div class="success-icon">🎉</div>
            <h3 class="success-title">开通成功！</h3>
            <p class="success-desc">恭喜你成为星伴会员</p>
            <div class="success-benefits">
                <div>✓ 已解锁全部VIP特权</div>
                <div>✓ 酷奇可以进化到传说期了</div>
                <div>✓ 现在就去体验完整功能吧！</div>
            </div>
            <button class="success-btn" onclick="closePaymentSuccess()">开始探索</button>
        </div>
    </div>

    <!-- 顶部菜单 -->
    <div class="header-menu-overlay" id="header-menu-overlay" onclick="closeHeaderMenu()">
        <div class="header-menu" onclick="event.stopPropagation()">
            <div class="menu-header">
                <span>设置</span>
                <button class="menu-close" onclick="closeHeaderMenu()">×</button>
            </div>
            <div class="menu-options">
                <div class="menu-option" onclick="switchChild()">
                    <span class="option-icon">👦</span>
                    <span class="option-text">切换孩子</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showNotifySettings()">
                    <span class="option-icon">🔔</span>
                    <span class="option-text">通知设置</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showSoundSettings()">
                    <span class="option-icon">🔊</span>
                    <span class="option-text">音效设置</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showAbout()">
                    <span class="option-icon">ℹ️</span>
                    <span class="option-text">关于星伴</span>
                    <span class="option-arrow">›</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 星星详情弹窗 -->
    <div class="currency-detail-overlay" id="star-detail-overlay" onclick="closeStarDetail()">
        <div class="currency-detail-modal" onclick="event.stopPropagation()">
            <div class="currency-header star">
                <span class="currency-icon">🌟</span>
                <span class="currency-name">星星币</span>
            </div>
            <div class="currency-balance">
                <span class="balance-label">当前余额</span>
                <span class="balance-amount" id="star-balance">128</span>
            </div>
            <div class="currency-history">
                <div class="history-title">最近获得</div>
                <div class="history-item">
                    <span class="history-desc">完成"整理书桌"</span>
                    <span class="history-amount">+15 🌟</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"阅读20分钟"</span>
                    <span class="history-amount">+10 🌟</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">连续签到奖励</span>
                    <span class="history-amount">+20 🌟</span>
                </div>
            </div>
            <div class="currency-tip">完成任务获得星星，可在商城兑换装扮！</div>
            <button class="currency-btn" onclick="goToShop();closeStarDetail()">去商城逛逛</button>
        </div>
    </div>

    <!-- 心愿币详情弹窗 -->
    <div class="currency-detail-overlay" id="diamond-detail-overlay" onclick="closeDiamondDetail()">
        <div class="currency-detail-modal" onclick="event.stopPropagation()">
            <div class="currency-header diamond">
                <span class="currency-icon">💎</span>
                <span class="currency-name">心愿币</span>
            </div>
            <div class="currency-balance">
                <span class="balance-label">当前余额</span>
                <span class="balance-amount diamond" id="diamond-balance">45</span>
            </div>
            <div class="currency-history">
                <div class="history-title">最近获得</div>
                <div class="history-item">
                    <span class="history-desc">完成"洗碗"(家长任务)</span>
                    <span class="history-amount">+10 💎</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"扫地"(家长任务)</span>
                    <span class="history-amount">+15 💎</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"遛狗"(家长任务)</span>
                    <span class="history-amount">+20 💎</span>
                </div>
            </div>
            <div class="currency-tip">完成家长任务获得心愿币，可兑换心愿奖励！</div>
            <button class="currency-btn diamond" onclick="goToWish();closeDiamondDetail()">查看心愿商城</button>
        </div>
    </div>

    <!-- 全部徽章页面 -->
    <div class="all-badges-overlay" id="all-badges-overlay">
        <div class="all-badges-page">
            <div class="all-badges-header">
                <button class="back-btn" onclick="closeAllBadges()">←</button>
                <h2>🏅 全部徽章</h2>
                <span class="badges-progress">6/24</span>
            </div>
            <div class="all-badges-content">
                <!-- 成就类 -->
                <div class="badge-category">
                    <div class="category-title">🌟 成就徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('star100')">
                            <div class="full-badge-icon">⭐</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">首个100星</span>
                                <span class="full-badge-desc">累计获得100颗星星</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('star500')">
                            <div class="full-badge-icon">🌟</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">星星收藏家</span>
                                <span class="full-badge-desc">累计获得500颗星星</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:26%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('star1000')">
                            <div class="full-badge-icon">💫</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">星星大师</span>
                                <span class="full-badge-desc">累计获得1000颗星星</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:13%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                    </div>
                </div>
                <!-- 坚持类 -->
                <div class="badge-category">
                    <div class="category-title">🔥 坚持徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('streak7')">
                            <div class="full-badge-icon">🔥</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">7天连续</span>
                                <span class="full-badge-desc">连续7天完成每日任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('streak30')">
                            <div class="full-badge-icon">🏆</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">30天连续</span>
                                <span class="full-badge-desc">连续30天完成每日任务</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:23%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('earlybird')">
                            <div class="full-badge-icon">🌅</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">早起鸟</span>
                                <span class="full-badge-desc">连续7天在8点前开始任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                    </div>
                </div>
                <!-- 技能类 -->
                <div class="badge-category">
                    <div class="category-title">📚 技能徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('bookworm')">
                            <div class="full-badge-icon">📚</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">书虫</span>
                                <span class="full-badge-desc">累计阅读时长达到10小时</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('readmaster')">
                            <div class="full-badge-icon">📖</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">阅读大师</span>
                                <span class="full-badge-desc">累计阅读时长达到100小时</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:12%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('organizer')">
                            <div class="full-badge-icon">🏠</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">整理达人</span>
                                <span class="full-badge-desc">完成10次整理房间任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('firstplan')">
                            <div class="full-badge-icon">🎯</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">首个计划</span>
                                <span class="full-badge-desc">创建第一个长期计划</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 徽章详情模态框 */
        .badge-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2100;
        }

        .badge-modal-overlay.active {
            display: flex;
        }

        .badge-modal {
            background: white;
            border-radius: 24px;
            padding: 32px 28px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: badgePopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes badgePopIn {
            0% {
                transform: scale(0.5) rotate(-10deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .badge-modal-icon {
            font-size: 72px;
            margin-bottom: 12px;
            animation: badgeShine 2s ease-in-out infinite;
        }

        @keyframes badgeShine {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
            }
        }

        .badge-modal-name {
            font-size: 22px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .badge-modal-status {
            margin-bottom: 12px;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-tag.owned {
            background: linear-gradient(135deg, #10B981, #34D399);
            color: white;
        }

        .status-tag.locked {
            background: rgba(107, 114, 128, 0.2);
            color: #6B7280;
        }

        .badge-modal-desc {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 8px;
        }

        .badge-modal-date {
            font-size: 12px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .badge-modal-progress {
            margin-bottom: 16px;
        }

        .badge-modal-progress .progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .badge-modal-progress .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .badge-modal-progress .progress-text {
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
        }

        .badge-modal-btn {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 查看全部按钮 */
        .view-all-badges {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            float: right;
        }

        /* 全部徽章页面 */
        .all-badges-overlay {
            position: fixed;
            inset: 0;
            /* 使用不透明的渐变背景完全覆盖底层 */
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .all-badges-overlay.active {
            display: flex;
        }

        .all-badges-page {
            max-width: 420px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .all-badges-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .all-badges-header h2 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
        }

        .all-badges-header .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .badges-progress {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .all-badges-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .badge-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .category-badges {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .full-badge-item {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .full-badge-item:hover {
            transform: translateX(4px);
        }

        .full-badge-item.locked {
            opacity: 0.7;
        }

        .full-badge-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .full-badge-info {
            flex: 1;
        }

        .full-badge-name {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .full-badge-desc {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .mini-progress {
            height: 4px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .mini-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 2px;
        }

        .badge-check {
            color: #10B981;
            font-size: 18px;
            font-weight: bold;
        }

        .badge-lock {
            font-size: 16px;
        }

        /* ===== 付费墙模块样式 ===== */
        .paywall-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .paywall-overlay.active {
            display: flex;
        }

        .paywall-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border-radius: 24px;
            max-width: 380px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: paywallSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes paywallSlideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .paywall-header {
            text-align: center;
            padding: 28px 20px 20px;
            background: linear-gradient(180deg, rgba(124, 58, 237, 0.3) 0%, transparent 100%);
            position: relative;
        }

        .paywall-close {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .paywall-badge {
            font-size: 48px;
            margin-bottom: 8px;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.1);
                filter: brightness(1.3) drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
            }
        }

        .paywall-title {
            font-size: 26px;
            font-weight: 700;
            margin: 0 0 6px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .paywall-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        /* 特权列表 */
        .paywall-benefits {
            padding: 16px 20px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .benefit-item:last-child {
            border-bottom: none;
        }

        .benefit-icon {
            font-size: 20px;
        }

        .benefit-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .benefit-tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .benefit-tag.free {
            background: rgba(107, 114, 128, 0.3);
            color: rgba(255, 255, 255, 0.6);
        }

        .benefit-tag.vip {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            font-weight: 600;
        }

        /* 套餐卡片 */
        .paywall-plans {
            display: flex;
            gap: 12px;
            padding: 0 20px 16px;
        }

        .plan-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .plan-card:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .plan-card.selected {
            border-color: #FFD700;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 165, 0, 0.1) 100%);
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(124, 58, 237, 0.8);
            color: white;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .plan-badge.hot {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        }

        .plan-name {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            margin-top: 6px;
        }

        .plan-price {
            margin-bottom: 6px;
        }

        .price-currency {
            font-size: 16px;
            vertical-align: top;
        }

        .price-amount {
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
        }

        .price-unit {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .plan-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .plan-save {
            margin-top: 6px;
            font-size: 11px;
            color: #34D399;
            font-weight: 600;
        }

        /* 购买按钮 */
        .paywall-buy-btn {
            display: block;
            width: calc(100% - 40px);
            margin: 8px 20px 12px;
            padding: 16px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
        }

        .paywall-buy-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.5);
        }

        .paywall-terms {
            text-align: center;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin: 0 0 16px;
        }

        /* 验证弹窗 */
        .verify-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3100;
        }

        .verify-overlay.active {
            display: flex;
        }

        .verify-modal {
            background: white;
            border-radius: 20px;
            padding: 28px;
            max-width: 320px;
            width: 90%;
            text-align: center;
        }

        .verify-title {
            font-size: 20px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .verify-desc {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 16px;
        }

        .verify-question {
            font-size: 24px;
            font-weight: 700;
            color: #7C3AED;
            padding: 16px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .verify-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 16px;
            box-sizing: border-box;
        }

        .verify-input:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .verify-buttons {
            display: flex;
            gap: 12px;
        }

        .verify-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .verify-btn.cancel {
            background: #F3F4F6;
            color: #6B7280;
        }

        .verify-btn.confirm {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
        }

        .verify-error {
            color: #EF4444;
            font-size: 13px;
            margin-top: 12px;
        }

        /* 支付成功 */
        .payment-success-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3200;
        }

        .payment-success-overlay.active {
            display: flex;
        }

        .payment-success-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: successPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes successPop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon {
            font-size: 72px;
            animation: celebrate 1s ease-in-out infinite;
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.1) rotate(-5deg);
            }

            75% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            margin: 12px 0 8px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .success-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }

        .success-benefits {
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .success-benefits div {
            font-size: 13px;
            color: #34D399;
            margin: 6px 0;
        }

        .success-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        /* ===== 顶部菜单样式 ===== */
        .header-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-start;
            justify-content: flex-end;
            z-index: 2500;
            padding: 60px 16px 0;
        }

        .header-menu-overlay.active {
            display: flex;
        }

        .header-menu {
            background: white;
            border-radius: 16px;
            width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: menuSlide 0.2s ease-out;
            overflow: hidden;
        }

        @keyframes menuSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-menu .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #F3F4F6;
            font-weight: 600;
            color: #1F2937;
        }

        .header-menu .menu-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #9CA3AF;
            cursor: pointer;
        }

        .menu-options {
            padding: 8px 0;
        }

        .menu-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-option:hover {
            background: #F9FAFB;
        }

        .option-icon {
            font-size: 18px;
            margin-right: 12px;
        }

        .option-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .option-arrow {
            color: #9CA3AF;
            font-size: 16px;
        }

        /* ===== 货币详情弹窗 ===== */
        .currency-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2600;
        }

        .currency-detail-overlay.active {
            display: flex;
        }

        .currency-detail-modal {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 320px;
            padding: 24px;
            animation: slideUp 0.3s ease-out;
        }

        .currency-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .currency-header.star {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
        }

        .currency-header.diamond {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(124, 58, 237, 0.1));
        }

        .currency-icon {
            font-size: 32px;
        }

        .currency-name {
            font-size: 20px;
            font-weight: 700;
            color: #1F2937;
        }

        .currency-balance {
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            display: block;
            font-size: 13px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .balance-amount {
            font-size: 42px;
            font-weight: 700;
            color: #F59E0B;
        }

        .balance-amount.diamond {
            color: #7C3AED;
        }

        .currency-history {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .history-title {
            font-size: 13px;
            font-weight: 600;
            color: #6B7280;
            margin-bottom: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-desc {
            font-size: 13px;
            color: #374151;
        }

        .history-amount {
            font-size: 13px;
            font-weight: 600;
            color: #10B981;
        }

        .currency-tip {
            text-align: center;
            font-size: 12px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .currency-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        .currency-btn.diamond {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
        }

        /* 头部stat可点击样式 */
        .header-stats .stat {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .header-stats .stat:hover {
            transform: scale(1.05);
        }

        .user-section {
            cursor: pointer;
        }
    </style>


    <style>
        .info-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease-out;
        }

        .info-modal-overlay.active {
            display: flex;
        }

        .info-modal {
            background: white;
            border-radius: 24px;
            padding: 28px 24px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        .info-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .info-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 12px;
        }

        .info-modal-content {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        .info-modal-btn {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
    </style>

    <script>
        // ===== 通用信息模态框 =====
        function showInfoModal(icon, title, content) {
            document.getElementById('info-modal-icon').textContent = icon;
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-content').textContent = content;
            document.getElementById('info-modal-overlay').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('info-modal-overlay').classList.remove('active');
        }

        // ===== 全局状态管理 =====
        let currentStep = 0;
        let totalStars = 128;
        let isExpanded = false;

        // ===== V2.0 时间追踪系统 =====

        // 计时器状态
        let timerState = {
            isRunning: false,
            startTime: null,
            pausedTime: 0,
            intervalId: null
        };

        // 用户时间画像（模拟个性化数据）
        const userTimeProfile = {
            childId: 'child-001',
            name: '小星星',
            age: 9,
            // 各类型任务的效率系数（历史数据统计）
            efficiency: {
                '作业': { coefficient: 0.85, samples: 23, avgActual: 38 },  // 做作业比较慢
                '阅读': { coefficient: 1.15, samples: 15, avgActual: 26 },  // 阅读比较快
                '运动': { coefficient: 1.0, samples: 8, avgActual: 20 },
                '整理': { coefficient: 0.75, samples: 12, avgActual: 33 },  // 整理比较慢
                '练琴': { coefficient: 0.90, samples: 6, avgActual: 33 },
                'default': { coefficient: 1.0, samples: 0, avgActual: 0 }
            },
            // 时间段效率
            timeOfDay: {
                morning: 0.9,    // 早上效率较低
                afternoon: 1.0,
                evening: 1.1    // 晚上效率较高
            },
            // 历史任务记录
            history: [
                { type: '作业', estimated: 37, actual: 42, date: '2026-01-10' },
                { type: '阅读', estimated: 30, actual: 25, date: '2026-01-10' },
                { type: '整理', estimated: 25, actual: 32, date: '2026-01-09' },
                { type: '作业', estimated: 40, actual: 45, date: '2026-01-09' },
                { type: '运动', estimated: 20, actual: 18, date: '2026-01-08' }
            ]
        };

        // 当前任务的时间追踪数据
        let timeTracking = {
            taskStartTime: null,
            steps: [],  // { stepIndex, estimatedSeconds, actualSeconds, startTime, endTime }
            totalEstimated: 0,
            totalActual: 0
        };

        // 当前活跃的任务计划（统一数据结构 - V2.0增强版）
        let currentTask = {
            title: '',           // 任务标题
            source: 'self',      // 来源：'self' 自主 | 'parent' 家长
            from: null,          // 来自谁（家长名称）
            deadline: null,      // 截止时间
            steps: [],           // 步骤列表（含时间预估）
            bonus: 0,            // 完成奖励
            estimatedTime: 0,    // 预计时间（分钟）
            taskType: 'default', // 任务类型（用于个性化）
            isTimeAdjusted: false // 是否已手动调整时间
        };

        // 任务模板库 - 根据任务类型生成对应步骤（V2.0 增加每步预估时间）
        const taskTemplates = {
            '整理房间': {
                steps: [
                    { icon: '🛏️', name: '铺好床铺', desc: '把被子叠整齐，枕头放好~', reward: 5, estimatedMinutes: 5 },
                    { icon: '📚', name: '整理书桌', desc: '把书本文具摆放整齐', reward: 8, estimatedMinutes: 8 },
                    { icon: '🧸', name: '收拾玩具', desc: '把玩具都放回原位', reward: 7, estimatedMinutes: 7 },
                    { icon: '✨', name: '最后检查', desc: '检查一遍，确保都整理好了', reward: 5, estimatedMinutes: 3 }
                ],
                bonus: 10,
                estimatedTime: 23,
                taskType: '整理'
            },
            '写作业': {
                steps: [
                    { icon: '📚', name: '准备学习环境', desc: '整理桌面，准备文具', reward: 3, estimatedMinutes: 2 },
                    { icon: '📝', name: '语文作业', desc: '完成语文练习', reward: 8, estimatedMinutes: 12 },
                    { icon: '🔢', name: '数学作业', desc: '完成数学习题', reward: 10, estimatedMinutes: 15 },
                    { icon: '🔤', name: '英语作业', desc: '背单词或做练习', reward: 7, estimatedMinutes: 10 },
                    { icon: '✅', name: '检查整理', desc: '检查作业，整理书包', reward: 4, estimatedMinutes: 5 }
                ],
                bonus: 8,
                estimatedTime: 44,
                taskType: '作业'
            },
            '阅读': {
                steps: [
                    { icon: '📖', name: '选择阅读地点', desc: '找个安静舒适的地方', reward: 2, estimatedMinutes: 2 },
                    { icon: '⏱️', name: '设置计时', desc: '设置25-30分钟计时器', reward: 2, estimatedMinutes: 1 },
                    { icon: '📕', name: '专注阅读', desc: '沉浸在书的世界里', reward: 12, estimatedMinutes: 20 },
                    { icon: '✍️', name: '记录感想', desc: '写下喜欢的句子或感想', reward: 4, estimatedMinutes: 7 }
                ],
                bonus: 5,
                estimatedTime: 30,
                taskType: '阅读'
            },
            '运动': {
                steps: [
                    { icon: '🏃', name: '热身准备', desc: '做几个热身动作', reward: 3, estimatedMinutes: 3 },
                    { icon: '💪', name: '开始运动', desc: '认真完成运动', reward: 15, estimatedMinutes: 12 },
                    { icon: '🧘', name: '放松拉伸', desc: '做放松和拉伸动作', reward: 4, estimatedMinutes: 3 },
                    { icon: '💧', name: '补充水分', desc: '喝水休息一下', reward: 2, estimatedMinutes: 2 }
                ],
                bonus: 6,
                estimatedTime: 20,
                taskType: '运动'
            },
            '完成作业': {
                steps: [
                    { icon: '📚', name: '语文作业', desc: '完成语文练习册', reward: 8, estimatedMinutes: 12 },
                    { icon: '🔢', name: '数学作业', desc: '完成数学习题', reward: 10, estimatedMinutes: 15 },
                    { icon: '🔤', name: '英语作业', desc: '背单词或做练习', reward: 7, estimatedMinutes: 10 }
                ],
                bonus: 5,
                estimatedTime: 37,
                taskType: '作业'
            },
            '练琴': {
                steps: [
                    { icon: '🎹', name: '热身练习', desc: '练习基础音阶', reward: 4, estimatedMinutes: 5 },
                    { icon: '🎵', name: '练习曲目', desc: '练习老师布置的曲子', reward: 12, estimatedMinutes: 15 },
                    { icon: '🎶', name: '复习旧曲', desc: '复习之前学过的曲子', reward: 6, estimatedMinutes: 10 }
                ],
                bonus: 8,
                estimatedTime: 30,
                taskType: '练琴'
            },
            'default': {
                steps: [
                    { icon: '📋', name: '准备开始', desc: '准备好需要的东西', reward: 3, estimatedMinutes: 3 },
                    { icon: '⚡', name: '开始执行', desc: '认真完成任务', reward: 12, estimatedMinutes: 10 },
                    { icon: '✅', name: '完成检查', desc: '检查是否都做好了', reward: 5, estimatedMinutes: 5 }
                ],
                bonus: 5,
                estimatedTime: 18,
                taskType: 'default'
            }
        };

        // ===== V2.0 时间追踪核心函数 =====

        // 获取当前时间段
        function getCurrentTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 18) return 'afternoon';
            return 'evening';
        }

        // 获取任务类型
        function getTaskType(title) {
            if (title.includes('作业') || title.includes('写') || title.includes('学习')) return '作业';
            if (title.includes('阅读') || title.includes('读')) return '阅读';
            if (title.includes('运动') || title.includes('锻炼') || title.includes('跑')) return '运动';
            if (title.includes('整理') || title.includes('打扫') || title.includes('收拾')) return '整理';
            if (title.includes('琴') || title.includes('钢琴')) return '练琴';
            return 'default';
        }

        // 计算个性化时间预估
        function calculatePersonalizedTime(baseMinutes, taskType) {
            const profile = userTimeProfile.efficiency[taskType] || userTimeProfile.efficiency.default;
            const timeOfDayFactor = userTimeProfile.timeOfDay[getCurrentTimeOfDay()] || 1.0;

            // 如果有历史数据，使用效率系数调整
            if (profile.samples > 0) {
                const adjustedTime = Math.round(baseMinutes / profile.coefficient / timeOfDayFactor);
                return {
                    time: adjustedTime,
                    isPersonalized: true,
                    efficiency: profile.coefficient,
                    samples: profile.samples,
                    comparison: adjustedTime > baseMinutes ? 'slower' : (adjustedTime < baseMinutes ? 'faster' : 'normal')
                };
            }

            return {
                time: baseMinutes,
                isPersonalized: false,
                efficiency: 1.0,
                samples: 0,
                comparison: 'normal'
            };
        }

        // 格式化时间显示
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 格式化分钟显示
        function formatMinutes(minutes) {
            if (minutes < 60) return `${minutes}分钟`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}小时${mins}分钟` : `${hours}小时`;
        }

        // 启动计时器
        function startTimer() {
            if (timerState.isRunning) return;

            timerState.isRunning = true;
            timerState.startTime = Date.now() - timerState.pausedTime;

            timerState.intervalId = setInterval(() => {
                const elapsed = Math.floor((Date.now() - timerState.startTime) / 1000);
                updateTimerDisplay(elapsed);
            }, 1000);

            // 记录步骤开始时间
            if (!timeTracking.steps[currentStep]) {
                timeTracking.steps[currentStep] = {
                    stepIndex: currentStep,
                    estimatedSeconds: (currentTask.steps[currentStep]?.estimatedMinutes || 5) * 60,
                    actualSeconds: 0,
                    startTime: new Date().toISOString(),
                    endTime: null
                };
            }

            console.log(`[时间追踪] 步骤${currentStep + 1}计时开始`);
        }

        // 暂停计时器
        function pauseTimer() {
            if (!timerState.isRunning) return;

            timerState.isRunning = false;
            timerState.pausedTime = Date.now() - timerState.startTime;
            clearInterval(timerState.intervalId);

            console.log(`[时间追踪] 步骤${currentStep + 1}计时暂停，已用时：${formatTime(Math.floor(timerState.pausedTime / 1000))}`);
        }

        // 停止计时器并记录
        function stopTimer() {
            if (timerState.intervalId) {
                clearInterval(timerState.intervalId);
            }

            const elapsed = timerState.isRunning ?
                Math.floor((Date.now() - timerState.startTime) / 1000) :
                Math.floor(timerState.pausedTime / 1000);

            // 记录实际用时
            if (timeTracking.steps[currentStep]) {
                timeTracking.steps[currentStep].actualSeconds = elapsed;
                timeTracking.steps[currentStep].endTime = new Date().toISOString();
            }

            // 重置计时器状态
            timerState.isRunning = false;
            timerState.startTime = null;
            timerState.pausedTime = 0;
            timerState.intervalId = null;

            console.log(`[时间追踪] 步骤${currentStep + 1}完成，用时：${formatTime(elapsed)}`);

            return elapsed;
        }

        // 更新计时器显示
        function updateTimerDisplay(seconds) {
            const timerEl = document.getElementById('exec-timer');
            if (timerEl) {
                timerEl.textContent = formatTime(seconds);

                // 检查是否超时
                const estimated = timeTracking.steps[currentStep]?.estimatedSeconds || 300;
                if (seconds > estimated) {
                    timerEl.classList.add('overtime');
                } else if (seconds > estimated * 0.8) {
                    timerEl.classList.add('warning');
                } else {
                    timerEl.classList.remove('overtime', 'warning');
                }
            }
        }

        // 计算任务总时间统计
        function calculateTimeStats() {
            const totalEstimated = timeTracking.steps.reduce((sum, s) => sum + (s.estimatedSeconds || 0), 0);
            const totalActual = timeTracking.steps.reduce((sum, s) => sum + (s.actualSeconds || 0), 0);

            return {
                totalEstimated,
                totalActual,
                difference: totalActual - totalEstimated,
                efficiency: totalEstimated > 0 ? (totalEstimated / totalActual).toFixed(2) : 1,
                isFaster: totalActual < totalEstimated,
                savedOrExceeded: Math.abs(totalActual - totalEstimated)
            };
        }

        // 生成时间对比报告
        function generateTimeReport() {
            const stats = calculateTimeStats();
            const steps = timeTracking.steps.map((s, i) => ({
                name: currentTask.steps[i]?.name || `步骤${i + 1}`,
                estimated: formatTime(s.estimatedSeconds),
                actual: formatTime(s.actualSeconds),
                diff: s.actualSeconds - s.estimatedSeconds,
                isFaster: s.actualSeconds < s.estimatedSeconds
            }));

            return {
                taskTitle: currentTask.title,
                taskType: currentTask.taskType,
                stats,
                steps,
                completedAt: new Date().toISOString()
            };
        }

        // 家长待发布的任务队列（模拟推送）
        const parentTaskQueue = [
            {
                id: 'homework-1',
                title: '完成今天的作业',
                from: '妈妈',
                deadline: '20:00',
                suggestedReward: 25,
                priority: 'high'
            },
            {
                id: 'piano-1',
                title: '练琴30分钟',
                from: '爸爸',
                deadline: null,
                suggestedReward: 20,
                priority: 'normal'
            }
        ];

        // 兼容旧代码的 taskPlan 引用
        const taskPlan = {
            get title() { return currentTask.title; },
            set title(val) { currentTask.title = val; },
            get steps() { return currentTask.steps; },
            set steps(val) { currentTask.steps = val; },
            get bonus() { return currentTask.bonus; },
            set bonus(val) { currentTask.bonus = val; }
        };

        // 伙伴交互 - 点击伙伴
        function interactPartner() {
            const expressions = ['✨', '💫', '⭐', '💕', '🎵', '😊'];
            const exprEl = document.getElementById('partner-expr');
            exprEl.textContent = expressions[Math.floor(Math.random() * expressions.length)];

            // 更换对话
            const greetings = [
                '嗨~点我干嘛呀？嘻嘻~',
                '想完成什么任务呢？告诉我吧！',
                '今天一起加油吧！💪',
                '有什么想做的目标吗？',
                '最近你越来越厉害了！✨'
            ];
            document.getElementById('partner-message').textContent = greetings[Math.floor(Math.random() * greetings.length)];

            // 清除表情
            setTimeout(() => {
                exprEl.textContent = '';
            }, 1500);
        }

        // 切换页面
        function switchPage(pageId) {
            // 如果从对话页切换出去，恢复首页状态
            if (isExpanded) {
                resetHomePage();
            }

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        // 恢复首页状态
        function resetHomePage() {
            isExpanded = false;
            currentTask.source = 'self';
            currentTask.from = null;
            document.querySelector('.partner-stage').classList.remove('hidden');
            document.querySelector('.partner-dialog').classList.remove('hidden');
            document.querySelector('.quick-section').classList.remove('hidden');
            document.querySelector('.today-tasks-preview').classList.remove('hidden');
            document.getElementById('chat-expand-area').classList.add('hidden');
            document.getElementById('chat-expand-area').innerHTML = '';
            document.getElementById('quick-tags').classList.remove('hidden');
            document.getElementById('partner-message').textContent = '嗨~小星星！今天想完成什么目标呀？告诉我，我来帮你规划！✨';
        }

        // ===== 统一任务处理层 =====

        // 展开首页对话区域
        function expandHomePage() {
            isExpanded = true;
            document.querySelector('.partner-stage').classList.add('hidden');
            document.querySelector('.partner-dialog').classList.add('hidden');
            document.querySelector('.quick-section').classList.add('hidden');
            document.querySelector('.today-tasks-preview').classList.add('hidden');
            document.getElementById('quick-tags').classList.add('hidden');

            const chatArea = document.getElementById('chat-expand-area');
            chatArea.classList.remove('hidden');
            chatArea.innerHTML = '';
            return chatArea;
        }

        // 根据任务标题匹配模板生成任务计划
        function generateTaskFromTemplate(title, options = {}) {
            const { source = 'self', from = null, deadline = null, suggestedReward = null } = options;

            // 智能匹配任务模板
            let template = taskTemplates.default;
            const templateKeys = Object.keys(taskTemplates);

            for (const key of templateKeys) {
                if (key !== 'default' && title.includes(key)) {
                    template = taskTemplates[key];
                    break;
                }
            }

            // 更新当前任务
            currentTask.title = title;
            currentTask.source = source;
            currentTask.from = from;
            currentTask.deadline = deadline;
            currentTask.steps = JSON.parse(JSON.stringify(template.steps)); // 深拷贝
            currentTask.bonus = suggestedReward || template.bonus;
            currentTask.estimatedTime = template.estimatedTime;

            return currentTask;
        }

        // 统一的任务处理入口
        function processTask(taskInfo) {
            const { title, source = 'self', from = null, deadline = null, suggestedReward = null } = taskInfo;

            // 确保在首页
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-home').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');

            // 生成任务计划
            generateTaskFromTemplate(title, { source, from, deadline, suggestedReward });

            // 展开对话区域
            const chatArea = expandHomePage();

            // 根据来源显示不同的开场
            if (source === 'parent') {
                // 家长任务的开场
                chatArea.innerHTML = `
                    <div class="message partner">
                        <img src="assets/partner_kuqi.png" class="msg-avatar">
                        <div class="msg-bubble">📩 ${from}给你安排了一个任务哦~<br><br>「${title}」${deadline ? `<br>⏰ ${deadline}前完成` : ''}<br><br>要我帮你规划一下吗？</div>
                    </div>
                `;
            } else {
                // 自主任务的开场
                chatArea.innerHTML = `
                    <div class="message user">
                        <div class="msg-bubble">${title}</div>
                    </div>
                    <div class="message partner">
                        <img src="assets/partner_kuqi.png" class="msg-avatar">
                        <div class="msg-bubble">${title}！太棒了！🌟<br>让我帮你想想怎么做...</div>
                    </div>
                `;
            }
            chatArea.scrollTop = chatArea.scrollHeight;

            // 显示思考动画
            setTimeout(() => {
                chatArea.innerHTML += `
                    <div class="thinking-indicator">
                        <img src="assets/partner_kuqi.png" alt="" style="width:40px;height:40px;object-fit:contain;animation:float 2s ease-in-out infinite;">
                        <div class="thinking-dots"><span></span><span></span><span></span></div>
                    </div>
                `;
                chatArea.scrollTop = chatArea.scrollHeight;

                // 显示任务拆解结果
                setTimeout(() => {
                    showTaskPlanResult(chatArea);
                }, 1500);
            }, 800);
        }

        // 显示任务拆解结果（统一渲染）
        function showTaskPlanResult(chatArea) {
            // 移除思考动画
            const thinking = chatArea.querySelector('.thinking-indicator');
            if (thinking) thinking.remove();

            // 构建任务计划卡片
            const isParentTask = currentTask.source === 'parent';
            const stepCount = currentTask.steps.length;

            // 家长任务vs孩子目标的差异化文案
            const rewardText = isParentTask ?
                '完成全部步骤后获得心愿币~ 💎' :
                '每完成一步就能获得星星~ ⭐';

            chatArea.innerHTML += `
                <div class="message partner">
                    <img src="assets/partner_kuqi.png" class="msg-avatar">
                    <div class="msg-bubble">${isParentTask ?
                    `这是${currentTask.from}给你安排的任务！<br>` :
                    ''}我帮你把任务拆成了${stepCount}个小步骤！<br>${rewardText}</div>
                </div>
                <div class="task-plan">
                    <div class="plan-header">
                        <div class="plan-title">📋 ${currentTask.title}计划</div>
                        <div class="plan-meta">${isParentTask ? `来自：${currentTask.from} · ` : ''}预计${currentTask.estimatedTime}分钟 · ${stepCount}个步骤</div>
                    </div>
                    <div class="plan-steps">
                        ${currentTask.steps.map((s, i) => `
                            <div class="step-row">
                                <div class="step-num">${i + 1}</div>
                                <div class="step-icon">${s.icon}</div>
                                <div class="step-info">
                                    <div class="step-name">${s.name}</div>
                                    <div class="step-time">约5-8分钟</div>
                                </div>
                                <div class="step-reward">${isParentTask ? '✅' : '🌟+' + s.reward}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="plan-bonus">
                        <span class="bonus-label">${isParentTask ? `📩 ${currentTask.from}的奖励（待确认）` : '🎁 全部完成额外奖励'}</span>
                        <span class="bonus-value">${isParentTask ? '💎' : '🌟'}+${currentTask.bonus}</span>
                    </div>
                </div>
                ${isParentTask ? `
                    <div class="parent-task-note">
                        💡 这是${currentTask.from}安排的任务，完成全部步骤后TA会收到通知确认~
                    </div>
                ` : ''}
                <div class="action-btns">
                    <button class="action-btn secondary" onclick="showAdjustOptions()">我想调整</button>
                    <button class="action-btn primary" onclick="startExec()">${isParentTask ? '开始做吧！📝' : '开始挑战！🚀'}</button>
                </div>
            `;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 选择目标
        function selectGoal(goal) {
            document.getElementById('chat-input').value = goal;
            submitGoal();
        }

        // 提交目标 - 使用统一的任务处理入口
        function submitGoal() {
            const input = document.getElementById('chat-input');
            const goal = input.value.trim();
            if (!goal) return;

            input.value = '';

            // 使用统一的任务处理入口（自主任务）
            processTask({
                title: goal,
                source: 'self'
            });
        }

        // 开始执行 - V2.0 集成时间追踪
        function startExec() {
            currentStep = 0;

            // 初始化时间追踪
            timeTracking = {
                taskStartTime: new Date().toISOString(),
                steps: [],
                totalEstimated: 0,
                totalActual: 0
            };

            // 初始化每个步骤的预估时间
            currentTask.steps.forEach((step, i) => {
                const estimatedMinutes = step.estimatedMinutes || 5;
                timeTracking.steps[i] = {
                    stepIndex: i,
                    estimatedSeconds: estimatedMinutes * 60,
                    actualSeconds: 0,
                    startTime: null,
                    endTime: null
                };
            });

            updateExecUI();
            document.getElementById('exec-overlay').classList.add('active');
            document.getElementById('bottom-nav').style.display = 'none';

            // 启动计时器
            startTimer();
        }

        // 继续任务
        function continueTask() {
            currentStep = 2;
            updateExecUI();
            document.getElementById('exec-overlay').classList.add('active');
            document.getElementById('bottom-nav').style.display = 'none';
            startTimer();
        }

        // 更新执行界面 - V2.0 增强版
        function updateExecUI() {
            const step = taskPlan.steps[currentStep];
            const estimatedMinutes = step.estimatedMinutes || 5;
            const estimatedSeconds = estimatedMinutes * 60;

            document.getElementById('exec-step-num').textContent = `步骤 ${currentStep + 1} / ${taskPlan.steps.length}`;
            document.getElementById('exec-icon').textContent = step.icon;
            document.getElementById('exec-name').textContent = step.name;
            document.getElementById('exec-desc').textContent = step.desc;

            // V2.0: 更新预估时间显示
            document.getElementById('exec-estimated').textContent = formatTime(estimatedSeconds);
            document.getElementById('exec-timer').textContent = '00:00';
            document.getElementById('exec-timer-mini').textContent = '00:00';

            // 重置时间状态
            const timeStatus = document.getElementById('time-status');
            timeStatus.className = 'time-status';
            document.getElementById('time-status-text').textContent = '正在计时...';

            // 更新暂停按钮状态
            const pauseBtn = document.getElementById('exec-pause-btn');
            pauseBtn.textContent = '⏸️ 暂停';
            pauseBtn.classList.remove('paused');

            // 更新进度点
            const dots = document.querySelectorAll('.exec-progress-dot');
            dots.forEach((d, i) => {
                d.className = 'exec-progress-dot';
                if (i < currentStep) d.classList.add('done');
                if (i === currentStep) d.classList.add('current');
            });

            // 初始化当前步骤追踪
            if (timeTracking.steps[currentStep]) {
                timeTracking.steps[currentStep].startTime = new Date().toISOString();
            }
        }

        // 切换暂停/继续
        function togglePause() {
            const pauseBtn = document.getElementById('exec-pause-btn');
            const timeStatus = document.getElementById('time-status');

            if (timerState.isRunning) {
                pauseTimer();
                pauseBtn.textContent = '▶️ 继续';
                pauseBtn.classList.add('paused');
                timeStatus.classList.add('paused');
                document.getElementById('time-status-text').textContent = '已暂停';
            } else {
                startTimer();
                pauseBtn.textContent = '⏸️ 暂停';
                pauseBtn.classList.remove('paused');
                timeStatus.classList.remove('paused');
                document.getElementById('time-status-text').textContent = '正在计时...';
            }
        }

        // 完成步骤 - V2.0 集成时间追踪
        function completeStep() {
            const step = taskPlan.steps[currentStep];
            const isParentTask = currentTask && currentTask.source === 'parent';

            // V2.0: 停止计时并记录
            const actualSeconds = stopTimer();
            const estimatedSeconds = timeTracking.steps[currentStep]?.estimatedSeconds || 300;
            const timeDiff = actualSeconds - estimatedSeconds;
            const isFaster = timeDiff < 0;

            // 生成时间对比文案
            const timeCompareText = isFaster ?
                `⏱️ 比预计快了 ${formatTime(Math.abs(timeDiff))}！` :
                (timeDiff > 0 ? `⏱️ 比预计多用了 ${formatTime(timeDiff)}` : '⏱️ 刚好按时完成！');

            // 只有孩子自己的目标才发放星星币
            if (!isParentTask) {
                totalStars += step.reward;
                document.getElementById('star-count').textContent = totalStars;
                document.getElementById('cel-text').innerHTML = `你完成了「${step.name}」<br><span style="font-size:13px;color:var(--text-secondary);">${timeCompareText}</span>`;
                document.getElementById('cel-reward').textContent = `+${step.reward} 🌟`;
            } else {
                // 家长任务只显示进度，不发放星星币
                document.getElementById('cel-text').innerHTML = `✅ 完成了「${step.name}」<br><span style="font-size:13px;color:var(--text-secondary);">${timeCompareText}</span>`;
                document.getElementById('cel-reward').textContent = `${currentStep + 1}/${taskPlan.steps.length} 步骤`;
            }

            document.getElementById('cel-overlay').classList.add('active');

            if (currentStep >= taskPlan.steps.length - 1) {
                document.querySelector('.cel-btn').textContent = '🎊 完成全部！';
                document.querySelector('.cel-btn').onclick = finishAll;
            } else {
                document.querySelector('.cel-btn').textContent = '继续下一步 →';
                document.querySelector('.cel-btn').onclick = continueAfterCel;
            }

            console.log(`[时间追踪] 步骤${currentStep + 1}完成，预估${formatTime(estimatedSeconds)}，实际${formatTime(actualSeconds)}，${isFaster ? '提前' : '超时'}${formatTime(Math.abs(timeDiff))}`);
        }

        // 继续下一步 - V2.0
        function continueAfterCel() {
            document.getElementById('cel-overlay').classList.remove('active');
            currentStep++;
            if (currentStep < taskPlan.steps.length) {
                updateExecUI();
                // 重置并启动新步骤的计时器
                timerState.pausedTime = 0;
                startTimer();
            }
        }

        // 完成全部 - V2.0 增加时间报告
        function finishAll() {
            const isParentTask = currentTask.source === 'parent';
            const taskTitle = currentTask.title;
            const taskFrom = currentTask.from;

            // V2.0: 生成时间统计报告
            const timeReport = generateTimeReport();
            const stats = timeReport.stats;
            const totalEstimatedFormatted = formatTime(stats.totalEstimated);
            const totalActualFormatted = formatTime(stats.totalActual);
            const timeDiffFormatted = formatTime(stats.savedOrExceeded);
            const timeResultText = stats.isFaster ?
                `⚡ 比预计快了 ${timeDiffFormatted}！效率超棒！` :
                (stats.savedOrExceeded > 0 ? `多用了 ${timeDiffFormatted}，下次继续加油！` : '完美按时完成！');

            // 保存到历史记录
            userTimeProfile.history.unshift({
                type: currentTask.taskType,
                estimated: Math.round(stats.totalEstimated / 60),
                actual: Math.round(stats.totalActual / 60),
                date: new Date().toISOString().split('T')[0]
            });

            document.getElementById('cel-overlay').classList.remove('active');
            document.getElementById('exec-overlay').classList.remove('active');
            document.getElementById('bottom-nav').style.display = 'flex';

            if (isParentTask) {
                // 家长任务完成 - 弹出家长确认框
                const earnedWish = currentTask.bonus; // 这里假设bonus就是心愿币奖励

                // 重置主页，准备迎接好消息
                resetHomePage();

                // 准备数据给确认弹窗
                const confirmData = {
                    title: taskTitle,
                    time: totalActualFormatted, // 使用格式化的时间字符串
                    reward: earnedWish,
                    from: taskFrom,
                    timeReport: timeResultText
                };

                // 显示家长确认弹窗
                showParentConfirmModal(confirmData);

                console.log(`[时间追踪] 任务完成报告:`, timeReport);
            } else {
                // 孩子目标完成 - 发放星星币
                const earnedStars = currentTask.steps.reduce((a, s) => a + s.reward, 0) + currentTask.bonus;
                totalStars += currentTask.bonus;
                document.getElementById('star-count').textContent = totalStars;

                resetHomePage();

                document.getElementById('partner-message').innerHTML =
                    `🎊 太厉害了！「${taskTitle}」全部完成！获得了 🌟${earnedStars} 星星！<br><br>` +
                    `📊 时间统计：预计${totalEstimatedFormatted} → 实际${totalActualFormatted}<br>` +
                    `${timeResultText}`;
            }

            // 更新今日任务预览
            const previewCount = document.querySelector('.preview-count');
            previewCount.textContent = '3/5 已完成';
        }

        // 退出执行 - V2.0
        function exitExec() {
            if (confirm('确定要暂停吗？进度会保存~')) {
                pauseTimer();
                document.getElementById('exec-overlay').classList.remove('active');
                document.getElementById('bottom-nav').style.display = 'flex';
            }
        }

        // ===== 家长确认系统 =====
        let pendingConfirmData = null;

        function showParentConfirmModal(data) {
            pendingConfirmData = data;
            document.getElementById('confirm-task-title').textContent = data.title;
            document.getElementById('confirm-task-time').textContent = data.time;
            document.getElementById('confirm-task-reward').textContent = data.reward;

            // 重置视图
            document.getElementById('child-waiting-view').style.display = 'block';
            document.getElementById('parent-checking-view').style.display = 'none';
            // 清空输入框
            document.getElementById('parent-feedback').value = '';

            document.getElementById('parent-confirm-modal').style.display = 'flex';
        }

        function switchToParentCheck() {
            document.getElementById('child-waiting-view').style.display = 'none';
            document.getElementById('parent-checking-view').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('parent-confirm-modal').style.display = 'none';
            // 可以在这里提示用户"任务仍在等待确认中"，但为了演示方便暂不做处理
        }

        function confirmTaskCompletion() {
            if (!pendingConfirmData) return;

            const rewardAmount = parseInt(pendingConfirmData.reward) || 0;

            // 更新心愿币 (使用全局变量 totalDiamonds)
            if (typeof totalDiamonds !== 'undefined') {
                totalDiamonds += rewardAmount;
            } else {
                window.totalDiamonds = (window.totalDiamonds || 0) + rewardAmount;
            }

            // 尝试更新UI - 如果存在 updateRewardDisplay 函数则调用
            if (typeof updateRewardDisplay === 'function') {
                updateRewardDisplay();
            } else {
                // 降级处理：尝试查找ID为 diamonds-count 的元素 (之前看到的可能是 diamonds-count)
                // 或者直接通过其他方式更新
                // 但根据之前的代码，updateRewardDisplay 是存在的
            }

            // 从队列中移除任务 (在finishAll中已经预处理了，但为了确保逻辑闭环，如果不确认就不移除其实更好，
            // 但为了 finishAll 的逻辑简单，我们已经在 finishAll 里没有移除它。
            // 等等，之前的 replace_file_content 移除了 finishAll 里的 splice 逻辑吗？
            // 让我们检查一下 finishAll 的修改。
            // 是的，我把 splice 逻辑去掉了。所以现在必须在这里移除。

            const taskIndex = parentTaskQueue.findIndex(t => t.title === pendingConfirmData.title);
            if (taskIndex > -1) {
                parentTaskQueue.splice(taskIndex, 1);
            }

            // 反馈消息
            const feedback = document.getElementById('parent-feedback').value;
            const feedbackHtml = feedback ? `<br>📝 家长寄语：${feedback}` : '';

            document.getElementById('partner-message').innerHTML =
                `🎊 太棒了！${pendingConfirmData.from}已经确认完成！<br><br>` +
                `💎 获得 ${rewardAmount} 心愿币！余额已更新。<br>` +
                `${feedbackHtml}`;

            closeConfirmModal();
            pendingConfirmData = null;

            // 刷新任务列表显示（如果还在任务页的话，虽然现在应该是在对话页）
            if (typeof renderParentTaskList === 'function') {
                renderParentTaskList();
            }
        }

        // 显示步骤时间调整
        function showStepTimeAdjust() {
            const step = taskPlan.steps[currentStep];
            const currentEstimated = step.estimatedMinutes || 5;

            const newTime = prompt(`当前预估：${currentEstimated}分钟\n\n请输入新的预估时间（分钟）：`, currentEstimated);

            if (newTime && !isNaN(newTime) && parseInt(newTime) > 0) {
                const newMinutes = parseInt(newTime);
                step.estimatedMinutes = newMinutes;
                timeTracking.steps[currentStep].estimatedSeconds = newMinutes * 60;
                document.getElementById('exec-estimated').textContent = formatTime(newMinutes * 60);

                showInfoModal('✅', '时间已调整', `已将预估时间调整为 ${newMinutes} 分钟\n\n酷奇会记住你的反馈，下次给你更准确的预估~`);

                console.log(`[时间调整] 步骤${currentStep + 1}预估时间从${currentEstimated}分钟调整为${newMinutes}分钟`);
            }
        }

        // 开始新任务
        function startNewTask() {
            // 触发任务规划流程
            selectGoal('阅读');
        }

        // ===== 任务调整相关函数 =====

        // 显示调整选项
        function showAdjustOptions() {
            const chatArea = document.getElementById('chat-expand-area');

            // 移除之前的action按钮
            const oldBtns = chatArea.querySelector('.action-btns');
            if (oldBtns) oldBtns.remove();

            // 移除之前所有的调整相关消息，防止重复叠加
            chatArea.querySelectorAll('.adjust-message, .adjust-options, .adjust-actions, .task-plan.compact').forEach(el => el.remove());

            // 添加调整对话（用特殊class标记，方便后续清理）
            chatArea.innerHTML += `
                <div class="message partner adjust-message">
                    <img src="assets/partner_kuqi.png" class="msg-avatar">
                    <div class="msg-bubble">没问题！你想怎么调整呢？🤔</div>
                </div>
                <div class="adjust-options">
                    <button class="adjust-option" onclick="adjustTask('tooHard')">😰 太难了</button>
                    <button class="adjust-option" onclick="adjustTask('tooEasy')">😊 太简单</button>
                    <button class="adjust-option" onclick="adjustTask('changeMethod')">🔄 想换方法</button>
                    <button class="adjust-option" onclick="adjustTask('cancel')">🚫 不想做了</button>
                </div>
            `;
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // 处理调整选择
        function adjustTask(type) {
            const chatArea = document.getElementById('chat-expand-area');

            // 移除选项按钮
            const options = chatArea.querySelector('.adjust-options');
            if (options) options.remove();

            const responses = {
                tooHard: {
                    userText: '太难了...',
                    aiText: '好的，我帮你把步骤简化一下~<br>原来的4步，现在变成<strong>2步</strong>怎么样？',
                    newSteps: [
                        { icon: '🛏️', name: '整理床铺', desc: '把床铺收拾整齐', reward: 8 },
                        { icon: '✨', name: '简单收拾', desc: '把最明显的地方整理一下', reward: 7 }
                    ],
                    actions: ['好的！', '还是有点难', '算了，还原']
                },
                tooEasy: {
                    userText: '太简单了！',
                    aiText: '哇！你真厉害！💪<br>那我给你加一些挑战，变成<strong>6步</strong>好不好？',
                    newSteps: [
                        { icon: '🛏️', name: '铺好床铺', desc: '叠被子、放枕头', reward: 5 },
                        { icon: '📚', name: '整理书桌', desc: '书本文具摆放整齐', reward: 6 },
                        { icon: '🧸', name: '收拾玩具', desc: '玩具放回原位', reward: 5 },
                        { icon: '👕', name: '整理衣物', desc: '叠好衣服放衣柜', reward: 6 },
                        { icon: '🧹', name: '地板清洁', desc: '扫一下地或拖地', reward: 8 },
                        { icon: '✨', name: '最终检查', desc: '确保每个角落都干净', reward: 5 }
                    ],
                    actions: ['挑战接受！', '太多了', '算了，还原']
                },
                changeMethod: {
                    userText: '想换一种方式',
                    aiText: '当然可以！你想怎么做呢？',
                    newSteps: null,
                    actions: ['按区域整理', '按类型整理', '限时挑战']
                },
                cancel: {
                    userText: '不想做了',
                    aiText: '没关系的！😊<br>如果现在不想做，可以稍后再来~<br>要不要换一个任务？',
                    newSteps: null,
                    actions: ['换个任务', '稍后再做', '还是做吧']
                }
            };

            const resp = responses[type];

            // 用户消息
            chatArea.innerHTML += `
                <div class="message user adjust-message">
                    <div class="msg-bubble">${resp.userText}</div>
                </div>
            `;

            // 构建完整的HTML字符串
            let htmlContent = `
                <div class="message partner adjust-message">
                    <img src="assets/partner_kuqi.png" class="msg-avatar">
                    <div class="msg-bubble">${resp.aiText}</div>
                </div>
            `;

            // 如果有新步骤，添加预览
            if (resp.newSteps) {
                htmlContent += `
                    <div class="task-plan compact adjust-message">
                        <div class="plan-steps">
                            ${resp.newSteps.map((s, i) => `
                                <div class="step-row">
                                    <div class="step-num">${i + 1}</div>
                                    <div class="step-icon">${s.icon}</div>
                                    <div class="step-info">
                                        <div class="step-name">${s.name}</div>
                                        <div class="step-desc" style="font-size:12px;color:#666">${s.desc}</div>
                                    </div>
                                    <div class="step-reward">🌟+${s.reward}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // 添加后续选项
            htmlContent += `
                <div class="adjust-actions adjust-message">
                    ${resp.actions.map((action, i) => `
                        <button class="adjust-action-btn ${i === 0 ? 'primary' : ''}" 
                                onclick="handleAdjustAction('${type}', ${i}, ${resp.newSteps ? 'true' : 'false'})">${action}</button>
                    `).join('')}
                </div>
            `;

            // 一次性插入所有内容
            setTimeout(() => {
                chatArea.insertAdjacentHTML('beforeend', htmlContent);
                chatArea.scrollTop = chatArea.scrollHeight;
            }, 500);
        }

        // 处理调整后的操作
        function handleAdjustAction(type, actionIndex, hasNewSteps) {
            const chatArea = document.getElementById('chat-expand-area');

            // 移除之前的选项
            const actions = chatArea.querySelector('.adjust-actions');
            if (actions) actions.remove();

            if (actionIndex === 0 && hasNewSteps) {
                // 确认使用新方案
                const simplifiedSteps = [
                    { icon: '🛏️', name: '整理床铺', desc: '把床铺收拾整齐', reward: 8 },
                    { icon: '✨', name: '简单收拾', desc: '把最明显的地方整理一下', reward: 7 }
                ];

                if (type === 'tooHard') {
                    taskPlan.steps = simplifiedSteps;
                    taskPlan.bonus = 5;
                }

                chatArea.innerHTML += `
                    <div class="message partner adjust-message">
                        <img src="assets/partner_kuqi.png" class="msg-avatar">
                        <div class="msg-bubble">太好了！新的计划已经准备好了~ 🎉<br>准备好就点开始吧！</div>
                    </div>
                    <div class="action-btns">
                        <button class="action-btn secondary" onclick="showAdjustOptions()">再调整</button>
                        <button class="action-btn primary" onclick="startExec()">开始挑战！🚀</button>
                    </div>
                `;
            } else if (actionIndex === 2 || type === 'cancel' && actionIndex === 2) {
                // 恢复原样 或 "还是做吧"
                chatArea.innerHTML += `
                    <div class="message partner adjust-message">
                        <img src="assets/partner_kuqi.png" class="msg-avatar">
                        <div class="msg-bubble">好的！保持原来的计划~ 💪<br>相信你可以完成！</div>
                    </div>
                    <div class="action-btns">
                        <button class="action-btn secondary" onclick="showAdjustOptions()">我想调整</button>
                        <button class="action-btn primary" onclick="startExec()">开始挑战！🚀</button>
                    </div>
                `;
            } else if (type === 'cancel' && actionIndex === 0) {
                // 换个任务
                resetHomePage();
                document.getElementById('partner-message').textContent = '好的~想做什么别的任务呢？告诉我吧！✨';
            } else if (type === 'cancel' && actionIndex === 1) {
                // 稍后再做
                resetHomePage();
                document.getElementById('partner-message').textContent = '没问题~想做的时候随时喊我！😊';
            } else {
                // 其他选项
                chatArea.innerHTML += `
                    <div class="message partner adjust-message">
                        <img src="assets/partner_kuqi.png" class="msg-avatar">
                        <div class="msg-bubble">好主意！让我重新规划一下...<br>（功能开发中～）</div>
                    </div>
                    <div class="action-btns">
                        <button class="action-btn secondary" onclick="resetHomePage()">返回</button>
                        <button class="action-btn primary" onclick="startExec()">用原计划开始</button>
                    </div>
                `;
            }

            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // ===== 长期计划相关函数 =====

        // 打开计划详情
        function openPlanDetail(planId) {
            const planData = {
                reading: {
                    title: '📖 30天阅读计划',
                    day: 12,
                    total: 30,
                    streak: 12,
                    stars: 95
                },
                bike: {
                    title: '🚲 15天学骑车',
                    day: 3,
                    total: 15,
                    streak: 3,
                    stars: 25
                }
            };

            const plan = planData[planId] || planData.reading;
            document.getElementById('plan-detail-title').textContent = plan.title;
            document.getElementById('ring-day').textContent = `Day ${plan.day}`;
            document.getElementById('ring-streak').textContent = plan.streak;
            document.getElementById('ring-stars').textContent = plan.stars;

            document.getElementById('plan-detail-overlay').classList.add('active');
        }

        // 关闭计划详情
        function closePlanDetail() {
            document.getElementById('plan-detail-overlay').classList.remove('active');
        }

        // 开始计划的每日任务
        function startPlanDailyTask(planId) {
            closePlanDetail();
            // 使用现有的执行模式
            const planTasks = {
                reading: {
                    steps: [
                        { icon: '📖', name: '找个安静的地方', desc: '准备好阅读环境', reward: 2 },
                        { icon: '⏱️', name: '设置计时器30分钟', desc: '保持专注', reward: 2 },
                        { icon: '📕', name: '阅读第12章', desc: '享受阅读时光', reward: 10 },
                        { icon: '✍️', name: '记录一句喜欢的话', desc: '摘抄一句话', reward: 4 }
                    ]
                },
                bike: {
                    steps: [
                        { icon: '🚲', name: '检查自行车', desc: '确保安全', reward: 2 },
                        { icon: '🦺', name: '穿戴护具', desc: '佩戴头盔和护膝', reward: 2 },
                        { icon: '⚖️', name: '练习平衡', desc: '双脚离地滑行', reward: 8 },
                        { icon: '🎉', name: '尝试骑行', desc: '慢慢踩踏板', reward: 8 }
                    ]
                }
            };

            const planTask = planTasks[planId] || planTasks.reading;
            taskPlan.steps = planTask.steps;
            taskPlan.title = planId === 'reading' ? '今日阅读' : '今日练车';
            taskPlan.bonus = 5;

            currentStep = 0;
            updateExecUI();
            document.getElementById('exec-overlay').classList.add('active');
            document.getElementById('bottom-nav').style.display = 'none';
        }

        // 暂停计划
        function pausePlan() {
            if (confirm('确定要暂停这个计划吗？\n暂停期间进度会保留，你可以随时恢复~')) {
                closePlanDetail();
                document.getElementById('partner-message').textContent =
                    '计划已暂停，想继续的时候随时告诉我哦~ 💕';
            }
        }

        // 调整计划
        function adjustPlan() {
            closePlanDetail();
            document.getElementById('partner-message').textContent =
                '想怎么调整呢？可以减少每天的任务量，或者延长计划时间~';
        }

        // 放弃计划
        function quitPlan() {
            if (confirm('真的要放弃吗？😢\n\n已获得的奖励会保留，但最终奖励就拿不到了...\n\n要不要再坚持一下？')) {
                closePlanDetail();
                document.getElementById('partner-message').textContent =
                    '没关系的，你已经很努力了！🌟95 和 "书虫" 徽章都是你的了~';
            }
        }

        // 创建新计划
        function showCreatePlanDialog() {
            // 切换到首页并引导创建
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-home').classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[0].classList.add('active');

            document.getElementById('partner-message').textContent =
                '想创建一个长期计划吗？✨\n告诉我你想在多少天内完成什么目标~\n\n比如："我想30天读完一本书"';
        }

        // ===== 奖励页相关函数 =====

        // 切换奖励Tab
        function switchRewardTab(tabId) {
            // 更新Tab样式
            document.querySelectorAll('.reward-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // 切换内容
            document.querySelectorAll('.reward-content').forEach(c => c.classList.remove('active'));
            document.getElementById('reward-' + tabId).classList.add('active');

            // 如果切换到装扮页，重置试穿状态
            if (tabId === 'dress') {
                cancelTryOn();
            }
        }

        // ===== 装扮试穿系统 =====

        // 装扮状态管理
        let dressupState = {
            trying: null,           // 当前试穿的物品
            equipped: {
                head: { id: 'ribbon', emoji: '🎀', name: '蝴蝶结' },
                back: null
            },
            currentCategory: 'head'
        };

        // 切换装扮分类
        function switchDressCategory(category) {
            dressupState.currentCategory = category;

            // 更新分类按钮
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // 显示/隐藏对应物品
            document.querySelectorAll('.dressup-item').forEach(item => {
                if (item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // 重置试穿状态
            cancelTryOn();
        }

        // 试穿物品
        function tryOnItem(itemEl) {
            const itemId = itemEl.dataset.id;
            const emoji = itemEl.dataset.emoji;
            const category = itemEl.dataset.category;
            const price = itemEl.dataset.price;
            const isOwned = itemEl.classList.contains('owned');
            const isLocked = itemEl.classList.contains('locked');
            const isEquipped = itemEl.classList.contains('equipped');
            const itemName = itemEl.querySelector('.item-name').textContent;

            // 如果已经装备，不做任何处理
            if (isEquipped) {
                return;
            }

            // 如果是锁定物品，提示需要会员
            if (isLocked) {
                showInfoModal('🔒', '需要会员', '开通星伴会员即可解锁这个装扮~');
                return;
            }

            // 清除之前的试穿状态
            document.querySelectorAll('.dressup-item.trying').forEach(el => el.classList.remove('trying'));

            // 设置试穿状态
            itemEl.classList.add('trying');
            dressupState.trying = { id: itemId, emoji, category, price, isOwned, name: itemName };

            // 更新角色预览
            updateCharacterPreview(category, emoji, true);

            // 显示操作栏
            const actionsEl = document.getElementById('dressup-actions');
            actionsEl.style.display = 'flex';

            // 更新按钮文案
            const actionText = document.getElementById('action-text');
            const actionPrice = document.getElementById('action-price');

            if (isOwned) {
                actionText.textContent = '穿上它！';
                actionPrice.textContent = '';
            } else {
                actionText.textContent = '购买并穿上';
                actionPrice.textContent = `🌟 ${price}`;
            }

            // 更新状态显示
            document.getElementById('trying-label').style.display = 'inline';
            document.getElementById('equipped-label').style.display = 'none';
        }

        // 更新角色预览
        function updateCharacterPreview(category, emoji, isTrying = false) {
            const layerId = category === 'head' ? 'layer-head' : 'layer-back';
            const layerEl = document.getElementById(layerId);

            layerEl.textContent = emoji || '';

            if (isTrying) {
                layerEl.classList.add('trying');
                setTimeout(() => layerEl.classList.remove('trying'), 500);
            }
        }

        // 取消试穿
        function cancelTryOn() {
            // 清除试穿状态
            document.querySelectorAll('.dressup-item.trying').forEach(el => el.classList.remove('trying'));
            dressupState.trying = null;

            // 隐藏操作栏
            document.getElementById('dressup-actions').style.display = 'none';

            // 恢复已装备状态
            restoreEquippedPreview();

            // 更新状态显示
            document.getElementById('trying-label').style.display = 'none';
            document.getElementById('equipped-label').style.display = 'inline';
        }

        // 恢复已装备的预览
        function restoreEquippedPreview() {
            const headEquipped = dressupState.equipped.head;
            const backEquipped = dressupState.equipped.back;

            document.getElementById('layer-head').textContent = headEquipped ? headEquipped.emoji : '';
            document.getElementById('layer-back').textContent = backEquipped ? backEquipped.emoji : '';
        }

        // 确认穿戴
        function confirmDressup() {
            if (!dressupState.trying) return;

            const { id, emoji, category, price, isOwned, name } = dressupState.trying;

            // 如果没拥有，需要先购买
            if (!isOwned) {
                const priceNum = parseInt(price);
                if (totalStars < priceNum) {
                    showInfoModal('😅', '星星不够哦', `还需要 🌟${priceNum - totalStars}\n继续完成任务赚取星星吧！`);
                    return;
                }

                // 扣除星星
                totalStars -= priceNum;
                document.getElementById('star-count').textContent = totalStars;

                // 更新物品状态为已拥有
                const itemEl = document.querySelector(`.dressup-item[data-id="${id}"]`);
                itemEl.classList.add('owned');
                const statusEl = itemEl.querySelector('.item-price');
                if (statusEl) {
                    statusEl.className = 'item-status owned';
                    statusEl.textContent = '已拥有';
                }
            }

            // 取消之前装备的物品
            const prevEquipped = dressupState.equipped[category];
            if (prevEquipped) {
                const prevItemEl = document.querySelector(`.dressup-item[data-id="${prevEquipped.id}"]`);
                if (prevItemEl) {
                    prevItemEl.classList.remove('equipped');
                    const prevStatus = prevItemEl.querySelector('.item-status');
                    if (prevStatus) {
                        prevStatus.className = 'item-status owned';
                        prevStatus.textContent = '已拥有';
                    }
                }
            }

            // 设置新装备
            dressupState.equipped[category] = { id, emoji, name };

            // 更新物品显示为已装备
            const newItemEl = document.querySelector(`.dressup-item[data-id="${id}"]`);
            newItemEl.classList.remove('trying');
            newItemEl.classList.add('equipped');
            const newStatus = newItemEl.querySelector('.item-status, .item-price');
            if (newStatus) {
                newStatus.className = 'item-status equipped';
                newStatus.textContent = '穿戴中';
            }

            // 更新装备槽位显示
            updateEquippedSlots();

            // 清除试穿状态
            dressupState.trying = null;
            document.getElementById('dressup-actions').style.display = 'none';
            document.getElementById('trying-label').style.display = 'none';
            document.getElementById('equipped-label').style.display = 'inline';

            // 显示成功提示
            showInfoModal('✨', '装扮成功', `酷奇穿上了「${name}」\n看起来真可爱！`);
        }

        // 更新装备槽位显示
        function updateEquippedSlots() {
            const headSlot = document.getElementById('slot-head');
            const backSlot = document.getElementById('slot-back');

            if (dressupState.equipped.head) {
                headSlot.classList.remove('empty');
                headSlot.querySelector('.slot-icon').textContent = dressupState.equipped.head.emoji;
                headSlot.querySelector('.slot-name').textContent = dressupState.equipped.head.name;
            } else {
                headSlot.classList.add('empty');
                headSlot.querySelector('.slot-icon').textContent = '➕';
                headSlot.querySelector('.slot-name').textContent = '头饰';
            }

            if (dressupState.equipped.back) {
                backSlot.classList.remove('empty');
                backSlot.querySelector('.slot-icon').textContent = dressupState.equipped.back.emoji;
                backSlot.querySelector('.slot-name').textContent = dressupState.equipped.back.name;
            } else {
                backSlot.classList.add('empty');
                backSlot.querySelector('.slot-icon').textContent = '➕';
                backSlot.querySelector('.slot-name').textContent = '背饰';
            }
        }

        // 移除已装备物品
        function removeEquipped(category) {
            const equipped = dressupState.equipped[category];
            if (!equipped) return;

            // 取消装备状态
            const itemEl = document.querySelector(`.dressup-item[data-id="${equipped.id}"]`);
            if (itemEl) {
                itemEl.classList.remove('equipped');
                const status = itemEl.querySelector('.item-status');
                if (status) {
                    status.className = 'item-status owned';
                    status.textContent = '已拥有';
                }
            }

            // 清除装备
            dressupState.equipped[category] = null;

            // 更新预览
            updateCharacterPreview(category, '', false);

            // 更新槽位
            updateEquippedSlots();

            showInfoModal('👋', '已卸下装扮', `酷奇脱下了「${equipped.name}」`);
        }

        // 初始化装扮预览
        function initDressupPreview() {
            restoreEquippedPreview();
            updateEquippedSlots();
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            initDressupPreview();
        });

        // 购买装扮
        function buyItem(itemId, price) {
            if (totalStars >= price) {
                if (confirm(`确定要花费 🌟${price} 购买这个装扮吗？`)) {
                    totalStars -= price;
                    document.getElementById('star-count').textContent = totalStars;
                    showInfoModal('🎉', '购买成功', '已解锁新装扮~\n快去给酷奇穿上吧！');
                }
            } else {
                showInfoModal('😅', '星星不够哦', `还需要 🌟${price - totalStars}\n继续完成任务赚取星星吧！`);
            }
        }

        // 兑换心愿
        let diamondCoins = 45;
        function exchangeWish(wishId) {
            const wishPrices = {
                ice: 20,
                game: 30,
                movie: 50
            };
            const wishNames = {
                ice: '一支冰淇淋',
                game: '游戏时间30分钟',
                movie: '看一部电影'
            };

            const price = wishPrices[wishId];
            if (diamondCoins >= price) {
                if (confirm(`确定要用 💎${price} 兑换「${wishNames[wishId]}」吗？\n\n兑换后需要和爸爸妈妈确认哦~`)) {
                    diamondCoins -= price;
                    document.querySelector('.wish-balance-num').textContent = diamondCoins;
                    showInfoModal('🎉', '兑换成功', '请告诉爸爸妈妈\n让他们帮你实现这个心愿~');
                }
            }
        }

        // 添加自定义心愿
        function addCustomWish() {
            const wishName = prompt('想添加什么心愿呢？\n（需要和爸爸妈妈商量确定价格哦~）');
            if (wishName) {
                showInfoModal('✨', '心愿已提交', `「${wishName}」已提交！\n等爸爸妈妈确认后就会出现在心愿列表里~`);
            }
        }

        // ===== 我的页面相关函数 =====

        // 显示VIP信息 - 打开付费墙
        function showVipInfo() {
            showPaywall();
        }

        // ===== 付费墙系统 =====

        // 付费状态
        let membershipState = {
            isVip: false,
            selectedPlan: 'lifetime', // 'monthly' or 'lifetime'
            verifyAnswer: null
        };

        // 显示付费墙
        function showPaywall() {
            document.getElementById('paywall-overlay').classList.add('active');
            updateBuyButton();
        }

        // 关闭付费墙
        function closePaywall() {
            document.getElementById('paywall-overlay').classList.remove('active');
        }

        // 选择套餐
        function selectPlan(planType) {
            membershipState.selectedPlan = planType;

            // 更新卡片样式
            document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('plan-' + planType).classList.add('selected');

            updateBuyButton();
        }

        // 更新购买按钮
        function updateBuyButton() {
            const btnText = document.getElementById('buy-btn-text');
            if (membershipState.selectedPlan === 'monthly') {
                btnText.textContent = '立即开通 ¥9.9/月';
            } else {
                btnText.textContent = '立即开通 ¥99';
            }
        }

        // 开始支付流程
        function startPayment() {
            // 生成验证题
            const a = Math.floor(Math.random() * 10) + 10; // 10-19
            const b = Math.floor(Math.random() * 8) + 5;   // 5-12
            membershipState.verifyAnswer = a * b;

            // 显示验证题
            document.getElementById('verify-question').textContent = `${a} × ${b} = ?`;
            document.getElementById('verify-input').value = '';
            document.getElementById('verify-error').style.display = 'none';
            document.getElementById('verify-overlay').classList.add('active');
        }

        // 关闭验证弹窗
        function closeVerify() {
            document.getElementById('verify-overlay').classList.remove('active');
        }

        // 检查验证答案
        function checkVerifyAnswer() {
            const input = document.getElementById('verify-input').value;
            const answer = parseInt(input);

            if (answer === membershipState.verifyAnswer) {
                // 验证成功，模拟支付
                closeVerify();
                simulatePayment();
            } else {
                // 答案错误
                document.getElementById('verify-error').style.display = 'block';
            }
        }

        // 模拟支付流程
        function simulatePayment() {
            // 关闭付费墙
            closePaywall();

            // 模拟支付延迟
            setTimeout(() => {
                // 更新会员状态
                membershipState.isVip = true;

                // 更新UI
                updateMembershipUI();

                // 显示成功
                document.getElementById('payment-success-overlay').classList.add('active');
            }, 500);
        }

        // 关闭支付成功弹窗
        function closePaymentSuccess() {
            document.getElementById('payment-success-overlay').classList.remove('active');
        }

        // 更新会员UI
        function updateMembershipUI() {
            // 更新个人页的会员状态显示
            const badgeEl = document.querySelector('.profile-badge');
            if (badgeEl) {
                badgeEl.textContent = '✨ VIP';
                badgeEl.classList.remove('free');
                badgeEl.classList.add('vip');
            }

            // 更新菜单项
            const menuTitle = document.querySelector('.menu-item .menu-title');
            if (menuTitle && menuTitle.textContent === '开通会员') {
                const menuItem = menuTitle.closest('.menu-item');
                menuItem.querySelector('.menu-title').textContent = '会员中心';
                menuItem.querySelector('.menu-desc').textContent = '终身会员 · 有效期永久';
            }
        }

        // 显示成长数据
        function showGrowthData() {
            showInfoModal('📊', '成长数据', '累计完成 156 个任务\n坚持了 42 天\n获得了 1,280 🌟\n最长连续 21 天\n\n你真的越来越厉害了！💪');
        }

        // 显示仓库
        function showWarehouse() {
            showInfoModal('🎽', '我的仓库', '已拥有装饰：\n• 🎀 蝴蝶结\n• 🌈 彩虹尾巴\n• 🧢 棒球帽\n• 🌸 樱花背包\n\n共 8 件装饰');
        }

        // ===== 顶部横幅交互 =====

        // 点击用户头像/信息区域
        function showUserProfile() {
            // 切换到"我的"页面
            switchPage('profile');
        }

        // 显示星星详情
        function showStarDetail() {
            document.getElementById('star-balance').textContent = document.getElementById('star-count').textContent;
            document.getElementById('star-detail-overlay').classList.add('active');
        }

        // 关闭星星详情
        function closeStarDetail() {
            document.getElementById('star-detail-overlay').classList.remove('active');
        }

        // 显示心愿币详情
        function showDiamondDetail() {
            document.getElementById('diamond-balance').textContent = document.getElementById('diamond-count').textContent;
            document.getElementById('diamond-detail-overlay').classList.add('active');
        }

        // 关闭心愿币详情
        function closeDiamondDetail() {
            document.getElementById('diamond-detail-overlay').classList.remove('active');
        }

        // 显示顶部菜单
        function showHeaderMenu() {
            document.getElementById('header-menu-overlay').classList.add('active');
        }

        // 关闭顶部菜单
        function closeHeaderMenu() {
            document.getElementById('header-menu-overlay').classList.remove('active');
        }

        // 切换孩子
        function switchChild() {
            closeHeaderMenu();
            showInfoModal('👦', '切换孩子', '当前家庭成员：\n\n• 小星星（当前）\n• 小明明\n• 小月月\n\n点击头像可切换');
        }

        // 通知设置
        function showNotifySettings() {
            closeHeaderMenu();
            showInfoModal('🔔', '通知设置', '✓ 任务提醒\n✓ 完成通知\n✓ 家长消息\n○ 营销推送\n\n可在微信-服务号中管理');
        }

        // 音效设置
        function showSoundSettings() {
            closeHeaderMenu();
            showInfoModal('🔊', '音效设置', '🔊 音效：开启\n🎵 背景音乐：关闭\n\n完成任务、获得奖励时\n会有可爱的音效提示~');
        }

        // 关于
        function showAbout() {
            closeHeaderMenu();
            showInfoModal('✨', '关于星伴', '星伴 v1.0.0\n\n专为8-12岁儿童设计的\nAI习惯养成助手\n\n© 2026 星伴团队');
        }

        // 去商城
        function goToShop() {
            switchPage('rewards');
            // 切换到装扮tab
            setTimeout(() => {
                const dressTab = document.querySelector('.reward-tab');
                if (dressTab) dressTab.click();
            }, 100);
        }

        // 去心愿商城
        function goToWish() {
            switchPage('rewards');
            // 切换到心愿tab
            setTimeout(() => {
                const tabs = document.querySelectorAll('.reward-tab');
                if (tabs[2]) tabs[2].click();
            }, 100);
        }

        // ===== 徽章系统 =====

        // 徽章数据
        const badgesData = {
            // 已获得
            bookworm: { name: '书虫', emoji: '📚', desc: '累计阅读时长达到10小时', date: '2026-01-05', owned: true },
            earlybird: { name: '早起鸟', emoji: '🌅', desc: '连续7天在8点前开始任务', date: '2026-01-08', owned: true },
            streak7: { name: '7天连续', emoji: '🔥', desc: '连续7天完成每日任务', date: '2026-01-10', owned: true },
            organizer: { name: '整理达人', emoji: '🏠', desc: '完成10次整理房间任务', date: '2026-01-09', owned: true },
            star100: { name: '首个100星', emoji: '⭐', desc: '累计获得100颗星星', date: '2026-01-03', owned: true },
            firstplan: { name: '首个计划', emoji: '🎯', desc: '创建第一个长期计划', date: '2026-01-06', owned: true },
            // 未获得
            streak30: { name: '30天连续', emoji: '🏆', desc: '连续30天完成每日任务', owned: false, progress: 7, total: 30 },
            readmaster: { name: '阅读大师', emoji: '📖', desc: '累计阅读时长达到100小时', owned: false, progress: 12, total: 100 },
            star500: { name: '星星收藏家', emoji: '🌟', desc: '累计获得500颗星星', owned: false, progress: 128, total: 500 },
            star1000: { name: '星星大师', emoji: '💫', desc: '累计获得1000颗星星', owned: false, progress: 128, total: 1000 },
            exercise: { name: '运动健将', emoji: '🏃', desc: '完成50次运动任务', owned: false, progress: 15, total: 50 },
            homework: { name: '作业达人', emoji: '📝', desc: '按时完成30次作业', owned: false, progress: 22, total: 30 }
        };

        // 显示徽章详情
        function showBadgeDetail(badgeId) {
            const badge = badgesData[badgeId];
            if (!badge) {
                // 尝试从DOM获取数据
                const badgeEl = document.querySelector(`.badge-item[data-id="${badgeId}"], .full-badge-item[onclick*="${badgeId}"]`);
                if (!badgeEl) return;
            }

            const data = badge || {};
            const isOwned = data.owned;

            // 更新模态框内容
            document.getElementById('badge-modal-icon').textContent = data.emoji || '🏅';
            document.getElementById('badge-modal-name').textContent = data.name || '徽章';
            document.getElementById('badge-modal-desc').textContent = data.desc || '';

            // 更新状态
            const statusEl = document.getElementById('badge-modal-status');
            if (isOwned) {
                statusEl.innerHTML = '<span class="status-tag owned">✓ 已获得</span>';
                document.getElementById('badge-modal-date').textContent = `获得时间：${data.date}`;
                document.getElementById('badge-modal-date').style.display = 'block';
                document.getElementById('badge-modal-progress').style.display = 'none';
            } else {
                statusEl.innerHTML = '<span class="status-tag locked">🔒 未解锁</span>';
                document.getElementById('badge-modal-date').style.display = 'none';

                // 显示进度
                if (data.progress !== undefined && data.total !== undefined) {
                    const percent = Math.round((data.progress / data.total) * 100);
                    document.getElementById('badge-modal-progress').style.display = 'block';
                    document.getElementById('badge-progress-fill').style.width = percent + '%';
                    document.getElementById('badge-progress-text').textContent = `${data.progress}/${data.total}`;
                } else {
                    document.getElementById('badge-modal-progress').style.display = 'none';
                }
            }

            // 显示模态框
            document.getElementById('badge-modal-overlay').classList.add('active');
        }

        // 关闭徽章详情模态框
        function closeBadgeModal() {
            document.getElementById('badge-modal-overlay').classList.remove('active');
        }

        // 显示全部徽章页面
        function showAllBadges() {
            document.getElementById('all-badges-overlay').classList.add('active');
        }

        // 关闭全部徽章页面
        function closeAllBadges() {
            document.getElementById('all-badges-overlay').classList.remove('active');
        }

        // 显示家长设置 - 打开验证弹窗
        function showParentSettings() {
            // 生成随机验证题
            const a = Math.floor(Math.random() * 10) + 10; // 10-19
            const b = Math.floor(Math.random() * 8) + 5;   // 5-12
            window.parentVerifyAnswer = a * b;

            document.getElementById('verify-question-text').textContent = `${a} × ${b} = ?`;
            document.getElementById('verify-input').value = '';
            document.getElementById('verify-error').style.display = 'none';
            document.getElementById('parent-verify-modal').classList.add('active');
        }

        // 关闭验证弹窗
        function closeParentVerifyModal() {
            document.getElementById('parent-verify-modal').classList.remove('active');
        }

        // 验证家长答案
        function verifyParentAnswer() {
            const input = document.getElementById('verify-input').value;
            if (parseInt(input) === window.parentVerifyAnswer) {
                closeParentVerifyModal();
                openParentCenter();
            } else {
                document.getElementById('verify-error').style.display = 'block';
                document.getElementById('verify-input').value = '';
            }
        }

        // ===== 家长中心功能 =====

        // 打开家长中心
        function openParentCenter() {
            renderParentTaskList();
            document.getElementById('parent-center-overlay').classList.add('active');
        }

        // 关闭家长中心
        function closeParentCenter() {
            document.getElementById('parent-center-overlay').classList.remove('active');
        }

        // 渲染家长任务列表
        function renderParentTaskList() {
            const listEl = document.getElementById('parent-task-list');

            if (parentTaskQueue.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align:center;padding:20px;color:var(--text-muted);">
                        暂无发布的任务<br>
                        点击上方按钮发布新任务
                    </div>
                `;
                return;
            }

            listEl.innerHTML = parentTaskQueue.map(task => {
                const statusClass = task.completed ? 'completed' : 'sent';
                const statusText = task.completed ? '已完成' : '待完成';

                return `
                    <div class="parent-task-item ${statusClass}">
                        <div class="parent-task-info">
                            <div class="parent-task-title">${task.title}</div>
                            <div class="parent-task-meta">
                                📩 ${task.from} · 💎${task.suggestedReward}
                                ${task.deadline ? ` · ⏰${task.deadline}前` : ''}
                            </div>
                        </div>
                        <span class="parent-task-status ${statusClass}">${statusText}</span>
                    </div>
                `;
            }).join('');
        }

        // 显示任务管理
        function showParentTaskManage() {
            // 已经在主界面显示，滚动到任务区
            document.getElementById('task-manage-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 显示心愿审批（占位）
        function showParentWishManage() {
            showInfoModal('🎁', '心愿审批', '待审批心愿：\n• 一支冰淇淋 (💎20)\n• 游戏时间30分钟 (💎30)\n\n（功能完善中...）');
        }

        // 显示成长报告（占位）
        function showParentReport() {
            showInfoModal('📊', '小星星的成长报告', '本周数据：\n• 完成任务：12个\n• 获得星星：156🌟\n• 连续天数：7天\n• 最佳表现：阅读\n\n继续保持！💪');
        }

        // 显示奖励设置（占位）
        function showParentRewardSetting() {
            showInfoModal('⚙️', '奖励设置', '• 任务基础奖励：5-50🌟\n• 连续完成加成：10%\n• 全勤额外奖励：开启\n• 钻石兑换比例：10🌟=1💎\n\n（功能完善中...）');
        }

        // 打开发布任务弹窗
        function showCreateTaskModal() {
            document.getElementById('new-task-title').value = '';
            document.getElementById('new-task-deadline').value = '';
            document.getElementById('new-task-reward').value = 20;
            document.getElementById('reward-display').textContent = '💎 20';
            document.getElementById('create-task-modal').classList.add('active');
        }

        // 关闭发布任务弹窗
        function closeCreateTaskModal() {
            document.getElementById('create-task-modal').classList.remove('active');
        }

        // 更新奖励显示
        function updateRewardDisplay() {
            const value = document.getElementById('new-task-reward').value;
            document.getElementById('reward-display').textContent = '💎 ' + value;
        }

        // AI拆解模板 - 根据任务类型生成步骤
        function generateDecomposeSteps(title) {
            // 预设的任务拆解模板
            const templates = {
                '作业': [
                    { icon: '📚', name: '准备学习用品', time: '2分钟' },
                    { icon: '✏️', name: '完成前半部分', time: '15分钟' },
                    { icon: '✏️', name: '完成后半部分', time: '15分钟' },
                    { icon: '✅', name: '检查并整理', time: '5分钟' }
                ],
                '练琴': [
                    { icon: '🎹', name: '热身练习', time: '5分钟' },
                    { icon: '🎵', name: '复习上次的曲目', time: '10分钟' },
                    { icon: '🎶', name: '练习新曲目', time: '12分钟' },
                    { icon: '🎼', name: '完整演奏一遍', time: '3分钟' }
                ],
                '阅读': [
                    { icon: '📖', name: '找到舒适的阅读位置', time: '2分钟' },
                    { icon: '📚', name: '阅读第一部分', time: '10分钟' },
                    { icon: '📚', name: '阅读第二部分', time: '10分钟' },
                    { icon: '📝', name: '记录读书笔记', time: '8分钟' }
                ],
                '整理': [
                    { icon: '🛏️', name: '整理床铺', time: '5分钟' },
                    { icon: '📚', name: '收拾书桌', time: '8分钟' },
                    { icon: '🧸', name: '整理玩具', time: '7分钟' },
                    { icon: '✨', name: '最后检查', time: '3分钟' }
                ],
                '运动': [
                    { icon: '🏃', name: '热身准备', time: '3分钟' },
                    { icon: '💪', name: '主要运动', time: '15分钟' },
                    { icon: '🧘', name: '放松拉伸', time: '5分钟' }
                ]
            };

            // 匹配任务类型
            let steps = null;
            for (const [key, value] of Object.entries(templates)) {
                if (title.includes(key)) {
                    steps = value;
                    break;
                }
            }

            // 默认拆解
            if (!steps) {
                steps = [
                    { icon: '📋', name: '准备开始', time: '3分钟' },
                    { icon: '⚡', name: '执行任务第一部分', time: '10分钟' },
                    { icon: '⚡', name: '执行任务第二部分', time: '10分钟' },
                    { icon: '✅', name: '完成检查', time: '5分钟' }
                ];
            }

            return steps;
        }

        // 显示AI拆解预览 - V2.0 增强版（个性化时间+调整功能）
        function showDecomposePreview(title, from, reward, deadline) {
            const steps = generateDecomposeSteps(title);
            const taskType = getTaskType(title);
            const profile = userTimeProfile.efficiency[taskType] || userTimeProfile.efficiency.default;

            // 计算个性化时间
            let totalBaseTime = steps.reduce((sum, s) => sum + parseInt(s.time), 0);
            const personalizedInfo = calculatePersonalizedTime(totalBaseTime, taskType);

            // 生成个性化说明
            let personalizedNote = '';
            if (personalizedInfo.isPersonalized && profile.samples > 0) {
                if (personalizedInfo.comparison === 'slower') {
                    personalizedNote = `<div style="background:rgba(251,191,36,0.1);color:#D97706;padding:8px 12px;border-radius:8px;font-size:12px;margin-bottom:12px;">
                        📊 根据${userTimeProfile.name}过去${profile.samples}次${taskType}类任务的表现，TA完成这类任务通常比平均慢一些，已自动延长预估时间。
                    </div>`;
                } else if (personalizedInfo.comparison === 'faster') {
                    personalizedNote = `<div style="background:rgba(52,211,153,0.1);color:#059669;padding:8px 12px;border-radius:8px;font-size:12px;margin-bottom:12px;">
                        ⚡ 根据${userTimeProfile.name}过去${profile.samples}次${taskType}类任务的表现，TA完成这类任务效率很高！已相应缩短预估时间。
                    </div>`;
                }
            }

            const content = document.getElementById('decompose-content');
            content.innerHTML = `
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:14px;color:var(--text-secondary);margin-bottom:8px;">
                        酷奇已将任务智能拆解为 ${steps.length} 个步骤
                    </div>
                    <div style="font-size:16px;font-weight:600;color:var(--text-primary);">
                        📋 ${title}
                    </div>
                    <div style="font-size:13px;color:var(--text-muted);margin-top:4px;">
                        ${personalizedInfo.isPersonalized ?
                    `⏱️ 个性化预估：约 ${personalizedInfo.time} 分钟` :
                    `⏱️ 预估用时：约 ${totalBaseTime} 分钟`}
                    </div>
                </div>

                ${personalizedNote}

                <div style="background:rgba(124,58,237,0.05);border-radius:16px;padding:16px;margin-bottom:16px;">
                    ${steps.map((s, i) => `
                        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;${i < steps.length - 1 ? 'border-bottom:1px solid rgba(124,58,237,0.1);' : ''}">
                            <div style="width:24px;height:24px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;">${i + 1}</div>
                            <div style="font-size:20px;">${s.icon}</div>
                            <div style="flex:1;">
                                <div style="font-size:14px;font-weight:500;color:var(--text-primary);">${s.name}</div>
                                <div style="font-size:12px;color:var(--text-muted);">约${s.time}</div>
                            </div>
                            <div style="font-size:12px;color:var(--primary);cursor:pointer;" onclick="adjustDecomposeStepTime(${i}, '${s.name}', '${s.time}')">
                                ✏️调整
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(244,114,182,0.1));border-radius:12px;padding:14px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-size:13px;color:var(--text-secondary);">完成全部后可获得</div>
                        <div style="font-size:12px;color:var(--text-muted);">需要${from}确认后发放</div>
                    </div>
                    <div style="font-size:20px;font-weight:700;color:var(--primary);">💎 ${reward}</div>
                </div>

                <div style="display:flex;gap:12px;">
                    <button class="submit-task-btn" style="flex:1;background:rgba(124,58,237,0.1);color:var(--primary);" onclick="showParentTimeReport()">
                        📊 时间报告
                    </button>
                    <button class="submit-task-btn" style="flex:1;" onclick="confirmAndSendTask()">
                        ✅ 确认发送
                    </button>
                </div>

                <p style="font-size:12px;color:var(--text-muted);text-align:center;margin-top:12px;">
                    💡 点击各步骤的"调整"可修改预估时间
                </p>
            `;

            // 保存当前拆解的步骤供调整使用
            window.currentDecomposeSteps = steps;
            window.currentDecomposeTitle = title;
            window.currentDecomposeFrom = from;
            window.currentDecomposeReward = reward;

            document.getElementById('ai-decompose-modal').classList.add('active');
        }

        // 调整拆解步骤时间（家长端）
        function adjustDecomposeStepTime(stepIndex, stepName, currentTime) {
            const newTime = prompt(`调整「${stepName}」的预估时间\n\n当前：${currentTime}\n请输入新的时间（分钟）：`, parseInt(currentTime));

            if (newTime && !isNaN(newTime) && parseInt(newTime) > 0) {
                window.currentDecomposeSteps[stepIndex].time = newTime + '分钟';

                // 重新渲染预览
                showDecomposePreview(
                    window.currentDecomposeTitle,
                    window.currentDecomposeFrom,
                    window.currentDecomposeReward,
                    null
                );

                console.log(`[家长端时间调整] 步骤${stepIndex + 1}「${stepName}」从${currentTime}调整为${newTime}分钟`);
            }
        }

        // 显示家长端时间报告
        function showParentTimeReport() {
            const history = userTimeProfile.history.slice(0, 5);
            const efficiency = userTimeProfile.efficiency;

            let reportHtml = `
                <h3 style="text-align:center;margin-bottom:16px;">📊 ${userTimeProfile.name}的时间分析报告</h3>

                <div style="background:rgba(124,58,237,0.05);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">各类任务效率</div>
                    ${Object.entries(efficiency).filter(([k]) => k !== 'default').map(([type, data]) => {
                const effText = data.coefficient > 1 ? '⚡ 较快' : (data.coefficient < 1 ? '🐢 较慢' : '⏱️ 正常');
                const effColor = data.coefficient > 1 ? '#059669' : (data.coefficient < 1 ? '#D97706' : 'var(--text-secondary)');
                return `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(124,58,237,0.1);">
                                <span>${type}类</span>
                                <span style="color:${effColor};font-weight:500;">${effText} (${data.samples}次记录)</span>
                            </div>
                        `;
            }).join('')}
                </div>

                <div style="background:rgba(52,211,153,0.05);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="font-size:14px;font-weight:600;color:var(--text-primary);margin-bottom:12px;">最近完成记录</div>
                    ${history.map(h => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(52,211,153,0.1);">
                            <span>${h.type} (${h.date})</span>
                            <span>预计${h.estimated}分 → 实际${h.actual}分</span>
                        </div>
                    `).join('')}
                </div>

                <button class="submit-task-btn" style="width:100%;" onclick="closeTimeReportModal()">
                    关闭报告
                </button>
            `;

            // 替换弹窗内容
            document.getElementById('decompose-content').innerHTML = reportHtml;
        }

        // 关闭时间报告（返回拆解预览）
        function closeTimeReportModal() {
            showDecomposePreview(
                window.currentDecomposeTitle,
                window.currentDecomposeFrom,
                window.currentDecomposeReward,
                null
            );
        }

        // 关闭拆解预览弹窗
        function closeDecomposeModal() {
            document.getElementById('ai-decompose-modal').classList.remove('active');
        }

        // 确认并发送任务
        function confirmAndSendTask() {
            closeDecomposeModal();
            showInfoModal('✅', '任务已发送', '任务已发送给孩子！\n酷奇会引导TA一步步完成哦~');
        }

        // 保存当前任务信息（用于预览后发送）
        let pendingTask = null;

        // 提交新任务
        function submitNewTask() {
            const title = document.getElementById('new-task-title').value.trim();
            const deadline = document.getElementById('new-task-deadline').value;
            const reward = parseInt(document.getElementById('new-task-reward').value);
            const from = document.getElementById('new-task-from').value;

            if (!title) {
                showInfoModal('📝', '请输入任务', '请先输入任务内容哦~');
                return;
            }

            // 创建新任务
            const newTask = {
                id: 'task-' + Date.now(),
                title: title,
                from: from,
                deadline: deadline || null,
                suggestedReward: reward,
                priority: 'normal',
                completed: false
            };

            // 添加到队列
            parentTaskQueue.push(newTask);

            // 更新列表显示
            renderParentTaskList();

            // 关闭发布弹窗
            closeCreateTaskModal();

            // 显示AI拆解预览
            showDecomposePreview(title, from, reward, deadline);

            console.log(`[家长中心] 发布新任务: ${title}, 来自${from}, 奖励${reward}心愿币`);
        }

        // 快速发布任务
        function quickCreateTask(taskTitle) {
            const from = '妈妈'; // 默认发布者
            const reward = 20;   // 默认奖励

            const newTask = {
                id: 'task-' + Date.now(),
                title: taskTitle,
                from: from,
                deadline: null,
                suggestedReward: reward,
                priority: 'normal',
                completed: false
            };

            parentTaskQueue.push(newTask);
            renderParentTaskList();

            // 显示AI拆解预览
            showDecomposePreview(taskTitle, from, reward, null);
        }

        // 显示设置
        function showSettings() {
            showInfoModal('⚙️', '设置', '• 音效：开启\n• 通知提醒：开启\n• 自动锁屏：关闭\n• 关于星伴\n• 用户协议\n• 联系我们');
        }

        // ===== 家长任务相关函数 =====

        // 显示家长发布的任务 - 使用统一的任务处理入口
        function showParentTask(taskId = null) {
            // 获取家长任务（从队列或指定ID）
            let parentTask;
            if (taskId) {
                parentTask = parentTaskQueue.find(t => t.id === taskId);
            }
            if (!parentTask) {
                parentTask = parentTaskQueue[0]; // 默认取第一个
            }

            if (!parentTask) {
                showInfoModal('📨', '暂无任务', '还没有家长发布的任务哦~');
                return;
            }

            // 使用统一的任务处理入口（家长任务）
            processTask({
                title: parentTask.title,
                source: 'parent',
                from: parentTask.from,
                deadline: parentTask.deadline,
                suggestedReward: parentTask.suggestedReward
            });
        }

        // 开始执行家长任务（复用startExec）
        function startParentTask() {
            startExec();
        }

        // 模拟家长发布新任务（伙伴主动提醒）
        function simulateParentNotification() {
            // 添加一个新任务到队列
            const newTask = {
                id: 'new-task-' + Date.now(),
                title: '练习书法20分钟',
                from: '妈妈',
                deadline: '21:00',
                suggestedReward: 15,
                priority: 'normal'
            };
            parentTaskQueue.unshift(newTask);

            // 显示新任务通知
            document.getElementById('partner-message').innerHTML =
                `📩 <strong>新任务！</strong><br>${newTask.from}刚刚给你安排了一个任务~<br>「${newTask.title}」<br>快来看看吧！`;
            document.getElementById('partner-expr').textContent = '❗';

            // 添加点击事件提示
            setTimeout(() => {
                document.getElementById('partner-expr').textContent = '';
            }, 3000);
        }

        // 任务完成后通知家长
        function notifyParentTaskComplete() {
            if (currentTask.source === 'parent' && currentTask.from) {
                // 模拟发送通知
                console.log(`[通知] 发送完成通知给${currentTask.from}：任务「${currentTask.title}」已完成`);

                // 显示提示
                setTimeout(() => {
                    document.getElementById('partner-message').innerHTML =
                        `🎉 太棒了！「${currentTask.title}」完成了！<br><br>📤 已通知${currentTask.from}，TA一定会很开心的！✨`;
                }, 500);
            }
        }

        // 回车发送
        document.getElementById('chat-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') submitGoal();
        });
    </script>
</body>

</html>