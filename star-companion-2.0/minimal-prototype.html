<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>星伴 - 完整交互原型</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #7C3AED;
            --primary-light: #A78BFA;
            --secondary: #F472B6;
            --accent: #34D399;
            --warning: #FBBF24;
            --bg-gradient: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            --bg-card: rgba(255, 255, 255, 0.95);
            --text-primary: #1E1B4B;
            --text-secondary: #6B7280;
            --text-muted: #6B7280;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            --shadow-soft: 0 4px 20px rgba(124, 58, 237, 0.1);
            --shadow-float: 0 10px 40px rgba(124, 58, 237, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            font-family: 'Nunito', sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            color: var(--text-primary);
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Fredoka', sans-serif;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-gradient);
            position: relative;
            overflow: hidden;
        }

        /* ===== Header ===== */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid rgba(124, 58, 237, 0.08);
            position: relative;
            z-index: 10;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info .user-name {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 15px;
        }

        .user-info .user-streak {
            font-size: 12px;
            color: var(--warning);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-stats {
            display: flex;
            gap: 12px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
            font-size: 14px;
        }

        .menu-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
        }

        /* ===== Pages Container ===== */
        .pages-container {
            height: calc(100vh - 56px - 64px);
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            inset: 0;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 100px;
            /* 增加底部间距，确保不被导航栏遮挡 */
            display: none;
            animation: fadeIn 0.25s ease-out;
            /* 关键修复：添加不透明背景防止重叠 */
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 1;
        }

        .page.active {
            display: block;
            z-index: 5;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ===== Bottom Navigation - 优化版 ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 420px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            padding: 4px 12px 8px;
            /* 极简 padding */
            /* 减小 padding 使导航栏更紧凑 */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(124, 58, 237, 0.1);
            box-shadow: 0 -4px 20px rgba(124, 58, 237, 0.08);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .bottom-nav.minimal {
            padding: 8px 16px 24px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1px;
            /* 最小间距 */
            padding: 4px 10px;
            /* 最小内边距 */
            border-radius: 12px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 24px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .nav-item .nav-icon {
            display: block;
            width: 24px;
            height: 24px;
            margin: 0 auto 2px auto;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* [已废弃] 旧的 SVG 子元素样式，现改用 background-image
        .nav-item .nav-icon svg { ... }
        .nav-item.active .nav-icon svg { ... }
        */

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        /* 图标背景图定义 - 默认状态 (灰色) */
        .nav-item .nav-icon.icon-home {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTIwIDJINGMtMS4xIDAtMiAuOS0yIDJ2MThsNC00aDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bTAgMTRINS4xN0w0IDE3LjE3VjRoMTZ2MTJ6Ii8+PC9zdmc+');
        }

        .nav-item .nav-icon.icon-tasks {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTE5IDNINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDVWNWgxNHYxNHpNMTcuOTkgOWwtMS40MS0xLjQyLTYuNTkgNi41OS0yLjU4LTIuNTctMS40MiAxLjQxIDQgMy45OXoiLz48L3N2Zz4=');
        }

        .nav-item .nav-icon.icon-rewards {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTIwIDZoLTIuMThjLjExLS4zMS4xOC0uNjUuMTgtMSAwLTEuNjYtMS4zNC0zLTMtMy0xLjA1IDAtMS45Ni41NC0yLjUgMS4zNWwtLjUuNjctLjUtLjY4QzEwLjk2IDIuNTQgMTAuMDUgMiA5IDIgNy4zNCAyIDYgMy4zNCA2IDVjMCAuMzUuMDcuNjkuMTggMUg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOWMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS01LTJjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXpNOSA0Yy41NSAwIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxLTEtLjQ1LTEtMSAuNDUtMSAxLTF6bTExIDE1SDR2LTJoMTZ2MnptMC01SDRWOGg1LjA4TDcgMTAuODMgOC42MiAxMiAxMiA3LjRsMy4zOCA0LjZMMTcgMTAuODMgMTQuOTIgOEgyMHY2eiIvPjwvc3ZnPg==');
        }

        .nav-item .nav-icon.icon-profile {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzlDQTNBRiIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==');
        }

        /* 图标背景图定义 - 激活状态 (紫色) */
        .nav-item.active .nav-icon.icon-home {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTIwIDJINGMtMS4xIDAtMiAuOS0yIDJ2MThsNC00aDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bTAgMTRINS4xN0w0IDE3LjE3VjRoMTZ2MTJ6Ii8+PC9zdmc+');
        }

        .nav-item.active .nav-icon.icon-tasks {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTE5IDNINWMtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxNGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDVWNWgxNHYxNHpNMTcuOTkgOWwtMS40MS0xLjQyLTYuNTkgNi41OS0yLjU4LTIuNTctMS40MiAxLjQxIDQgMy45OXoiLz48L3N2Zz4=');
        }

        .nav-item.active .nav-icon.icon-rewards {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTIwIDZoLTIuMThjLjExLS4zMS4xOC0uNjUuMTgtMSAwLTEuNjYtMS4zNC0zLTMtMy0xLjA1IDAtMS45Ni41NC0yLjUgMS4zNWwtLjUuNjctLjUtLjY4QzEwLjk2IDIuNTQgMTAuMDUgMiA5IDIgNy4zNCAyIDYgMy4zNCA2IDVjMCAuMzUuMDcuNjkuMTggMUg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOWMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS01LTJjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXpNOSA0Yy41NSAwIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxLTEtLjQ1LTEtMSAuNDUtMSAxLTF6bTExIDE1SDR2LTJoMTZ2MnptMC01SDRWOGg1LjA4TDcgMTAuODMgOC42MiAxMiAxMiA3LjRsMy4zOCA0LjZMMTcgMTAuODMgMTQuOTIgOEgyMHY2eiIvPjwvc3ZnPg==');
        }

        .nav-item.active .nav-icon.icon-profile {
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzdDM0FFRCIgZD0iTTEyIDEyYzIuMjEgMCA0LTEuNzkgNC00cy0xLjc5LTQtNC00LTQgMS43OS00IDQgMS43OSA0IDQgNHptMCAyYy0yLjY3IDAtOCAxLjM0LTggNHYyaDE2di0yYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPg==');
        }

        .nav-item .nav-label {
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.25s;
        }

        .nav-item.active .nav-label {
            color: var(--primary);
            font-weight: 700;
        }

        .nav-item:hover {
            background: rgba(124, 58, 237, 0.06);
        }

        .nav-item:active {
            transform: scale(0.95);
        }

        .nav-badge {
            position: absolute;
            top: 2px;
            right: 10px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #EF4444, #F472B6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* ===== 对话页 (HOME) ===== */
        #page-home {
            display: none;
            flex-direction: column;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
        }

        #page-home.active {
            display: flex;
            z-index: 5;
        }

        /* ===== 伙伴展示舞台 ===== */
        .partner-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px 16px;
            position: relative;
        }

        .stage-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(124, 58, 237, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.6;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
        }

        .partner-character {
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .partner-character:hover {
            transform: scale(1.05);
        }

        .partner-character:active {
            transform: scale(0.98);
        }

        .partner-image {
            width: 140px;
            height: 140px;
            object-fit: contain;
            filter: drop-shadow(0 8px 16px rgba(124, 58, 237, 0.2));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .partner-expression {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            animation: pop 0.3s ease-out;
        }

        @keyframes pop {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        .partner-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 12px;
            z-index: 2;
        }

        .partner-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .partner-level {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .level-badge {
            padding: 3px 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 12px;
            font-weight: 700;
            border-radius: 20px;
        }

        .level-text {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .level-progress {
            width: 120px;
            height: 6px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .level-hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* ===== 对话气泡 ===== */
        .partner-dialog {
            padding: 0 20px;
            margin-bottom: 16px;
        }

        .dialog-bubble {
            background: var(--bg-card);
            padding: 14px 18px;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .dialog-bubble::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--bg-card);
        }

        .dialog-bubble p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            text-align: center;
        }

        /* ===== 快捷标签区 ===== */
        .quick-section {
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quick-tag {
            padding: 10px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.15);
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.08);
        }

        .quick-tag:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        /* ===== 今日任务预览 ===== */
        .today-tasks-preview {
            margin: 0 16px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            box-shadow: var(--shadow-soft);
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .preview-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .preview-count {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(124, 58, 237, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .view-all-btn {
            margin-left: auto;
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
        }

        .preview-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(124, 58, 237, 0.03);
            border-radius: 12px;
        }

        .preview-item.done {
            opacity: 0.6;
        }

        .preview-item.done .item-name {
            text-decoration: line-through;
        }

        .item-check {
            font-size: 16px;
        }

        .item-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .item-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        /* ===== 对话扩展区 ===== */
        .chat-expand-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-expand-area.hidden {
            display: none;
        }

        /* ===== 输入区域 ===== */
        .input-area {
            padding: 12px 16px 16px;
            background: var(--bg-card);
            border-top: 1px solid rgba(124, 58, 237, 0.08);
            margin-top: auto;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(124, 58, 237, 0.12);
            border-radius: var(--radius-full);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .input-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .voice-btn {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* 保留消息样式用于对话扩展区 */
        .message {
            display: flex;
            gap: 10px;
            max-width: 85%;
            animation: msgIn 0.3s ease-out;
        }

        /* 思考动画 */
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            margin: 8px 0;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: thinkPulse 1.4s ease-in-out infinite;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes thinkPulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.partner {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .msg-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .msg-bubble {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            line-height: 1.5;
        }

        .message.partner .msg-bubble {
            background: var(--bg-card);
            border-bottom-left-radius: 6px;
            box-shadow: var(--shadow-soft);
        }

        .message.user .msg-bubble {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .quick-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 0 4px;
        }

        .quick-tag {
            padding: 8px 14px;
            background: var(--bg-card);
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            color: var(--primary);
            border: 1px solid rgba(124, 58, 237, 0.15);
            transition: all 0.2s;
        }

        .quick-tag:hover {
            background: var(--primary);
            color: white;
        }

        .input-area {
            padding: 12px 16px 16px;
            background: var(--bg-card);
            border-top: 1px solid rgba(124, 58, 237, 0.08);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(124, 58, 237, 0.12);
            border-radius: var(--radius-full);
            font-size: 15px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .input-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .voice-btn {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        /* Task Plan Card */
        .task-plan {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-float);
            margin: 8px 0;
        }

        .plan-header {
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(244, 114, 182, 0.08));
        }

        .plan-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .plan-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .plan-steps {
            padding: 8px 16px;
        }

        .step-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .step-row:last-child {
            border-bottom: none;
        }

        .step-num {
            width: 26px;
            height: 26px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-icon {
            font-size: 20px;
        }

        .step-info {
            flex: 1;
        }

        .step-name {
            font-weight: 600;
            font-size: 14px;
        }

        .step-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .step-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        .plan-bonus {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(52, 211, 153, 0.1));
        }

        .bonus-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .bonus-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
        }

        .action-btns {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius-full);
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.35);
        }

        .action-btn.secondary {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        /* 任务调整选项 */
        .adjust-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 16px 0;
        }

        .adjust-option {
            padding: 14px 12px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            box-shadow: var(--shadow-soft);
            transition: all 0.2s;
        }

        .adjust-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-float);
        }

        .adjust-option:active {
            transform: scale(0.97);
        }

        .adjust-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .adjust-action-btn {
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: var(--radius-full);
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            transition: all 0.2s;
        }

        .adjust-action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .task-plan.compact {
            padding: 10px 14px;
            margin-top: 10px;
        }

        .task-plan.compact .step-row {
            padding: 8px 0;
        }

        /* 家长任务提示 */
        .parent-task-note {
            background: rgba(244, 114, 182, 0.1);
            border-radius: var(--radius-md);
            padding: 12px;
            font-size: 13px;
            color: var(--secondary);
            text-align: center;
            margin: 12px 0;
        }

        /* ===== 任务页 (TASKS) ===== */
        .page-title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 20px;
        }

        .view-toggle {
            display: flex;
            background: rgba(124, 58, 237, 0.08);
            border-radius: var(--radius-full);
            padding: 3px;
        }

        .toggle-btn {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: var(--radius-full);
        }

        .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-soft);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 16px 0 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-soft);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-card.in-progress {
            border-left: 4px solid var(--primary);
        }

        .task-card.parent-task {
            border-left: 4px solid var(--secondary);
        }

        .task-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .task-progress {
            font-size: 12px;
            color: var(--primary);
            margin-top: 4px;
        }

        .task-action-btn {
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .task-action-btn.continue {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .task-action-btn.start {
            background: rgba(52, 211, 153, 0.15);
            color: var(--accent);
        }

        .plan-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-soft);
        }

        .plan-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .plan-card-icon {
            font-size: 24px;
        }

        .plan-card-title {
            font-weight: 600;
            font-size: 15px;
        }

        .plan-card-day {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar.large {
            height: 10px;
            overflow: visible;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ===== 长期计划卡片增强版 ===== */
        .long-plan-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 14px;
            box-shadow: var(--shadow-float);
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .long-plan-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .plan-card-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .plan-icon-wrap {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(244, 114, 182, 0.15));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .plan-emoji {
            font-size: 26px;
        }

        .plan-main-info {
            flex: 1;
        }

        .plan-title {
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .plan-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .plan-streak {
            display: flex;
            align-items: center;
            gap: 2px;
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            padding: 6px 10px;
            border-radius: 20px;
        }

        .streak-fire {
            font-size: 14px;
        }

        .streak-num {
            font-size: 14px;
            font-weight: 700;
            color: #D97706;
        }

        .plan-stats-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            margin-bottom: 12px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .plan-stat {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-weight: 700;
            font-size: 15px;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .plan-progress-section {
            margin-bottom: 14px;
        }

        .progress-milestone {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .milestone-dot {
            display: block;
            width: 14px;
            height: 14px;
            background: white;
            border: 3px solid rgba(124, 58, 237, 0.3);
            border-radius: 50%;
        }

        .milestone-dot.done {
            background: var(--accent);
            border-color: var(--accent);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .progress-labels .current {
            color: var(--primary);
            font-weight: 600;
        }

        .plan-today-task {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
        }

        .today-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
        }

        .today-content {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .today-start-btn {
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            flex-shrink: 0;
        }

        .today-start-btn:hover {
            transform: scale(1.05);
        }

        .create-plan-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            background: rgba(124, 58, 237, 0.08);
            border: 2px dashed rgba(124, 58, 237, 0.3);
            border-radius: var(--radius-lg);
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .create-plan-btn:hover {
            background: rgba(124, 58, 237, 0.15);
            border-color: var(--primary);
        }

        .create-icon {
            font-size: 20px;
            font-weight: 300;
        }

        .section-count {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 4px;
        }

        .task-from-plan {
            font-size: 11px;
            color: var(--primary);
            margin-top: 2px;
        }

        /* 家长发布的任务样式 */
        .task-card.parent-task {
            border-left: 3px solid var(--secondary);
            background: linear-gradient(90deg, rgba(244, 114, 182, 0.05) 0%, var(--bg-card) 20%);
        }

        .task-from-parent {
            font-size: 11px;
            color: var(--secondary);
            margin-top: 2px;
            font-weight: 500;
        }

        /* 新任务通知徽章 */
        .new-task-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--secondary);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* ===== 家长中心样式 ===== */
        .parent-center-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }

        .parent-center-overlay.active {
            display: flex;
        }

        .parent-center-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
        }

        .parent-center-title {
            font-size: 18px;
            font-weight: 700;
        }

        .parent-center-close {
            font-size: 20px;
            padding: 8px;
            color: white;
            cursor: pointer;
        }

        .parent-center-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .parent-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .parent-menu-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
            text-align: center;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            transition: all 0.2s;
        }

        .parent-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .parent-menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .parent-menu-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .parent-menu-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* 任务管理面板 */
        .task-manage-section {
            margin-top: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-header h3 {
            font-size: 16px;
            color: var(--text-primary);
        }

        .add-task-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .parent-task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .parent-task-item {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-soft);
        }

        .parent-task-item.pending {
            border-left: 3px solid var(--warning);
        }

        .parent-task-item.sent {
            border-left: 3px solid var(--primary);
        }

        .parent-task-item.completed {
            border-left: 3px solid var(--success);
            opacity: 0.8;
        }

        .parent-task-info {
            flex: 1;
        }

        .parent-task-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .parent-task-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .parent-task-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-weight: 600;
        }

        .parent-task-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .parent-task-status.sent {
            background: rgba(124, 58, 237, 0.15);
            color: var(--primary);
        }

        .parent-task-status.completed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        /* 发布任务表单弹窗 */
        .create-task-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .create-task-modal.active {
            display: flex;
        }

        .create-task-content {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .create-task-header {
            padding: 20px 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .create-task-header h3 {
            font-size: 18px;
            color: var(--text-primary);
        }

        .create-task-close {
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .create-task-form {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: var(--radius-md);
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: var(--radius-md);
            font-size: 15px;
            background: white;
        }

        .reward-slider {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reward-slider input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }

        .reward-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            min-width: 60px;
            text-align: right;
        }

        .quick-task-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-task-tag {
            padding: 8px 14px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: var(--radius-full);
            font-size: 13px;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-task-tag:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .submit-task-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: var(--radius-full);
            font-size: 16px;
            font-weight: 700;
            margin-top: 8px;
            cursor: pointer;
        }

        .submit-task-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===== 奖励页 (REWARDS) ===== */
        .reward-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .reward-tab {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            color: var(--text-secondary);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
        }

        .reward-tab.active {
            color: white;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .shop-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }

        .shop-item-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .shop-item-price {
            font-size: 13px;
            color: var(--warning);
            font-weight: 600;
        }

        .shop-item-owned {
            font-size: 12px;
            color: var(--accent);
        }

        .shop-item.owned {
            opacity: 0.7;
        }

        .shop-item.locked {
            opacity: 0.5;
        }

        .shop-item-price.vip {
            color: var(--primary);
        }

        /* Tab内容切换 */
        .reward-content {
            display: none;
        }

        .reward-content.active {
            display: block;
            animation: fadeIn 0.25s ease-out;
        }

        /* ===== 装扮试穿系统样式 ===== */
        .dressup-preview-area {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.08) 100%);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .dressup-preview-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(180deg);
            }
        }

        .dressup-character {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dressup-body {
            font-size: 80px;
            z-index: 1;
        }

        .dressup-body img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .dressup-layer {
            position: absolute;
            font-size: 32px;
            z-index: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dressup-layer.head {
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dressup-layer.back {
            bottom: 5px;
            right: -10px;
            font-size: 28px;
        }

        .dressup-layer.trying {
            animation: bounce 0.5s ease-out;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.2);
            }
        }

        .dressup-status {
            margin-top: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .trying-label {
            color: var(--warning);
            animation: pulse 1s infinite;
        }

        .equipped-label {
            color: var(--text-muted);
        }

        /* 已装备槽位 */
        .equipped-items {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .equipped-slot {
            background: var(--bg-card);
            border: 2px solid rgba(124, 58, 237, 0.2);
            border-radius: 16px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .equipped-slot:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .equipped-slot.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .slot-icon {
            font-size: 20px;
        }

        .slot-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 分类标签 */
        .dressup-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .category-btn {
            flex-shrink: 0;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid rgba(124, 58, 237, 0.15);
            background: var(--bg-card);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-color: transparent;
        }

        /* 装扮物品网格 */
        .dressup-items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .dressup-item {
            background: var(--bg-card);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .dressup-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.15);
        }

        .dressup-item.trying {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
        }

        .dressup-item.equipped {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
        }

        .dressup-item.locked {
            opacity: 0.5;
        }

        .item-preview {
            font-size: 36px;
            margin-bottom: 6px;
        }

        .item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .item-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .item-price {
            font-size: 11px;
            color: var(--warning);
            font-weight: 600;
        }

        .item-status {
            font-size: 10px;
            font-weight: 500;
        }

        .item-status.owned {
            color: var(--accent);
        }

        .item-status.equipped {
            color: var(--primary);
        }

        .item-locked {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* 操作栏 */
        .dressup-actions {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            animation: slideUp 0.3s ease-out;
        }

        .action-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.cancel {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-secondary);
        }

        .action-btn.confirm {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .action-btn.confirm:hover {
            transform: scale(1.02);
        }

        #action-price {
            margin-left: 6px;
            opacity: 0.9;
        }

        /* ===== 进化页样式 ===== */
        .evolve-partner-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }

        .evolve-partner-img {
            position: relative;
        }

        .evolve-partner-img img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            animation: float 3s ease-in-out infinite;
        }

        .evolve-level-badge {
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .evolve-partner-info {
            flex: 1;
        }

        .evolve-partner-name {
            font-family: 'Fredoka', sans-serif;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .evolve-partner-stage {
            font-size: 14px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .evolve-progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .evolve-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        .evolve-progress-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        .evolve-stages {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 12px;
            margin-bottom: 16px;
        }

        .evolve-stage {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .evolve-stage:last-child {
            border-bottom: none;
        }

        .stage-icon {
            font-size: 28px;
        }

        .stage-info {
            flex: 1;
        }

        .stage-name {
            font-weight: 600;
            font-size: 15px;
        }

        .stage-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stage-status {
            font-size: 18px;
        }

        .evolve-stage.done .stage-name {
            color: var(--accent);
        }

        .evolve-stage.current .stage-name {
            color: var(--primary);
        }

        .evolve-stage.locked {
            opacity: 0.5;
        }

        .evolve-tip {
            background: rgba(251, 191, 36, 0.15);
            border-radius: var(--radius-md);
            padding: 14px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            line-height: 1.6;
        }

        /* ===== 心愿页样式 ===== */
        .wish-balance {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
            border-radius: var(--radius-xl);
            margin-bottom: 20px;
        }

        .wish-balance-icon {
            font-size: 28px;
        }

        .wish-balance-num {
            font-family: 'Fredoka', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .wish-balance-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .wish-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .wish-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        .wish-icon {
            font-size: 32px;
        }

        .wish-info {
            flex: 1;
        }

        .wish-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .wish-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .wish-price {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .wish-price span {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .wish-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .wish-btn.disabled {
            background: #ccc;
            color: #888;
        }

        .wish-btn.add {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .wish-history {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .history-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .history-icon {
            font-size: 20px;
        }

        .history-name {
            flex: 1;
            font-size: 14px;
        }

        .history-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-status {
            font-size: 12px;
        }

        .history-status.done {
            color: var(--accent);
        }

        /* ===== 我的页 (PROFILE) ===== */
        .profile-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-stat {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .profile-badge {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            border-radius: var(--radius-full);
        }

        .profile-badge.free {
            background: rgba(107, 114, 128, 0.1);
            color: var(--text-secondary);
        }

        .menu-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .menu-icon.gold {
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
        }

        .menu-icon.blue {
            background: linear-gradient(135deg, #DBEAFE, #BFDBFE);
        }

        .menu-icon.pink {
            background: linear-gradient(135deg, #FCE7F3, #FBCFE8);
        }

        .menu-icon.purple {
            background: linear-gradient(135deg, #E0E7FF, #C7D2FE);
        }

        .menu-icon.gray {
            background: linear-gradient(135deg, #F3F4F6, #E5E7EB);
        }

        .menu-content {
            flex: 1;
        }

        .menu-title {
            font-weight: 600;
            font-size: 15px;
        }

        .menu-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .menu-arrow {
            color: var(--text-muted);
            font-size: 18px;
        }

        .menu-item:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* ===== 成长数据统计 ===== */
        .stats-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .stats-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }

        .stat-item {
            text-align: center;
            padding: 10px 4px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
        }

        .stat-num {
            display: block;
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .stats-week {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .week-label {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .week-dots {
            display: flex;
            gap: 6px;
            flex: 1;
            justify-content: space-between;
        }

        .week-dots .dot {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            border-radius: 50%;
            background: rgba(124, 58, 237, 0.1);
            color: var(--text-muted);
        }

        .week-dots .dot.done {
            background: var(--accent);
            color: white;
        }

        .week-dots .dot.current {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }

        /* ===== 徽章墙 ===== */
        .badges-section {
            margin-bottom: 16px;
        }

        .badge-count {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-muted);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            transition: transform 0.2s;
        }

        .badge-item:active {
            transform: scale(0.95);
        }

        .badge-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .badge-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
        }

        .badge-item.owned {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(244, 114, 182, 0.08));
        }

        .badge-item.owned .badge-name {
            color: var(--primary);
        }

        .badge-item.locked {
            opacity: 0.5;
        }

        /* ===== 执行模式 ===== */
        .execution-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .execution-overlay.active {
            display: flex;
        }

        .exec-header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--bg-card);
        }

        .exec-back {
            font-size: 22px;
            padding: 8px;
            margin-right: 8px;
        }

        .exec-title {
            font-size: 17px;
            font-weight: 600;
        }

        .exec-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .exec-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px 24px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-float);
        }

        .exec-step-num {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 16px;
        }

        .exec-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .exec-name {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .exec-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .exec-timer {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: var(--radius-full);
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .exec-encourage {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            max-width: 300px;
            box-shadow: var(--shadow-soft);
        }

        .exec-encourage img {
            width: 44px;
            height: 44px;
            object-fit: contain;
        }

        .exec-encourage-text {
            font-size: 14px;
            text-align: left;
        }

        .exec-complete-btn {
            width: 100%;
            max-width: 260px;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #10B981);
            color: white;
            font-size: 17px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4);
        }

        .exec-progress {
            display: flex;
            gap: 6px;
            margin-top: 20px;
            max-width: 260px;
        }

        .exec-progress-dot {
            flex: 1;
            height: 6px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 3px;
        }

        .exec-progress-dot.done {
            background: var(--accent);
        }

        .exec-progress-dot.current {
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }

        /* ===== V2.0 时间追踪样式 ===== */

        .exec-timer-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', monospace;
        }

        .exec-time-section {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin: 20px 0;
            padding: 16px;
            background: rgba(124, 58, 237, 0.05);
            border-radius: var(--radius-lg);
        }

        .exec-timer-display,
        .exec-estimated-display {
            text-align: center;
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .timer-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: var(--primary);
        }

        .timer-value.timer-estimated {
            color: var(--text-secondary);
            font-size: 24px;
        }

        .timer-value.warning {
            color: var(--warning);
        }

        .timer-value.overtime {
            color: #EF4444;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .time-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(52, 211, 153, 0.1);
            border-radius: var(--radius-full);
            color: var(--accent);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .time-status.paused {
            background: rgba(251, 191, 36, 0.1);
            color: var(--warning);
        }

        .time-status.overtime {
            background: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }

        .time-adjust-hint {
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .time-adjust-hint:hover {
            background: rgba(124, 58, 237, 0.05);
            color: var(--primary);
        }

        .exec-btn-group {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 300px;
        }

        .exec-pause-btn {
            flex: 0 0 auto;
            padding: 16px 20px;
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
            font-size: 15px;
            font-weight: 600;
            border-radius: var(--radius-full);
            transition: all 0.2s;
        }

        .exec-pause-btn:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .exec-pause-btn.paused {
            background: var(--warning);
            color: white;
        }

        /* ===== 庆祝弹窗 ===== */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-gradient);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .celebration-overlay.active {
            display: flex;
        }

        .cel-icon {
            font-size: 72px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .cel-title {
            font-size: 28px;
            font-weight: 700;
            margin: 12px 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .cel-text {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .cel-reward {
            font-size: 42px;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 28px;
        }

        .cel-btn {
            padding: 14px 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 17px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        }

        /* ===== 计划详情弹窗 ===== */
        .plan-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 300;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .plan-detail-overlay.active {
            display: flex;
        }

        .plan-detail-modal {
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            background: var(--bg-gradient);
            border-radius: 24px 24px 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .plan-detail-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
        }

        .back-btn {
            font-size: 20px;
            padding: 8px;
            color: var(--text-primary);
        }

        .plan-detail-title {
            flex: 1;
            text-align: center;
            font-family: 'Fredoka', sans-serif;
            font-size: 17px;
            font-weight: 600;
        }

        .more-btn {
            font-size: 18px;
            padding: 8px;
            color: var(--text-secondary);
        }

        .plan-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* 进度环 */
        .progress-ring-section {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .progress-ring {
            width: 100px;
            height: 100px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .ring-bg {
            fill: none;
            stroke: rgba(124, 58, 237, 0.1);
            stroke-width: 8;
        }

        .ring-fill {
            fill: none;
            stroke: url(#gradient) var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 264;
            transition: stroke-dashoffset 0.5s ease;
        }

        .ring-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .ring-day {
            font-family: 'Fredoka', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .ring-total {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ring-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ring-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ring-stat-icon {
            font-size: 16px;
        }

        .ring-stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
        }

        .ring-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* 通用section标题 */
        .section-heading {
            font-family: 'Fredoka', sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        /* 阶段进度 */
        .phases-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(124, 58, 237, 0.1);
        }

        .phase-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .phase-status {
            font-size: 18px;
        }

        .phase-info {
            flex: 1;
        }

        .phase-name {
            font-weight: 600;
            font-size: 14px;
        }

        .phase-days {
            font-size: 12px;
            color: var(--text-muted);
        }

        .phase-reward {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
        }

        .phase-reward.claimed {
            color: var(--accent);
        }

        .phase-item.done .phase-name {
            color: var(--accent);
        }

        .phase-item.current .phase-name {
            color: var(--primary);
        }

        .phase-item.locked {
            opacity: 0.5;
        }

        /* 本周打卡 */
        .week-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .week-grid {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .day-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .day-status {
            font-size: 18px;
        }

        .week-day.done .day-label {
            color: var(--accent);
        }

        .week-day.current {
            background: rgba(124, 58, 237, 0.1);
            padding: 6px 10px;
            border-radius: 10px;
            margin: -6px -4px;
        }

        .week-day.current .day-label {
            color: var(--primary);
        }

        .week-bonus {
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            padding-top: 8px;
            border-top: 1px dashed rgba(124, 58, 237, 0.1);
        }

        /* 今日任务 */
        .today-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
        }

        .today-task-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .today-task-icon {
            font-size: 28px;
        }

        .today-task-info {
            flex: 1;
        }

        .today-task-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .today-task-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .start-today-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--radius-full);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.35);
        }

        .start-today-btn:hover {
            transform: translateY(-2px);
        }

        /* 操作按钮 */
        .plan-actions {
            display: flex;
            gap: 10px;
            padding: 16px 0;
        }

        .plan-action-btn {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 12px;
            text-align: center;
        }

        .plan-action-btn.pause {
            background: rgba(251, 191, 36, 0.15);
            color: #D97706;
        }

        .plan-action-btn.adjust {
            background: rgba(124, 58, 237, 0.1);
            color: var(--primary);
        }

        .plan-action-btn.quit {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* =========================================
       极简模式 (Minimal Mode) 专属样式
       ========================================= */

        .app-container.minimal-mode {
            background: #f0f4ff;
            overflow: hidden;
            /* 防止全屏滚动，只允许特定区域滚动 */
        }

        /* 沉浸式背景 */
        .immersive-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 30%, #e0e7ff 0%, #f0f4ff 60%, #ffffff 100%);
            z-index: 0;
        }

        /* 顶部功能层 */
        .top-layer {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 0;
            width: 100%;
            height: 60px;
            z-index: 10;
            padding: 0 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            /* 让中间区域透传点击 */
        }

        .corner-btn {
            pointer-events: auto;
            /* 恢复按钮点击 */
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 999px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .corner-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.95);
        }

        .corner-btn .btn-icon {
            font-size: 18px;
        }

        .corner-btn .btn-label {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        .user-avatar-mini img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        /* 场景元素：任务白板 */
        .scene-element.task-board {
            position: absolute;
            top: 100px;
            /* 位于头部下方 */
            right: 20px;
            width: 160px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(4px);
            border-radius: 12px;
            padding: 12px;
            transform: rotate(2deg);
            /* 增加一点场景感 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            z-index: 5;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .task-board:hover {
            transform: rotate(0deg) scale(1.02);
        }

        .board-title {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .board-highlight {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .highlight-icon {
            font-size: 20px;
        }

        .highlight-text {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
        }

        .board-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
        }

        .progress-text {
            font-size: 10px;
            color: #6b7280;
        }

        /* 核心伙伴区 */
        .partner-center-stage {
            position: absolute;
            top: 42%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .partner-figure-large {
            width: 280px;
            /* height: auto; */
            position: relative;
            transition: transform 0.3s ease;
        }

        .partner-figure-large:active {
            transform: scale(0.98);
        }

        .kuqi-img {
            width: 100%;
            height: auto;
            filter: drop-shadow(0 10px 20px rgba(124, 58, 237, 0.2));
        }

        .partner-bubble {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-size: 15px;
            color: #4b5563;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, top 0.3s ease;
        }

        .partner-bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #fff transparent transparent transparent;
        }

        /* 长期任务提醒卡 */
        .long-term-card {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 340px;
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border-radius: 20px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
            z-index: 10;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .long-term-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .long-term-icon {
            font-size: 24px;
        }

        .long-term-title {
            flex: 1;
        }

        .long-term-title h3 {
            font-size: 15px;
            font-weight: 700;
            color: #5b21b6;
            margin: 0;
        }

        .long-term-title .day-badge {
            font-size: 12px;
            color: #7c3aed;
            font-weight: 500;
        }

        .long-term-today {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .long-term-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
            margin-bottom: 14px;
            overflow: hidden;
        }

        .long-term-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .long-term-actions {
            display: flex;
            gap: 10px;
        }

        .long-term-btn {
            flex: 1;
            padding: 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .long-term-btn.secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #6b7280;
        }

        .long-term-btn.primary {
            background: #8b5cf6;
            color: white;
        }

        /* 长期任务详情页 */
        .plan-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f9fafb;
            z-index: 150;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .plan-detail-overlay.active {
            transform: translateX(0);
        }

        .plan-detail-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
        }

        .plan-detail-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .plan-back-btn {
            font-size: 24px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
        }

        .plan-detail-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .plan-stats-card {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            margin: 20px;
            border-radius: 24px;
            padding: 24px;
            color: white;
            text-align: center;
        }

        .plan-day-display {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .plan-progress-circle {
            width: 120px;
            height: 120px;
            margin: 16px auto;
            position: relative;
        }

        .plan-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: 700;
        }

        .plan-streak {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
        }

        .plan-streak-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        .plan-section {
            background: white;
            margin: 16px 20px;
            border-radius: 16px;
            padding: 20px;
        }

        .plan-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .week-check-grid {
            display: flex;
            justify-content: space-between;
        }

        .week-day {
            text-align: center;
        }

        .week-day-label {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .week-day-status {
            font-size: 20px;
        }

        .week-day.today {
            background: #ede9fe;
            border-radius: 12px;
            padding: 8px 4px;
            margin: -8px -4px;
        }

        .phase-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .phase-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .phase-item.completed {
            background: #ecfdf5;
        }

        .phase-item.active {
            background: #ede9fe;
            border: 1px solid #a855f7;
        }

        .phase-item.locked {
            opacity: 0.6;
        }

        .phase-emoji {
            font-size: 24px;
        }

        .phase-info {
            flex: 1;
        }

        .phase-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .phase-days {
            font-size: 12px;
            color: #6b7280;
        }

        .phase-reward {
            font-size: 13px;
            color: #8b5cf6;
            font-weight: 600;
        }

        .today-task-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 20px;
        }

        .today-task-title {
            font-size: 16px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
        }

        .today-task-desc {
            font-size: 14px;
            color: #78350f;
            margin-bottom: 16px;
        }

        .today-task-btn {
            width: 100%;
            padding: 14px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .plan-footer-actions {
            display: flex;
            gap: 12px;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .plan-action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            background: #f3f4f6;
            color: #6b7280;
        }

        .plan-action-btn.danger {
            background: #fef2f2;
            color: #dc2626;
        }


        /* =========================================
           方案 B：Dashboard 布局样式
           ========================================= */

        /* 隐藏旧元素 */
        .long-term-card,
        .task-indicator {
            display: none !important;
        }

        /* 1. 左右浮动卡片 */
        .float-card {
            position: absolute;
            top: 40%;
            /* 位于伙伴两侧 */
            transform: translateY(-50%);
            width: 100px;
            height: 130px;
            border-radius: 20px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            pointer-events: auto;
            transition: transform 0.2s;
            z-index: 10;
        }

        .float-card:active {
            transform: scale(0.95);
        }

        .float-card.left {
            left: 20px;
            background: linear-gradient(145deg, #ede9fe, #ddd6fe);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .float-card.right {
            right: 20px;
            background: linear-gradient(145deg, #fef3c7, #fcd34d);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .float-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .float-title {
            font-size: 11px;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.6);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        /* 左侧进度环容器 */
        .mini-progress-ring {
            width: 44px;
            height: 44px;
            position: relative;
            margin-top: 4px;
        }

        .mini-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 700;
            color: #7c3aed;
        }

        /* 右侧奖励大数字 */
        .reward-big-num {
            font-size: 28px;
            font-weight: 800;
            color: #b45309;
            margin-top: 4px;
            text-shadow: 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .reward-sub {
            font-size: 10px;
            color: #92400e;
        }

        /* 2. 底部横向任务流 */
        .horizontal-task-scroll {
            position: absolute;
            bottom: 110px;
            /* 位于输入框上方 */
            left: 0;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            padding: 20px 24px;
            pointer-events: auto;
            -webkit-overflow-scrolling: touch;
            z-index: 20;
            /* 隐藏滚动条 */
            scrollbar-width: none;
        }

        .horizontal-task-scroll::-webkit-scrollbar {
            display: none;
        }

        .task-square-card {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100px;
            height: 100px;
            border-radius: 20px;
            background: white;
            margin-right: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            vertical-align: top;
            position: relative;
            transition: all 0.2s;
            border: 1px solid #f3f4f6;
        }

        .task-square-card:active {
            transform: scale(0.95);
        }

        .task-square-card.active {
            border-color: #fcd34d;
            background: #fffbeb;
        }

        .task-square-card.done {
            background: #ecfdf5;
            border-color: #d1fae5;
        }

        .sq-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .sq-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
        }

        .sq-status {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 10px;
            background: #f3f4f6;
            color: #6b7280;
        }

        .task-square-card.active .sq-status {
            background: #fef3c7;
            color: #d97706;
        }

        .task-square-card.done .sq-status {
            background: #d1fae5;
            color: #059669;
        }

        /* 调整伙伴位置，稍微上移以适应底部宽阔空间 */
        .partner-center-stage {
            top: 45% !important;
        }

        /* 方案D：Coach 智能提醒气泡 */
        .coach-bubble {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            animation: bubbleFloat 3s ease-in-out infinite;
        }

        @keyframes bubbleFloat {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(-8px);
            }
        }

        .bubble-content {
            background: white;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            min-width: 260px;
            max-width: 320px;
        }

        .bubble-text {
            font-size: 15px;
            color: #374151;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .bubble-text strong {
            color: #8b5cf6;
            font-weight: 600;
        }

        .bubble-actions {
            display: flex;
            gap: 10px;
        }

        .bubble-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .bubble-btn:active {
            transform: scale(0.96);
        }

        .bubble-btn.secondary {
            background: #f3f4f6;
            color: #6b7280;
        }

        .bubble-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .bubble-arrow {
            width: 16px;
            height: 16px;
            background: white;
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.05);
        }

        /* 方案D+B: 伙伴脚下任务指示条 */
        .task-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-top: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .task-indicator:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        .task-indicator:active {
            transform: scale(0.98);
        }

        .indicator-icon {
            font-size: 18px;
        }

        .indicator-text {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .indicator-progress {
            font-size: 14px;
            font-weight: 700;
            color: #8b5cf6;
        }

        .indicator-progress .progress-current {
            font-size: 18px;
        }

        .indicator-progress .progress-total {
            color: #9ca3af;
        }

        .indicator-arrow {
            font-size: 12px;
            color: #9ca3af;
            margin-left: 4px;
        }

        /* 任务指示条-进行中状态 */
        .task-indicator.in-progress {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: #f59e0b;
        }

        .task-indicator.in-progress .indicator-text {
            color: #b45309;
            font-weight: 600;
        }

        .indicator-task-name {
            font-size: 14px;
            font-weight: 600;
            color: #92400e;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 退出确认弹窗 */
        .exit-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .exit-confirm-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .exit-confirm-modal {
            background: white;
            border-radius: 24px;
            padding: 28px 24px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .exit-confirm-overlay.active .exit-confirm-modal {
            transform: scale(1);
        }

        .exit-emoji {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .exit-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .exit-desc {
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .exit-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .exit-btn {
            padding: 14px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .exit-btn:active {
            transform: scale(0.98);
        }

        .exit-btn.primary {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
        }

        .exit-btn.secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .exit-btn.danger {
            background: #fef2f2;
            color: #dc2626;
        }

        /* PlanCoach 风格底部输入区 */
        .chat-input-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(20px);
            z-index: 50;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            background: #f3f4f6;
            border-radius: 28px;
            padding: 6px 6px 6px 20px;
            align-items: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }

        .input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 16px;
            color: #374151;
            outline: none;
        }

        .input-wrapper input::placeholder {
            color: #9ca3af;
        }

        .voice-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
            transition: transform 0.2s;
        }

        .voice-btn:active {
            transform: scale(0.92);
        }

        /* 底部核心交互区 - 不再需要 */
        .bottom-interaction-zone {
            display: none;
        }

        .magic-input-ball {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.4);
            cursor: pointer;
            position: relative;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .magic-input-ball:active {
            transform: scale(0.9);
        }

        .ball-icon {
            font-size: 32px;
            z-index: 2;
        }

        .ball-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(139, 92, 246, 0.5);
            animation: pulse-ring 2s infinite;
            z-index: 1;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }

            100% {
                transform: scale(1.6);
                opacity: 0;
            }
        }

        /* 输入面板浮层 - 全屏覆盖 */
        .input-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .input-panel-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .input-panel-overlay .input-panel-content {
            position: relative;
            background: white;
            padding: 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 12px;
        }

        /* input-panel-content 样式已在上方定义 */

        .minimal-input {
            flex: 1;
            background: #f3f4f6;
            border: none;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            outline: none;
        }

        .minimal-send-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0 20px;
            font-weight: 600;
            font-size: 15px;
        }

        .panel-close {
            position: absolute;
            bottom: 100%;
            right: 20px;
            margin-bottom: 12px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* 任务抽屉背景遮罩 */
        .drawer-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 24;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .drawer-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* 任务抽屉 */
        .task-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 85%;
            background: #fff;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 25;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
        }

        .task-drawer.active {
            transform: translateY(0);
        }

        .drawer-handle {
            width: 100%;
            padding: 16px 0;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .drawer-handle::after {
            content: '';
            width: 40px;
            height: 5px;
            background: #d1d5db;
            border-radius: 3px;
        }

        .drawer-header {
            padding: 10px 24px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-header h2 {
            font-size: 24px;
            margin: 0;
        }

        .date-tag {
            font-size: 14px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .drawer-section {
            padding: 0 20px;
            margin-bottom: 20px;
        }

        .drawer-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        /* 迷你长期计划卡 */
        .plan-mini-card {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .plan-mini-card:active {
            transform: scale(0.98);
        }

        .plan-mini-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .plan-mini-icon {
            font-size: 28px;
        }

        .plan-mini-info {
            flex: 1;
        }

        .plan-mini-name {
            font-size: 15px;
            font-weight: 700;
            color: #5b21b6;
        }

        .plan-mini-day {
            font-size: 12px;
            color: #7c3aed;
        }

        .plan-mini-today {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .plan-mini-progress {
            height: 5px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .plan-mini-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            border-radius: 3px;
        }

        .plan-mini-action {
            text-align: right;
            font-size: 13px;
            font-weight: 600;
            color: #8b5cf6;
        }

        .drawer-list {
            flex: 1;
            overflow-y: auto;
        }

        .task-card-minimal {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #fff;
            border: 1px solid #f3f4f6;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            transition: all 0.2s;
        }

        .task-card-minimal:active {
            transform: scale(0.98);
            background: #f9fafb;
        }

        .task-card-minimal.done {
            opacity: 0.6;
            background: #f9fafb;
        }

        .task-icon {
            width: 44px;
            height: 44px;
            background: #eff6ff;
            color: #3b82f6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 14px;
        }

        .task-card-minimal.done .task-icon {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .task-card-minimal.done .task-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .task-status {
            font-size: 12px;
            color: #6b7280;
        }

        .task-action {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f3f4f6;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .task-card-minimal:not(.done) .task-action {
            background: #ecfdf5;
            color: #10b981;
        }

        /* 任务拆解卡片 (State B) */
        .decomposition-card {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -40%) scale(0.9);
            width: 85%;
            max-width: 340px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .decomposition-card.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            text-align: center;
        }

        .step-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .step-item {
            display: flex;
            align-items: center;
            background: #f9fafb;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid #f3f4f6;
        }

        .step-num {
            width: 24px;
            height: 24px;
            background: #e5e7eb;
            color: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            margin-right: 12px;
        }

        .step-content {
            flex: 1;
        }

        .step-text {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .step-time-tag {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .card-actions {
            display: flex;
            gap: 12px;
        }

        .card-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .card-btn.secondary {
            background: #f3f4f6;
            color: #4b5563;
        }

        .card-btn.primary {
            background: #8b5cf6;
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        /* 状态切换时的过渡辅助类 */
        .fade-out {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* 调整伙伴位置以适应卡片 */
        .partner-center-stage.shift-up {
            transform: translate(-50%, -70%);
        }
    </style>
</head>

<body>
    <div class="app-container minimal-mode">
        <!-- 极简模式背景 -->
        <div class="immersive-bg"></div>

        <!-- 顶部功能区 -->
        <div class="top-layer">
            <!-- 左上角：奖励/商城 -->
            <div class="corner-btn left" onclick="openRewards()">
                <div class="btn-icon">🎁</div>
            </div>

            <!-- 右上角：任务 + 设置 -->
            <div style="position:absolute; top:20px; right:20px; display:flex; gap:16px; z-index:50;">
                <!-- 任务管理入口 -->
                <div class="corner-btn-custom" onclick="openTaskDashboard()"
                    style="width:44px; height:44px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s;">
                    <div class="btn-icon" style="font-size:22px;">📋</div>
                </div>
                <!-- 设置入口 -->
                <div class="corner-btn-custom" onclick="openSettings()"
                    style="width:44px; height:44px; background:white; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:pointer; transition:transform 0.2s;">
                    <div class="btn-icon" style="font-size:22px;">⚙️</div>
                </div>
            </div>
        </div>

        <!-- 长期任务提醒卡 -->
        <div class="long-term-card" id="long-term-card">
            <div class="long-term-header">
                <span class="long-term-icon">📖</span>
                <div class="long-term-title">
                    <h3>30天阅读计划</h3>
                    <span class="day-badge">Day 15/30</span>
                </div>
            </div>
            <div class="long-term-today">今日任务：阅读《哈利波特》第15章</div>
            <div class="long-term-progress">
                <div class="long-term-progress-fill" style="width: 50%"></div>
            </div>
            <div class="long-term-actions">
                <button class="long-term-btn secondary" onclick="showPlanDetail()">查看详情</button>
                <button class="long-term-btn primary" onclick="startLongTermDailyTask()">开始阅读</button>
            </div>
        </div>

        <!-- 核心伙伴区 -->
        <div class="partner-center-stage">
            <div class="partner-figure-large" onclick="interactWithPartner()">
                <!-- 星际小狮子 (Canvas去白底) -->
                <img src="assets/star_lion.png" alt="Star Lion" class="kuqi-img" id="mascot-img"
                    crossorigin="anonymous">
            </div>

            <!-- 脚本注入 -->
            <script>
                (function () {
                    const img = document.getElementById('mascot-img');
                    const process = () => {
                        if (img.dataset.processed) return;
                        try {
                            const cvs = document.createElement('canvas');
                            const ctx = cvs.getContext('2d');
                            cvs.width = img.naturalWidth;
                            cvs.height = img.naturalHeight;
                            ctx.drawImage(img, 0, 0);
                            const imgData = ctx.getImageData(0, 0, cvs.width, cvs.height);
                            const d = imgData.data;
                            for (let i = 0; i < d.length; i += 4) {
                                if (d[i] > 240 && d[i + 1] > 240 && d[i + 2] > 240) d[i + 3] = 0;
                            }
                            ctx.putImageData(imgData, 0, 0);
                            img.src = cvs.toDataURL();
                            img.dataset.processed = 'true';
                            img.style.mixBlendMode = 'normal';
                        } catch (e) { console.error(e); }
                    };
                    if (img.complete) process();
                    else img.onload = process;
                })();
            </script>
        </div>

        <!-- 气泡已移除 -->

        <!-- 任务指示条已移除（CSS hidden） -->
    </div>

    <!-- 方案 B：Dashboard 交互层 -->
    <div class="dashboard-interactive-layer">
        <!-- 左侧长期计划卡 -->
        <div class="float-card left" id="float-long-term" onclick="showPlanDetail()">
            <div class="float-title">30天阅读计划</div>
            <div class="float-icon">📖</div>
            <!-- 进度环 -->
            <div class="mini-progress-ring">
                <svg width="44" height="44" viewBox="0 0 44 44">
                    <circle cx="22" cy="22" r="18" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="4" />
                    <circle id="mini-ring" cx="22" cy="22" r="18" fill="none" stroke="#7c3aed" stroke-width="4"
                        stroke-dasharray="113" stroke-dashoffset="56" transform="rotate(-90 22 22)"
                        stroke-linecap="round" />
                </svg>
                <div class="mini-ring-text" id="mini-ring-text">50%</div>
            </div>
            <div class="float-title" style="margin-top:4px; font-weight:400">Day 15</div>
        </div>

        <!-- 右侧奖励卡 -->
        <div class="float-card right" onclick="openRewards()">
            <div class="float-title">今日奖励</div>
            <div class="float-icon" style="color:#fbbf24; text-shadow:0 2px 4px rgba(251,191,36,0.5)">🌟</div>
            <div class="reward-big-num" id="reward-big-num">+150</div>
            <div class="reward-sub">已获得</div>
        </div>

        <!-- 底部横向任务流 -->
        <div class="horizontal-task-scroll" id="horizontal-task-list">
            <!-- 动态生成任务卡片 -->
        </div>
    </div>

    <!-- 底部对话式输入区 (PlanCoach 风格) -->
    <div class="chat-input-bar">
        <div class="input-wrapper">
            <input type="text" id="chat-input-field" placeholder="告诉酷奇你想做什么..." onclick="focusChatInput()">
            <button class="voice-btn" onclick="startVoiceInput()">🎙️</button>
        </div>
    </div>

    <!-- 任务拆解卡片 (默认隐藏，State B显示) -->
    <div class="decomposition-card" id="decomposition-card">
        <!-- 内容将由JS动态生成 -->
        <div class="card-title">任务准备中...</div>
        <div class="step-list">
            <!-- steps -->
        </div>
        <div class="card-actions">
            <button class="card-btn secondary" onclick="cancelDecomposition()">取消</button>
            <button class="card-btn primary" onclick="confirmDecomposition()">开始行动！</button>
        </div>
    </div>

    <!-- 底部核心交互区 -->
    <div class="bottom-interaction-zone">
        <!-- 极简输入球 -->
        <div class="magic-input-ball" id="magic-ball" onclick="activateInput()">
            <div class="ball-icon">🎙️</div>
            <div class="ball-pulse"></div>
        </div>
    </div>

    <!-- 隐藏的输入面板 (激活时显示) -->
    <div class="input-panel-overlay" id="input-panel" onclick="closeInput()">
        <div class="input-panel-content" onclick="event.stopPropagation()">
            <div class="panel-close" onclick="closeInput()">×</div>
            <input type="text" class="minimal-input" id="minimal-input" placeholder="告诉酷奇你想做什么...">
            <button class="minimal-send-btn" onclick="handleMinimalInput()">发送</button>
        </div>
    </div>

    <!-- 任务抽屉背景遮罩 -->
    <div class="drawer-backdrop" id="drawer-backdrop" onclick="toggleTaskDrawer()"></div>

    <!-- 任务抽屉 (代替原任务页) -->
    <div class="task-drawer" id="task-drawer">
        <div class="drawer-handle" onclick="toggleTaskDrawer()"></div>
        <div class="drawer-header">
            <h2>今日计划</h2>
            <span class="date-tag">1月15日 周四</span>
        </div>

        <!-- 长期计划分区 -->
        <div class="drawer-section" id="drawer-long-term-section">
            <div class="drawer-section-title">📆 长期计划进行中</div>
            <div class="plan-mini-card" onclick="showPlanDetail()">
                <div class="plan-mini-header">
                    <span class="plan-mini-icon">📖</span>
                    <div class="plan-mini-info">
                        <div class="plan-mini-name">30天阅读计划</div>
                        <div class="plan-mini-day">Day 15/30</div>
                    </div>
                </div>
                <div class="plan-mini-today">今日：阅读第15章（约30分钟）</div>
                <div class="plan-mini-progress">
                    <div class="plan-mini-progress-fill" style="width: 50%"></div>
                </div>
                <div class="plan-mini-action" onclick="event.stopPropagation(); startLongTermDailyTask()">开始 →</div>
            </div>
        </div>

        <!-- 即时任务分区 -->
        <div class="drawer-section">
            <div class="drawer-section-title">📋 今日任务</div>
            <div class="drawer-list" id="drawer-task-list">
                <!-- 任务列表将动态注入这里 -->
            </div>
        </div>
    </div>

    </div>


    <!-- 长期任务详情页 -->
    <div class="plan-detail-overlay" id="plan-detail-overlay">
        <header class="plan-detail-header">
            <button class="plan-back-btn" onclick="closePlanDetail()">←</button>
            <span class="plan-detail-title" id="plan-detail-title">📖 30天阅读计划</span>
        </header>

        <div class="plan-detail-content">
            <!-- 进度统计卡 -->
            <div class="plan-stats-card">
                <div class="plan-day-display" id="plan-day-display">Day 15/30</div>
                <div class="plan-progress-circle">
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="10" />
                        <circle id="plan-progress-ring" cx="60" cy="60" r="50" fill="none" stroke="white"
                            stroke-width="10" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="157"
                            transform="rotate(-90 60 60)" />
                    </svg>
                    <div class="plan-progress-text" id="plan-progress-percent">50%</div>
                </div>
                <div class="plan-streak">
                    <span class="plan-streak-badge">🌟 已获得 150</span>
                    <span class="plan-streak-badge">🔥 连续 5天</span>
                </div>
            </div>

            <!-- 本周打卡 -->
            <div class="plan-section">
                <div class="plan-section-title">📆 本周打卡</div>
                <div class="week-check-grid" id="week-check-grid">
                    <div class="week-day">
                        <div class="week-day-label">一</div>
                        <div class="week-day-status">✅</div>
                    </div>
                    <div class="week-day">
                        <div class="week-day-label">二</div>
                        <div class="week-day-status">✅</div>
                    </div>
                    <div class="week-day">
                        <div class="week-day-label">三</div>
                        <div class="week-day-status">✅</div>
                    </div>
                    <div class="week-day today">
                        <div class="week-day-label">四</div>
                        <div class="week-day-status">🔵</div>
                    </div>
                    <div class="week-day">
                        <div class="week-day-label">五</div>
                        <div class="week-day-status">⭕</div>
                    </div>
                    <div class="week-day">
                        <div class="week-day-label">六</div>
                        <div class="week-day-status">⭕</div>
                    </div>
                    <div class="week-day">
                        <div class="week-day-label">日</div>
                        <div class="week-day-status">⭕</div>
                    </div>
                </div>
            </div>

            <!-- 阶段进度 -->
            <div class="plan-section">
                <div class="plan-section-title">📈 阶段进度</div>
                <div class="phase-list" id="phase-list">
                    <div class="phase-item completed">
                        <span class="phase-emoji">🌱</span>
                        <div class="phase-info">
                            <div class="phase-name">阶段1：入门期</div>
                            <div class="phase-days">Day 1-10</div>
                        </div>
                        <span class="phase-reward">🌟+50 已领取</span>
                    </div>
                    <div class="phase-item active">
                        <span class="phase-emoji">📈</span>
                        <div class="phase-info">
                            <div class="phase-name">阶段2：成长期</div>
                            <div class="phase-days">Day 11-20</div>
                        </div>
                        <span class="phase-reward">🌟+80</span>
                    </div>
                    <div class="phase-item locked">
                        <span class="phase-emoji">🔒</span>
                        <div class="phase-info">
                            <div class="phase-name">阶段3：冲刺期</div>
                            <div class="phase-days">Day 21-30</div>
                        </div>
                        <span class="phase-reward">🌟+100</span>
                    </div>
                </div>
            </div>

            <!-- 今日任务 -->
            <div class="today-task-card">
                <div class="today-task-title">📕 今日任务</div>
                <div class="today-task-desc">阅读第15章（约30分钟）<br>🌟 完成奖励：+8</div>
                <button class="today-task-btn" onclick="startLongTermDailyTask()">开始今日任务</button>
            </div>

            <!-- 底部操作 -->
            <div class="plan-footer-actions">
                <button class="plan-action-btn" onclick="pausePlan()">暂停计划</button>
                <button class="plan-action-btn" onclick="adjustPlan()">调整计划</button>
                <button class="plan-action-btn danger" onclick="showAbandonPlanConfirm()">放弃计划</button>
            </div>
        </div>
    </div>

    <!-- 退出确认弹窗 -->
    <div class="exit-confirm-overlay" id="exit-confirm-overlay">
        <div class="exit-confirm-modal">
            <div class="exit-emoji">🥺</div>
            <div class="exit-title">要离开一下吗？</div>
            <div class="exit-desc" id="exit-confirm-desc">
                当前任务的进度会保存哦~<br>下次回来可以继续！
            </div>
            <div class="exit-actions">
                <button class="exit-btn primary" onclick="confirmPause()">保存进度，待会继续</button>
                <button class="exit-btn secondary" onclick="confirmComplete()">我已经完成了！</button>
                <button class="exit-btn danger" onclick="confirmAbandon()">放弃这个任务</button>
            </div>
        </div>
    </div>

    <!-- 执行模式 - V2.0 时间追踪版 -->
    <div class="execution-overlay" id="exec-overlay">
        <header class="exec-header">
            <button class="exec-back" onclick="exitExec()">←</button>
            <span class="exec-title">正在进行中</span>
            <span class="exec-timer-badge" id="exec-timer-mini">00:00</span>
        </header>
        <div class="exec-body">
            <div class="exec-card">
                <div class="exec-step-num" id="exec-step-num">步骤 1 / 4</div>
                <div class="exec-icon" id="exec-icon">🛏️</div>
                <div class="exec-name" id="exec-name">铺好床铺</div>
                <div class="exec-desc" id="exec-desc">把被子叠整齐，枕头放好~</div>

                <!-- V2.0 时间追踪区域 -->
                <div class="exec-time-section">
                    <div class="exec-timer-display">
                        <div class="timer-label">已用时间</div>
                        <div class="timer-value" id="exec-timer">00:00</div>
                    </div>
                    <div class="exec-estimated-display">
                        <div class="timer-label">预估时间</div>
                        <div class="timer-value timer-estimated" id="exec-estimated">05:00</div>
                    </div>
                </div>

                <!-- 时间状态指示 -->
                <div class="time-status" id="time-status">
                    <span class="time-status-icon">⏱️</span>
                    <span class="time-status-text" id="time-status-text">正在计时...</span>
                </div>

                <!-- 时间调整入口 -->
                <div class="time-adjust-hint" id="time-adjust-hint" onclick="showStepTimeAdjust()">
                    💡 时间不够？点这里调整
                </div>
            </div>

            <div class="exec-encourage">
                <img src="assets/partner_kuqi.png" alt="">
                <div class="exec-encourage-text">加油！你一定可以的！<br>完成后点下面的按钮~</div>
            </div>

            <!-- 操作按钮 -->
            <div class="exec-btn-group">
                <button class="exec-pause-btn" id="exec-pause-btn" onclick="togglePause()">⏸️ 暂停</button>
                <button class="exec-complete-btn" onclick="completeStep()">✅ 我完成了！</button>
            </div>

            <div class="exec-progress" id="exec-progress">
                <div class="exec-progress-dot current"></div>
                <div class="exec-progress-dot"></div>
                <div class="exec-progress-dot"></div>
                <div class="exec-progress-dot"></div>
            </div>
        </div>
    </div>

    <!-- 庆祝弹窗 -->
    <div class="celebration-overlay" id="cel-overlay">
        <div>
            <div class="cel-icon">🎉</div>
            <div class="cel-title">太棒了！</div>
            <div class="cel-text" id="cel-text">你完成了「铺好床铺」</div>
            <div class="cel-reward" id="cel-reward">+5 🌟</div>
            <button class="cel-btn" onclick="continueAfterCel()">继续下一步 →</button>
        </div>
    </div>

    <!-- 家长中心 -->
    <div class="parent-center-overlay" id="parent-center-overlay">
        <header class="parent-center-header">
            <span class="parent-center-close" onclick="closeParentCenter()">←</span>
            <span class="parent-center-title">👨‍👩‍👧 家长中心</span>
            <span style="width: 36px;"></span>
        </header>
        <div class="parent-center-body">
            <!-- 功能入口 -->
            <div class="parent-menu-grid">
                <div class="parent-menu-item" onclick="showParentTaskManage()">
                    <div class="parent-menu-icon">📋</div>
                    <div class="parent-menu-label">任务管理</div>
                    <div class="parent-menu-desc">发布和查看任务</div>
                </div>
                <div class="parent-menu-item" onclick="showParentWishManage()">
                    <div class="parent-menu-icon">🎁</div>
                    <div class="parent-menu-label">心愿审批</div>
                    <div class="parent-menu-desc">审批心愿兑换</div>
                </div>
                <div class="parent-menu-item" onclick="showParentReport()">
                    <div class="parent-menu-icon">📊</div>
                    <div class="parent-menu-label">成长报告</div>
                    <div class="parent-menu-desc">查看完成情况</div>
                </div>
                <div class="parent-menu-item" onclick="showParentRewardSetting()">
                    <div class="parent-menu-icon">⚙️</div>
                    <div class="parent-menu-label">奖励设置</div>
                    <div class="parent-menu-desc">自定义奖励规则</div>
                </div>
            </div>

            <!-- 任务管理区 -->
            <div class="task-manage-section" id="task-manage-section">
                <div class="section-header">
                    <h3>📋 已发布的任务</h3>
                    <button class="add-task-btn" onclick="showCreateTaskModal()">+ 发布任务</button>
                </div>
                <div class="parent-task-list" id="parent-task-list">
                    <!-- 动态生成任务列表 -->
                </div>
            </div>

            <!-- 快速发布区 -->
            <div class="task-manage-section">
                <div class="section-header">
                    <h3>⚡ 快速发布</h3>
                </div>
                <div class="quick-task-tags">
                    <span class="quick-task-tag" onclick="quickCreateTask('完成今天的作业')">📝 完成作业</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('练琴30分钟')">🎹 练琴</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('阅读30分钟')">📖 阅读</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('整理房间')">🛏️ 整理房间</span>
                    <span class="quick-task-tag" onclick="quickCreateTask('运动锻炼')">💪 运动</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 发布任务弹窗 -->
    <div class="create-task-modal" id="create-task-modal">
        <div class="create-task-content">
            <div class="create-task-header">
                <h3>📝 发布新任务</h3>
                <span class="create-task-close" onclick="closeCreateTaskModal()">×</span>
            </div>
            <div class="create-task-form">
                <div class="form-group">
                    <label class="form-label">任务内容</label>
                    <input type="text" class="form-input" id="new-task-title" placeholder="例如：完成数学作业">
                </div>
                <div class="form-group">
                    <label class="form-label">截止时间</label>
                    <select class="form-select" id="new-task-deadline">
                        <option value="">不限时间</option>
                        <option value="18:00">今天 18:00 前</option>
                        <option value="19:00">今天 19:00 前</option>
                        <option value="20:00">今天 20:00 前</option>
                        <option value="21:00">今天 21:00 前</option>
                        <option value="tomorrow">明天完成</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">心愿币奖励</label>
                    <div class="reward-slider">
                        <input type="range" id="new-task-reward" min="5" max="50" value="20"
                            oninput="updateRewardDisplay()">
                        <span class="reward-value" id="reward-display">💎 20</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">发布者</label>
                    <select class="form-select" id="new-task-from">
                        <option value="妈妈">妈妈</option>
                        <option value="爸爸">爸爸</option>
                        <option value="奶奶">奶奶</option>
                        <option value="爷爷">爷爷</option>
                    </select>
                </div>
                <button class="submit-task-btn" onclick="submitNewTask()">📤 发布任务</button>
            </div>
        </div>
    </div>

    <!-- AI拆解预览弹窗 -->
    <div class="create-task-modal" id="ai-decompose-modal">
        <div class="create-task-content" style="max-width: 420px;">
            <div class="create-task-header">
                <h3>🤖 AI智能拆解预览</h3>
                <span class="create-task-close" onclick="closeDecomposeModal()">×</span>
            </div>
            <div class="create-task-form" id="decompose-content">
                <!-- 动态生成拆解内容 -->
            </div>
        </div>
    </div>

    <!-- 家长验证弹窗 -->
    <div class="create-task-modal" id="parent-verify-modal">
        <div class="create-task-content" style="max-width: 320px;">
            <div class="create-task-header">
                <h3>🔐 家长验证</h3>
                <span class="create-task-close" onclick="closeParentVerifyModal()">×</span>
            </div>
            <div class="create-task-form">
                <p style="text-align:center;color:var(--text-secondary);margin-bottom:16px;">请计算以下算式，验证家长身份</p>
                <div style="text-align:center;font-size:24px;font-weight:700;color:var(--primary);margin-bottom:16px;"
                    id="verify-question-text">15 × 8 = ?</div>
                <div class="form-group">
                    <input type="number" class="form-input" id="verify-input" placeholder="请输入答案"
                        style="text-align:center;font-size:18px;">
                </div>
                <button class="submit-task-btn" onclick="verifyParentAnswer()">确认验证</button>
                <p id="verify-error" style="color:#EF4444;text-align:center;margin-top:12px;display:none;">答案不正确，请重试~
                </p>
            </div>
        </div>
    </div>

    <!-- 家长确认任务完成弹窗 -->
    <div class="modal" id="parent-confirm-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: var(--bg-card); width: 90%; max-width: 340px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">

            <!-- 阶段1: 孩子提交等待 -->
            <div id="child-waiting-view" style="padding: 32px 24px; text-align: center;">
                <div style="font-size: 64px; margin-bottom: 24px; animation: bounce 2s infinite;">📱</div>
                <h3 style="font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 12px;">任务已提交</h3>
                <p style="font-size: 15px; color: var(--text-muted); line-height: 1.6; margin-bottom: 32px;">
                    太棒啦！🎉<br>请把手机交给爸爸/妈妈<br>确认你的任务完成情况哦
                </p>
                <button class="primary-btn" onclick="switchToParentCheck()"
                    style="width: 100%; padding: 14px; font-size: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);">
                    我是家长，开始验收
                </button>
            </div>

            <!-- 阶段2: 家长验收 -->
            <div id="parent-checking-view" style="display: none; padding: 24px;">
                <div
                    style="text-align: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--text-main);">任务验收</h3>
                </div>

                <div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 6px;">任务名称</div>
                    <div id="confirm-task-title" style="font-size: 20px; font-weight: 700; color: var(--text-main);">
                        整理书房</div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <div
                        style="background: rgba(124, 58, 237, 0.1); padding: 12px; border-radius: 12px; flex: 1; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">实际用时</div>
                        <div id="confirm-task-time" style="font-size: 16px; font-weight: 700; color: var(--primary);">
                            25分钟</div>
                    </div>
                    <div
                        style="background: rgba(14, 165, 233, 0.1); padding: 12px; border-radius: 12px; flex: 1; text-align: center;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">奖励内容</div>
                        <div style="font-size: 16px; font-weight: 700; color: #0EA5E9;">💎 <span
                                id="confirm-task-reward">50</span></div>
                    </div>
                </div>

                <div style="margin-bottom: 24px;">
                    <label
                        style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">给孩子的鼓励（选填）</label>
                    <textarea id="parent-feedback" placeholder="做得真棒！继续加油！"
                        style="width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border-color); border-radius: 12px; resize: none; font-size: 14px; background: var(--bg-main); color: var(--text-main); font-family: inherit;"></textarea>
                </div>

                <div style="display: flex; gap: 12px;">
                    <button class="secondary-btn" onclick="closeConfirmModal()"
                        style="flex: 1; padding: 12px; background: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-muted); border-radius: 12px;">暂不确认</button>
                    <button class="primary-btn" onclick="confirmTaskCompletion()"
                        style="flex: 1.5; padding: 12px; background: linear-gradient(135deg, #0EA5E9 0%, #3B82F6 100%); color: white; border: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);">确认并发放</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 计划详情弹窗 -->
    <div class="plan-detail-overlay" id="plan-detail-overlay">
        <div class="plan-detail-modal">
            <header class="plan-detail-header">
                <button class="back-btn" onclick="closePlanDetail()">←</button>
                <span class="plan-detail-title" id="plan-detail-title">📖 30天阅读计划</span>
                <button class="more-btn">⋯</button>
            </header>

            <div class="plan-detail-body">
                <!-- 进度环 -->
                <div class="progress-ring-section">
                    <div class="progress-ring">
                        <svg viewBox="0 0 100 100">
                            <circle class="ring-bg" cx="50" cy="50" r="42" />
                            <circle class="ring-fill" cx="50" cy="50" r="42" style="stroke-dashoffset: 158;" />
                        </svg>
                        <div class="ring-content">
                            <span class="ring-day" id="ring-day">Day 12</span>
                            <span class="ring-total">/ 30天</span>
                        </div>
                    </div>
                    <div class="ring-stats">
                        <div class="ring-stat">
                            <span class="ring-stat-icon">🔥</span>
                            <span class="ring-stat-value" id="ring-streak">12</span>
                            <span class="ring-stat-label">连续天数</span>
                        </div>
                        <div class="ring-stat">
                            <span class="ring-stat-icon">🌟</span>
                            <span class="ring-stat-value" id="ring-stars">95</span>
                            <span class="ring-stat-label">已获得</span>
                        </div>
                        <div class="ring-stat">
                            <span class="ring-stat-icon">💎</span>
                            <span class="ring-stat-value">10</span>
                            <span class="ring-stat-label">最终奖励</span>
                        </div>
                    </div>
                </div>

                <!-- 阶段进度 -->
                <div class="phases-section">
                    <h3 class="section-heading">📊 阶段进度</h3>
                    <div class="phase-item done">
                        <div class="phase-status">✅</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段1：入门期</div>
                            <div class="phase-days">Day 1-10</div>
                        </div>
                        <div class="phase-reward claimed">🌟+50 已领取</div>
                    </div>
                    <div class="phase-item current">
                        <div class="phase-status">🔵</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段2：成长期</div>
                            <div class="phase-days">Day 11-20</div>
                        </div>
                        <div class="phase-reward">🌟+80</div>
                    </div>
                    <div class="phase-item locked">
                        <div class="phase-status">🔒</div>
                        <div class="phase-info">
                            <div class="phase-name">阶段3：冲刺期</div>
                            <div class="phase-days">Day 21-30</div>
                        </div>
                        <div class="phase-reward">🌟+100</div>
                    </div>
                </div>

                <!-- 本周打卡 -->
                <div class="week-section">
                    <h3 class="section-heading">📆 本周打卡</h3>
                    <div class="week-grid">
                        <div class="week-day done">
                            <span class="day-label">一</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day done">
                            <span class="day-label">二</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day done">
                            <span class="day-label">三</span>
                            <span class="day-status">✅</span>
                        </div>
                        <div class="week-day current">
                            <span class="day-label">四</span>
                            <span class="day-status">🔵</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">五</span>
                            <span class="day-status">⭕</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">六</span>
                            <span class="day-status">⭕</span>
                        </div>
                        <div class="week-day">
                            <span class="day-label">日</span>
                            <span class="day-status">⭕</span>
                        </div>
                    </div>
                    <div class="week-bonus">本周全勤额外奖励：🌟+15</div>
                </div>

                <!-- 今日任务 -->
                <div class="today-section">
                    <h3 class="section-heading">📌 今日任务</h3>
                    <div class="today-task-card">
                        <div class="today-task-icon">📕</div>
                        <div class="today-task-info">
                            <div class="today-task-name">阅读《哈利波特》第12章</div>
                            <div class="today-task-meta">⏱️ 预计30分钟 · 🌟+8</div>
                        </div>
                    </div>
                    <button class="start-today-btn" onclick="startPlanDailyTask('reading')">🚀 开始今日任务</button>
                </div>

                <!-- 操作按钮 -->
                <div class="plan-actions">
                    <button class="plan-action-btn pause" onclick="pausePlan()">⏸️ 暂停计划</button>
                    <button class="plan-action-btn adjust" onclick="adjustPlan()">✏️ 调整计划</button>
                    <button class="plan-action-btn quit" onclick="quitPlan()">🚪 放弃计划</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 通用信息模态框 -->
    <div class="info-modal-overlay" id="info-modal-overlay" onclick="closeInfoModal()">
        <div class="info-modal" onclick="event.stopPropagation()">
            <div class="info-modal-icon" id="info-modal-icon">🌟</div>
            <h3 class="info-modal-title" id="info-modal-title">标题</h3>
            <div class="info-modal-content" id="info-modal-content">内容</div>
            <button class="info-modal-btn" onclick="closeInfoModal()">知道了</button>
        </div>
    </div>

    <!-- 徽章详情模态框 -->
    <div class="badge-modal-overlay" id="badge-modal-overlay" onclick="closeBadgeModal()">
        <div class="badge-modal" onclick="event.stopPropagation()">
            <div class="badge-modal-icon" id="badge-modal-icon">🏅</div>
            <h3 class="badge-modal-name" id="badge-modal-name">徽章名称</h3>
            <div class="badge-modal-status" id="badge-modal-status">
                <span class="status-tag owned">已获得</span>
            </div>
            <div class="badge-modal-desc" id="badge-modal-desc">徽章描述</div>
            <div class="badge-modal-date" id="badge-modal-date">获得时间：2026-01-01</div>
            <div class="badge-modal-progress" id="badge-modal-progress" style="display:none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="badge-progress-fill"></div>
                </div>
                <span class="progress-text" id="badge-progress-text">7/30</span>
            </div>
            <button class="badge-modal-btn" onclick="closeBadgeModal()">关闭</button>
        </div>
    </div>

    <!-- 付费墙模态框 -->
    <div class="paywall-overlay" id="paywall-overlay" onclick="closePaywall()">
        <div class="paywall-modal" onclick="event.stopPropagation()">
            <!-- 顶部装饰 -->
            <div class="paywall-header">
                <div class="paywall-close" onclick="closePaywall()">×</div>
                <div class="paywall-badge">✨</div>
                <h2 class="paywall-title">星伴会员</h2>
                <p class="paywall-subtitle">解锁完整体验，陪伴孩子成长</p>
            </div>

            <!-- 特权列表 -->
            <div class="paywall-benefits">
                <div class="benefit-item">
                    <span class="benefit-icon">🔮</span>
                    <span class="benefit-text">AI规划无限次</span>
                    <span class="benefit-tag free">免费2次/天</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📋</span>
                    <span class="benefit-text">长期目标完整规划</span>
                    <span class="benefit-tag free">仅阶段1</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">🦁</span>
                    <span class="benefit-text">伙伴进化至传说期</span>
                    <span class="benefit-tag free">最高Lv.3</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">✨</span>
                    <span class="benefit-text">专属特效&装饰槽位</span>
                    <span class="benefit-tag vip">VIP专享</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📊</span>
                    <span class="benefit-text">家长AI报告无限查看</span>
                    <span class="benefit-tag free">限2次</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">📝</span>
                    <span class="benefit-text">家长任务无限发布</span>
                    <span class="benefit-tag free">3个/天</span>
                </div>
            </div>

            <!-- 套餐选择 -->
            <div class="paywall-plans">
                <div class="plan-card" id="plan-monthly" onclick="selectPlan('monthly')">
                    <div class="plan-badge">推荐</div>
                    <div class="plan-name">月度会员</div>
                    <div class="plan-price">
                        <span class="price-currency">¥</span>
                        <span class="price-amount">9.9</span>
                        <span class="price-unit">/月</span>
                    </div>
                    <div class="plan-desc">自动续费，可随时取消</div>
                </div>
                <div class="plan-card selected" id="plan-lifetime" onclick="selectPlan('lifetime')">
                    <div class="plan-badge hot">最划算</div>
                    <div class="plan-name">终身会员</div>
                    <div class="plan-price">
                        <span class="price-currency">¥</span>
                        <span class="price-amount">99</span>
                        <span class="price-unit">永久</span>
                    </div>
                    <div class="plan-desc">一次付费，终身使用</div>
                    <div class="plan-save">省 ¥20/年</div>
                </div>
            </div>


            <!-- 购买按钮 -->
            <button class="paywall-buy-btn" onclick="startPayment()">
                <span id="buy-btn-text">立即开通 ¥99</span>
            </button>
            <p class="paywall-terms">点击即同意《用户协议》和《隐私政策》</p>
        </div>
    </div>

    <!-- 验证模态框（防止儿童误购） -->
    <div class="verify-overlay" id="verify-overlay">
        <div class="verify-modal">
            <div class="verify-title">👨‍👩‍👧 家长验证</div>
            <p class="verify-desc">为防止儿童误操作，请回答以下问题：</p>
            <div class="verify-question" id="verify-question">12 × 7 + 15 = ?</div>
            <input type="number" class="verify-input" id="verify-input" placeholder="请输入答案">
            <div class="verify-buttons">
                <button class="verify-btn cancel" onclick="closeVerify()">取消</button>
                <button class="verify-btn confirm" onclick="checkVerifyAnswer()">确认</button>
            </div>
            <p class="verify-error" id="verify-error" style="display:none;">答案不正确，请重试</p>
        </div>
    </div>

    <!-- 支付成功模态框 -->
    <div class="payment-success-overlay" id="payment-success-overlay">
        <div class="payment-success-modal">
            <div class="success-icon">🎉</div>
            <h3 class="success-title">开通成功！</h3>
            <p class="success-desc">恭喜你成为星伴会员</p>
            <div class="success-benefits">
                <div>✓ 已解锁全部VIP特权</div>
                <div>✓ 酷奇可以进化到传说期了</div>
                <div>✓ 现在就去体验完整功能吧！</div>
            </div>
            <button class="success-btn" onclick="closePaymentSuccess()">开始探索</button>
        </div>
    </div>

    <!-- 顶部菜单 -->
    <div class="header-menu-overlay" id="header-menu-overlay" onclick="closeHeaderMenu()">
        <div class="header-menu" onclick="event.stopPropagation()">
            <div class="menu-header">
                <span>设置</span>
                <button class="menu-close" onclick="closeHeaderMenu()">×</button>
            </div>
            <div class="menu-options">
                <div class="menu-option" onclick="switchChild()">
                    <span class="option-icon">👦</span>
                    <span class="option-text">切换孩子</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showNotifySettings()">
                    <span class="option-icon">🔔</span>
                    <span class="option-text">通知设置</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showSoundSettings()">
                    <span class="option-icon">🔊</span>
                    <span class="option-text">音效设置</span>
                    <span class="option-arrow">›</span>
                </div>
                <div class="menu-option" onclick="showAbout()">
                    <span class="option-icon">ℹ️</span>
                    <span class="option-text">关于星伴</span>
                    <span class="option-arrow">›</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 星星详情弹窗 -->
    <div class="currency-detail-overlay" id="star-detail-overlay" onclick="closeStarDetail()">
        <div class="currency-detail-modal" onclick="event.stopPropagation()">
            <div class="currency-header star">
                <span class="currency-icon">🌟</span>
                <span class="currency-name">星星币</span>
            </div>
            <div class="currency-balance">
                <span class="balance-label">当前余额</span>
                <span class="balance-amount" id="star-balance">128</span>
            </div>
            <div class="currency-history">
                <div class="history-title">最近获得</div>
                <div class="history-item">
                    <span class="history-desc">完成"整理书桌"</span>
                    <span class="history-amount">+15 🌟</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"阅读20分钟"</span>
                    <span class="history-amount">+10 🌟</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">连续签到奖励</span>
                    <span class="history-amount">+20 🌟</span>
                </div>
            </div>
            <div class="currency-tip">完成任务获得星星，可在商城兑换装扮！</div>
            <button class="currency-btn" onclick="goToShop();closeStarDetail()">去商城逛逛</button>
        </div>
    </div>

    <!-- 心愿币详情弹窗 -->
    <div class="currency-detail-overlay" id="diamond-detail-overlay" onclick="closeDiamondDetail()">
        <div class="currency-detail-modal" onclick="event.stopPropagation()">
            <div class="currency-header diamond">
                <span class="currency-icon">💎</span>
                <span class="currency-name">心愿币</span>
            </div>
            <div class="currency-balance">
                <span class="balance-label">当前余额</span>
                <span class="balance-amount diamond" id="diamond-balance">45</span>
            </div>
            <div class="currency-history">
                <div class="history-title">最近获得</div>
                <div class="history-item">
                    <span class="history-desc">完成"洗碗"(家长任务)</span>
                    <span class="history-amount">+10 💎</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"扫地"(家长任务)</span>
                    <span class="history-amount">+15 💎</span>
                </div>
                <div class="history-item">
                    <span class="history-desc">完成"遛狗"(家长任务)</span>
                    <span class="history-amount">+20 💎</span>
                </div>
            </div>
            <div class="currency-tip">完成家长任务获得心愿币，可兑换心愿奖励！</div>
            <button class="currency-btn diamond" onclick="goToWish();closeDiamondDetail()">查看心愿商城</button>
        </div>
    </div>

    <!-- 全部徽章页面 -->
    <div class="all-badges-overlay" id="all-badges-overlay">
        <div class="all-badges-page">
            <div class="all-badges-header">
                <button class="back-btn" onclick="closeAllBadges()">←</button>
                <h2>🏅 全部徽章</h2>
                <span class="badges-progress">6/24</span>
            </div>
            <div class="all-badges-content">
                <!-- 成就类 -->
                <div class="badge-category">
                    <div class="category-title">🌟 成就徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('star100')">
                            <div class="full-badge-icon">⭐</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">首个100星</span>
                                <span class="full-badge-desc">累计获得100颗星星</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('star500')">
                            <div class="full-badge-icon">🌟</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">星星收藏家</span>
                                <span class="full-badge-desc">累计获得500颗星星</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:26%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('star1000')">
                            <div class="full-badge-icon">💫</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">星星大师</span>
                                <span class="full-badge-desc">累计获得1000颗星星</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:13%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                    </div>
                </div>
                <!-- 坚持类 -->
                <div class="badge-category">
                    <div class="category-title">🔥 坚持徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('streak7')">
                            <div class="full-badge-icon">🔥</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">7天连续</span>
                                <span class="full-badge-desc">连续7天完成每日任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('streak30')">
                            <div class="full-badge-icon">🏆</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">30天连续</span>
                                <span class="full-badge-desc">连续30天完成每日任务</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:23%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('earlybird')">
                            <div class="full-badge-icon">🌅</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">早起鸟</span>
                                <span class="full-badge-desc">连续7天在8点前开始任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                    </div>
                </div>
                <!-- 技能类 -->
                <div class="badge-category">
                    <div class="category-title">📚 技能徽章</div>
                    <div class="category-badges">
                        <div class="full-badge-item owned" onclick="showBadgeDetail('bookworm')">
                            <div class="full-badge-icon">📚</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">书虫</span>
                                <span class="full-badge-desc">累计阅读时长达到10小时</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item locked" onclick="showBadgeDetail('readmaster')">
                            <div class="full-badge-icon">📖</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">阅读大师</span>
                                <span class="full-badge-desc">累计阅读时长达到100小时</span>
                                <div class="mini-progress">
                                    <div class="mini-fill" style="width:12%"></div>
                                </div>
                            </div>
                            <span class="badge-lock">🔒</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('organizer')">
                            <div class="full-badge-icon">🏠</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">整理达人</span>
                                <span class="full-badge-desc">完成10次整理房间任务</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                        <div class="full-badge-item owned" onclick="showBadgeDetail('firstplan')">
                            <div class="full-badge-icon">🎯</div>
                            <div class="full-badge-info">
                                <span class="full-badge-name">首个计划</span>
                                <span class="full-badge-desc">创建第一个长期计划</span>
                            </div>
                            <span class="badge-check">✓</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 徽章详情模态框 */
        .badge-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2100;
        }

        .badge-modal-overlay.active {
            display: flex;
        }

        .badge-modal {
            background: white;
            border-radius: 24px;
            padding: 32px 28px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: badgePopIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes badgePopIn {
            0% {
                transform: scale(0.5) rotate(-10deg);
                opacity: 0;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .badge-modal-icon {
            font-size: 72px;
            margin-bottom: 12px;
            animation: badgeShine 2s ease-in-out infinite;
        }

        @keyframes badgeShine {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.3) drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
            }
        }

        .badge-modal-name {
            font-size: 22px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .badge-modal-status {
            margin-bottom: 12px;
        }

        .status-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-tag.owned {
            background: linear-gradient(135deg, #10B981, #34D399);
            color: white;
        }

        .status-tag.locked {
            background: rgba(107, 114, 128, 0.2);
            color: #6B7280;
        }

        .badge-modal-desc {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 8px;
        }

        .badge-modal-date {
            font-size: 12px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .badge-modal-progress {
            margin-bottom: 16px;
        }

        .badge-modal-progress .progress-bar {
            height: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .badge-modal-progress .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }

        .badge-modal-progress .progress-text {
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
        }

        .badge-modal-btn {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        /* 查看全部按钮 */
        .view-all-badges {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            float: right;
        }

        /* 全部徽章页面 */
        .all-badges-overlay {
            position: fixed;
            inset: 0;
            /* 使用不透明的渐变背景完全覆盖底层 */
            background: linear-gradient(135deg, #E0E7FF 0%, #FCE7F3 50%, #DBEAFE 100%);
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .all-badges-overlay.active {
            display: flex;
        }

        .all-badges-page {
            max-width: 420px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .all-badges-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .all-badges-header h2 {
            flex: 1;
            text-align: center;
            font-size: 18px;
            margin: 0;
        }

        .all-badges-header .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }

        .badges-progress {
            font-size: 14px;
            color: var(--primary);
            font-weight: 600;
        }

        .all-badges-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .badge-category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .category-badges {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .full-badge-item {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .full-badge-item:hover {
            transform: translateX(4px);
        }

        .full-badge-item.locked {
            opacity: 0.7;
        }

        .full-badge-icon {
            font-size: 36px;
            flex-shrink: 0;
        }

        .full-badge-info {
            flex: 1;
        }

        .full-badge-name {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .full-badge-desc {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .mini-progress {
            height: 4px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .mini-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 2px;
        }

        .badge-check {
            color: #10B981;
            font-size: 18px;
            font-weight: bold;
        }

        .badge-lock {
            font-size: 16px;
        }

        /* ===== 付费墙模块样式 ===== */
        .paywall-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .paywall-overlay.active {
            display: flex;
        }

        .paywall-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border-radius: 24px;
            max-width: 380px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: paywallSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes paywallSlideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .paywall-header {
            text-align: center;
            padding: 28px 20px 20px;
            background: linear-gradient(180deg, rgba(124, 58, 237, 0.3) 0%, transparent 100%);
            position: relative;
        }

        .paywall-close {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .paywall-badge {
            font-size: 48px;
            margin-bottom: 8px;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.1);
                filter: brightness(1.3) drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));
            }
        }

        .paywall-title {
            font-size: 26px;
            font-weight: 700;
            margin: 0 0 6px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .paywall-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }

        /* 特权列表 */
        .paywall-benefits {
            padding: 16px 20px;
        }

        .benefit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .benefit-item:last-child {
            border-bottom: none;
        }

        .benefit-icon {
            font-size: 20px;
        }

        .benefit-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .benefit-tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
        }

        .benefit-tag.free {
            background: rgba(107, 114, 128, 0.3);
            color: rgba(255, 255, 255, 0.6);
        }

        .benefit-tag.vip {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #1a1a2e;
            font-weight: 600;
        }

        /* 套餐卡片 */
        .paywall-plans {
            display: flex;
            gap: 12px;
            padding: 0 20px 16px;
        }

        .plan-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 16px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .plan-card:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .plan-card.selected {
            border-color: #FFD700;
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 165, 0, 0.1) 100%);
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(124, 58, 237, 0.8);
            color: white;
            font-size: 10px;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }

        .plan-badge.hot {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
        }

        .plan-name {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            margin-top: 6px;
        }

        .plan-price {
            margin-bottom: 6px;
        }

        .price-currency {
            font-size: 16px;
            vertical-align: top;
        }

        .price-amount {
            font-size: 32px;
            font-weight: 700;
            color: #FFD700;
        }

        .price-unit {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .plan-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .plan-save {
            margin-top: 6px;
            font-size: 11px;
            color: #34D399;
            font-weight: 600;
        }

        /* 购买按钮 */
        .paywall-buy-btn {
            display: block;
            width: calc(100% - 40px);
            margin: 8px 20px 12px;
            padding: 16px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            transition: all 0.3s;
        }

        .paywall-buy-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.5);
        }

        .paywall-terms {
            text-align: center;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            margin: 0 0 16px;
        }

        /* 验证弹窗 */
        .verify-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3100;
        }

        .verify-overlay.active {
            display: flex;
        }

        .verify-modal {
            background: white;
            border-radius: 20px;
            padding: 28px;
            max-width: 320px;
            width: 90%;
            text-align: center;
        }

        .verify-title {
            font-size: 20px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 8px;
        }

        .verify-desc {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 16px;
        }

        .verify-question {
            font-size: 24px;
            font-weight: 700;
            color: #7C3AED;
            padding: 16px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .verify-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 16px;
            box-sizing: border-box;
        }

        .verify-input:focus {
            outline: none;
            border-color: #7C3AED;
        }

        .verify-buttons {
            display: flex;
            gap: 12px;
        }

        .verify-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        .verify-btn.cancel {
            background: #F3F4F6;
            color: #6B7280;
        }

        .verify-btn.confirm {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
        }

        .verify-error {
            color: #EF4444;
            font-size: 13px;
            margin-top: 12px;
        }

        /* 支付成功 */
        .payment-success-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3200;
        }

        .payment-success-overlay.active {
            display: flex;
        }

        .payment-success-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: successPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes successPop {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-icon {
            font-size: 72px;
            animation: celebrate 1s ease-in-out infinite;
        }

        @keyframes celebrate {

            0%,
            100% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.1) rotate(-5deg);
            }

            75% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        .success-title {
            font-size: 24px;
            font-weight: 700;
            margin: 12px 0 8px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .success-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 20px;
        }

        .success-benefits {
            text-align: left;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .success-benefits div {
            font-size: 13px;
            color: #34D399;
            margin: 6px 0;
        }

        .success-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        /* ===== 顶部菜单样式 ===== */
        .header-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: flex-start;
            justify-content: flex-end;
            z-index: 2500;
            padding: 60px 16px 0;
        }

        .header-menu-overlay.active {
            display: flex;
        }

        .header-menu {
            background: white;
            border-radius: 16px;
            width: 200px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: menuSlide 0.2s ease-out;
            overflow: hidden;
        }

        @keyframes menuSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-menu .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid #F3F4F6;
            font-weight: 600;
            color: #1F2937;
        }

        .header-menu .menu-close {
            background: none;
            border: none;
            font-size: 22px;
            color: #9CA3AF;
            cursor: pointer;
        }

        .menu-options {
            padding: 8px 0;
        }

        .menu-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-option:hover {
            background: #F9FAFB;
        }

        .option-icon {
            font-size: 18px;
            margin-right: 12px;
        }

        .option-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .option-arrow {
            color: #9CA3AF;
            font-size: 16px;
        }

        /* ===== 货币详情弹窗 ===== */
        .currency-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2600;
        }

        .currency-detail-overlay.active {
            display: flex;
        }

        .currency-detail-modal {
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 320px;
            padding: 24px;
            animation: slideUp 0.3s ease-out;
        }

        .currency-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
        }

        .currency-header.star {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
        }

        .currency-header.diamond {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(124, 58, 237, 0.1));
        }

        .currency-icon {
            font-size: 32px;
        }

        .currency-name {
            font-size: 20px;
            font-weight: 700;
            color: #1F2937;
        }

        .currency-balance {
            text-align: center;
            margin-bottom: 20px;
        }

        .balance-label {
            display: block;
            font-size: 13px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .balance-amount {
            font-size: 42px;
            font-weight: 700;
            color: #F59E0B;
        }

        .balance-amount.diamond {
            color: #7C3AED;
        }

        .currency-history {
            background: #F9FAFB;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .history-title {
            font-size: 13px;
            font-weight: 600;
            color: #6B7280;
            margin-bottom: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-desc {
            font-size: 13px;
            color: #374151;
        }

        .history-amount {
            font-size: 13px;
            font-weight: 600;
            color: #10B981;
        }

        .currency-tip {
            text-align: center;
            font-size: 12px;
            color: #9CA3AF;
            margin-bottom: 16px;
        }

        .currency-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
        }

        .currency-btn.diamond {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
        }

        /* 头部stat可点击样式 */
        .header-stats .stat {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .header-stats .stat:hover {
            transform: scale(1.05);
        }

        .user-section {
            cursor: pointer;
        }
    </style>


    <style>
        .info-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.2s ease-out;
        }

        .info-modal-overlay.active {
            display: flex;
        }

        .info-modal {
            background: white;
            border-radius: 24px;
            padding: 28px 24px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        .info-modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .info-modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 12px;
        }

        .info-modal-content {
            font-size: 14px;
            color: #6B7280;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        .info-modal-btn {
            background: linear-gradient(135deg, #7C3AED, #A855F7);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
    </style>

    <script>
        // ===== 通用信息模态框 =====
        function showInfoModal(icon, title, content) {
            document.getElementById('info-modal-icon').textContent = icon;
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-content').textContent = content;
            document.getElementById('info-modal-overlay').classList.add('active');
        }
        function closeInfoModal() {
            document.getElementById('info-modal-overlay').classList.remove('active');
        }

        // =========================================
        // 极简模式 (Minimal Mode) 交互逻辑
        // =========================================

        // 状态管理
        let appState = 'IDLE'; // IDLE, DIALOGUE, FOCUS
        let currentExecutionSteps = [];
        let currentStepIndex = 0;
        let execTimer = null;
        let execSeconds = 0;

        // =========================================
        // 任务状态管理系统
        // =========================================

        // 任务状态枚举
        const TaskStatus = {
            PENDING: 'pending',     // 待开始
            ACTIVE: 'active',       // 进行中
            PAUSED: 'paused',       // 暂停中
            COMPLETED: 'completed', // 已完成
            OVERDUE: 'overdue',     // 已超时
            ENDED: 'ended'          // 已放弃
        };

        // 今日任务列表（模拟数据）
        let todayTasks = [
            {
                id: 'task_001',
                name: '跳绳训练',
                icon: '🏃',
                status: TaskStatus.PENDING,
                steps: [
                    { desc: '热身拉伸', time: '3分钟', completed: false },
                    { desc: '跳绳100下', time: '5分钟', completed: false },
                    { desc: '休息放松', time: '2分钟', completed: false }
                ],
                currentStep: 0,
                elapsedSeconds: 0,
                pausedAt: null,
                source: 'ai' // ai | parent
            },
            {
                id: 'task_002',
                name: '阅读绘本',
                icon: '📚',
                status: TaskStatus.COMPLETED,
                steps: [
                    { desc: '选择绘本', time: '2分钟', completed: true },
                    { desc: '阅读20分钟', time: '20分钟', completed: true }
                ],
                currentStep: 2,
                elapsedSeconds: 1320,
                source: 'ai'
            },
            {
                id: 'task_003',
                name: '整理书桌',
                icon: '🗂️',
                status: TaskStatus.PENDING,
                steps: [
                    { desc: '清理桌面杂物', time: '5分钟', completed: false },
                    { desc: '摆放文具', time: '3分钟', completed: false }
                ],
                currentStep: 0,
                elapsedSeconds: 0,
                source: 'parent'
            }
        ];

        // =========================================
        // 长期任务管理系统
        // =========================================

        // 长期计划列表（模拟数据）
        let longTermPlans = [
            {
                id: 'plan_001',
                title: '30天阅读计划',
                description: '读完《哈利波特与魔法石》',
                icon: '📖',
                status: 'active', // pending | active | paused | completed | ended

                // 时间信息
                startDate: '2026-01-01',
                endDate: '2026-01-30',
                totalDays: 30,
                currentDay: 15,

                // 进度信息
                completedDays: 14,
                missedDays: 1,
                streakDays: 5,
                maxStreak: 10,

                // 阶段定义
                phases: [
                    {
                        id: 'phase_1',
                        name: '入门期',
                        emoji: '🌱',
                        dayRange: [1, 10],
                        status: 'completed',
                        reward: { stars: 50, badge: '书虫' }
                    },
                    {
                        id: 'phase_2',
                        name: '成长期',
                        emoji: '📈',
                        dayRange: [11, 20],
                        status: 'active',
                        reward: { stars: 80, badge: '阅读达人' }
                    },
                    {
                        id: 'phase_3',
                        name: '冲刺期',
                        emoji: '🏆',
                        dayRange: [21, 30],
                        status: 'locked',
                        reward: { stars: 100, evolutionUnlock: true }
                    }
                ],

                // 每日任务模板
                dailyTask: {
                    title: '阅读约10页',
                    estimatedTime: 30,
                    reward: 8,
                    steps: [
                        { desc: '找个安静的地方', time: '1分钟', completed: false },
                        { desc: '阅读约10页', time: '25分钟', completed: false },
                        { desc: '记录今日感想', time: '4分钟', completed: false }
                    ]
                },

                // 本周打卡记录 (周一到周日)
                weeklyRecord: ['completed', 'completed', 'completed', 'pending', null, null, null],

                // 已获得奖励
                earnedRewards: {
                    totalStars: 150,
                    badges: ['书虫'],
                    phasesCompleted: 1
                },

                // 最终奖励
                finalReward: {
                    diamondCoins: 10,
                    title: '读书家'
                }
            }
        ];

        // 获取当前活跃的长期计划
        function getActiveLongTermPlan() {
            return longTermPlans.find(p => p.status === 'active');
        }

        // 获取长期计划今日任务
        function getLongTermDailyTask() {
            const plan = getActiveLongTermPlan();
            if (!plan) return null;

            return {
                id: `daily_${plan.id}_day${plan.currentDay}`,
                planId: plan.id,
                type: 'long_term_daily',
                name: `阅读第${plan.currentDay}章`,
                icon: plan.icon,
                planTitle: plan.title,
                dayInfo: `Day ${plan.currentDay}/${plan.totalDays}`,
                progress: Math.round((plan.currentDay / plan.totalDays) * 100),
                status: plan.weeklyRecord[3] === 'completed' ? TaskStatus.COMPLETED : TaskStatus.PENDING, // 周四是index 3
                steps: plan.dailyTask.steps.map(s => ({ ...s })),
                estimatedTime: plan.dailyTask.estimatedTime,
                reward: plan.dailyTask.reward,
                currentStep: 0,
                elapsedSeconds: 0,
                source: 'ai'
            };
        }

        // 获取当前阶段
        function getCurrentPhase(plan) {
            if (!plan) return null;
            return plan.phases.find(p => p.status === 'active');
        }

        // 当前进行中的任务
        let activeTask = null;

        // 获取进行中或暂停中的任务
        function getInProgressTask() {
            return todayTasks.find(t => t.status === TaskStatus.ACTIVE || t.status === TaskStatus.PAUSED);
        }

        // 获取待开始的任务（推荐下一个）
        function getNextPendingTask() {
            return todayTasks.find(t => t.status === TaskStatus.PENDING);
        }

        // 获取任务统计
        function getTaskStats() {
            const completed = todayTasks.filter(t => t.status === TaskStatus.COMPLETED).length;
            const total = todayTasks.length;
            return { completed, total };
        }

        // 更新任务指示条
        function updateTaskIndicator() {
            const indicator = document.querySelector('.task-indicator');
            const inProgress = getInProgressTask();
            const stats = getTaskStats();

            if (inProgress) {
                // 有进行中任务 - 高亮显示
                indicator.classList.add('in-progress');
                indicator.innerHTML = `
                    <div class="indicator-icon">${inProgress.status === TaskStatus.PAUSED ? '⏸️' : '⏱️'}</div>
                    <div class="indicator-text">${inProgress.status === TaskStatus.PAUSED ? '暂停中' : '进行中'}</div>
                    <div class="indicator-task-name">${inProgress.name}</div>
                    <div class="indicator-progress">
                        <span class="progress-current">${inProgress.currentStep}</span>/<span class="progress-total">${inProgress.steps.length}</span>
                    </div>
                `;
            } else {
                // 无进行中任务 - 显示今日统计
                indicator.classList.remove('in-progress');
                indicator.innerHTML = `
                    <div class="indicator-icon">📋</div>
                    <div class="indicator-text">今日任务</div>
                    <div class="indicator-progress">
                        <span class="progress-current">${stats.completed}</span>/<span class="progress-total">${stats.total}</span>
                    </div>
                    <div class="indicator-arrow">▾</div>
                `;
            }
        }

        // 更新伙伴气泡（根据任务状态）
        function updatePartnerBubble() {
            const bubble = document.getElementById('partner-bubble');
            const inProgress = getInProgressTask();
            const nextTask = getNextPendingTask();

            if (inProgress) {
                if (inProgress.status === TaskStatus.PAUSED) {
                    // 有暂停中的任务 - 恢复提示
                    bubble.querySelector('.bubble-text').innerHTML =
                        `上次的<strong>${inProgress.name}</strong>还没完成呢~<br>要继续吗？😊`;
                    bubble.querySelector('.bubble-actions').innerHTML = `
                        <button class="bubble-btn secondary" onclick="abandonPausedTask()">放弃</button>
                        <button class="bubble-btn primary" onclick="resumeTask()">继续！</button>
                    `;
                } else {
                    // 有进行中的任务 - 继续提示
                    bubble.querySelector('.bubble-text').innerHTML =
                        `你正在做<strong>${inProgress.name}</strong>哦！<br>已完成 ${inProgress.currentStep}/${inProgress.steps.length} 步，加油！💪`;
                    bubble.querySelector('.bubble-actions').innerHTML = `
                        <button class="bubble-btn secondary" onclick="pauseCurrentTask()">暂停</button>
                        <button class="bubble-btn primary" onclick="resumeTask()">继续！</button>
                    `;
                }
            } else if (nextTask) {
                // 显示下一个推荐任务
                bubble.querySelector('.bubble-text').innerHTML =
                    `嗨~小星星！接下来该<strong>${nextTask.name}</strong>啦！${nextTask.icon}`;
                bubble.querySelector('.bubble-actions').innerHTML = `
                    <button class="bubble-btn secondary" onclick="showAllTasks()">查看全部</button>
                    <button class="bubble-btn primary" onclick="startSuggestedTask()">开始！</button>
                `;
            } else {
                // 所有任务完成
                bubble.querySelector('.bubble-text').innerHTML =
                    `太棒了！🎉<br>今天的任务都完成啦！你真厉害！`;
                bubble.querySelector('.bubble-actions').innerHTML = `
                    <button class="bubble-btn primary" onclick="showAllTasks()">查看成果</button>
                `;
            }

            bubble.querySelector('.bubble-actions').style.display = 'flex';
        }

        // 暂停当前任务
        function pauseCurrentTask() {
            const inProgress = getInProgressTask();
            if (inProgress && inProgress.status === TaskStatus.ACTIVE) {
                inProgress.status = TaskStatus.PAUSED;
                inProgress.pausedAt = new Date().toISOString();
                inProgress.elapsedSeconds = execSeconds;

                // 停止计时器
                if (execTimer) clearInterval(execTimer);

                // 退出执行界面
                document.getElementById('exec-overlay').classList.remove('active');
                appState = 'IDLE';

                // 更新UI
                updateTaskIndicator();
                updatePartnerBubble();
            }
        }

        // 恢复任务
        function resumeTask() {
            const pausedTask = getInProgressTask();
            if (pausedTask) {
                pausedTask.status = TaskStatus.ACTIVE;
                activeTask = pausedTask;
                currentExecutionSteps = pausedTask.steps;
                currentStepIndex = pausedTask.currentStep;
                execSeconds = pausedTask.elapsedSeconds || 0;

                // 进入执行模式
                appState = 'FOCUS';
                document.getElementById('exec-overlay').classList.add('active');
                renderCurrentStep();
                startTimer();

                updateTaskIndicator();
            }
        }

        // 放弃暂停中的任务
        function abandonPausedTask() {
            showExitConfirmModal();
        }


        // 1. 底部输入球控制
        function activateInput() {
            if (appState === 'FOCUS') return; // 专注时不许输入

            const panel = document.getElementById('input-panel');
            panel.classList.add('active');
            document.getElementById('minimal-input').focus();

            // 隐藏输入球
            document.getElementById('magic-ball').style.transform = 'scale(0) translateY(100px)';
        }

        function closeInput() {
            const panel = document.getElementById('input-panel');
            panel.classList.remove('active');

            // 恢复输入球（如果不在专注态和对话态）
            if (appState === 'IDLE') {
                setTimeout(() => {
                    document.getElementById('magic-ball').style.transform = 'scale(1) translateY(0)';
                }, 300);
            }
        }

        function handleMinimalInput() {
            const input = document.getElementById('minimal-input');
            const text = input.value.trim();
            if (text) {
                // 关闭输入板
                closeInput();
                input.value = '';

                // 1. 伙伴确认
                const bubble = document.getElementById('partner-bubble');
                bubble.style.opacity = '1';
                bubble.innerHTML = `要做"${text}"？<br>好主意！让我来帮你拆解一下！⚡️`;

                // 2. 模拟进入拆解思考（State B）
                setTimeout(() => {
                    showDecomposition(text);
                }, 800);
            }
        }

        // 显示拆解卡片 (进入 State B)
        function showDecomposition(taskName) {
            appState = 'DIALOGUE';

            // 1. 界面元素变换
            document.querySelector('.top-layer').style.paddingTop = '60px'; // 稍微防抖动
            document.querySelector('.top-layer').style.opacity = '0'; // 隐藏顶部
            document.querySelector('.task-board').style.opacity = '0'; // 隐藏侧边任务
            document.querySelector('.magic-input-ball').style.transform = 'scale(0) translateY(100px)'; // 隐藏球

            // 伙伴移位
            document.querySelector('.partner-center-stage').classList.add('shift-up');

            // 2. 准备数据 (模拟 AI)
            currentExecutionSteps = generateMockSteps(taskName);
            const steps = currentExecutionSteps;
            const card = document.getElementById('decomposition-card');

            // 渲染卡片
            card.querySelector('.card-title').innerText = `✨ ${taskName} 计划`;

            let stepsHtml = steps.map((step, idx) => `
                <div class="step-item">
                    <div class="step-num">${idx + 1}</div>
                    <div class="step-content">
                        <div class="step-text">${step.desc}</div>
                        <div class="step-time-tag">⏱ ${step.time}</div>
                    </div>
                </div>
            `).join('');

            card.querySelector('.step-list').innerHTML = stepsHtml;

            // 显示卡片
            card.classList.add('active');

            // 伙伴说话
            const bubble = document.getElementById('partner-bubble');
            bubble.innerHTML = `看！我把"${taskName}"分成了${steps.length}小步！<br>这样是不是简单多了？😎`;
        }

        // 取消拆解 (返回 State A)
        function cancelDecomposition() {
            appState = 'IDLE';

            // 隐藏卡片
            document.getElementById('decomposition-card').classList.remove('active');

            // 恢复界面
            document.querySelector('.top-layer').style.opacity = '1';
            document.querySelector('.task-board').style.opacity = '1';
            document.querySelector('.partner-center-stage').classList.remove('shift-up');

            setTimeout(() => {
                document.getElementById('magic-ball').style.transform = 'scale(1) translateY(0)';
            }, 300);

            const bubble = document.getElementById('partner-bubble');
            bubble.innerHTML = '没关系，想做的时候随时叫我哦！✨';
        }

        // 确认拆解 (进入 State C - Focus)
        function confirmDecomposition() {
            document.getElementById('decomposition-card').classList.remove('active');
            startTaskExecution();
        }

        // =========================================
        // 执行模式 (State C)
        // =========================================

        function startTaskExecution() {
            appState = 'FOCUS';
            currentStepIndex = 0;
            execSeconds = 0;

            const overlay = document.getElementById('exec-overlay');
            overlay.classList.add('active');

            renderCurrentStep();
            startTimer();
        }

        function renderCurrentStep() {
            const step = currentExecutionSteps[currentStepIndex];
            const total = currentExecutionSteps.length;

            document.getElementById('exec-step-num').innerText = `步骤 ${currentStepIndex + 1} / ${total}`;
            // 处理step对象的不同属性名 (desc vs name)
            document.getElementById('exec-name').innerText = step.desc || step.name;
            document.getElementById('exec-icon').innerText = step.icon || '⚡️';
            document.getElementById('exec-desc').innerText = step.time ? `预计耗时：${step.time}` : '加油！专心完成它！';

            // 更新进度条
            const dots = document.getElementById('exec-progress');
            dots.innerHTML = '';
            for (let i = 0; i < total; i++) {
                const dot = document.createElement('div');
                dot.className = `exec-progress-dot ${i <= currentStepIndex ? 'current' : ''}`;
                dots.appendChild(dot);
            }
        }

        function startTimer() {
            if (execTimer) clearInterval(execTimer);
            document.getElementById('time-status-text').innerText = '正在计时...';
            document.getElementById('exec-pause-btn').innerHTML = '⏸️ 暂停';

            execTimer = setInterval(() => {
                execSeconds++;
                const mins = Math.floor(execSeconds / 60).toString().padStart(2, '0');
                const secs = (execSeconds % 60).toString().padStart(2, '0');
                document.getElementById('exec-timer').innerText = `${mins}:${secs}`;
                document.getElementById('exec-timer-mini').innerText = `${mins}:${secs}`;
            }, 1000);
        }

        function togglePause() {
            if (execTimer) {
                clearInterval(execTimer);
                execTimer = null;
                document.getElementById('time-status-text').innerText = '已暂停';
                document.getElementById('exec-pause-btn').innerHTML = '▶️ 继续';
            } else {
                startTimer();
            }
        }

        function completeStep() {
            // 标记当前步骤完成
            const inProgress = getInProgressTask();
            if (inProgress && inProgress.steps[currentStepIndex]) {
                inProgress.steps[currentStepIndex].completed = true;
            }

            // 检查是否最后一步
            if (currentStepIndex >= currentExecutionSteps.length - 1) {
                // 完成任务
                if (inProgress) {
                    inProgress.status = TaskStatus.COMPLETED;
                    inProgress.currentStep = inProgress.steps.length;
                }
                showCelebration();
            } else {
                currentStepIndex++;
                if (inProgress) {
                    inProgress.currentStep = currentStepIndex;
                }
                renderCurrentStep();
            }
        }

        function showCelebration() {
            clearInterval(execTimer);
            const inProgress = getInProgressTask() || activeTask;
            document.getElementById('cel-overlay').classList.add('active');
            document.getElementById('cel-text').innerText = `你完成了「${inProgress?.name || '任务'}」`;
        }

        function continueAfterCel() {
            document.getElementById('cel-overlay').classList.remove('active');
            forceExitExec();
        }

        function exitExec() {
            // 显示退出确认弹窗，而不是直接退出
            showExitConfirmModal();
        }

        // 显示退出确认弹窗
        function showExitConfirmModal() {
            document.getElementById('exit-confirm-overlay').classList.add('active');
        }

        // 隐藏退出确认弹窗
        function hideExitConfirmModal() {
            document.getElementById('exit-confirm-overlay').classList.remove('active');
        }

        // 确认暂停 - 保存进度
        function confirmPause() {
            hideExitConfirmModal();

            const inProgress = getInProgressTask();
            if (inProgress) {
                inProgress.status = TaskStatus.PAUSED;
                inProgress.pausedAt = new Date().toISOString();
                inProgress.elapsedSeconds = execSeconds;
                inProgress.currentStep = currentStepIndex;
            }

            // 停止计时器
            if (execTimer) clearInterval(execTimer);

            // 关闭执行界面
            document.getElementById('exec-overlay').classList.remove('active');
            appState = 'IDLE';

            // 更新UI
            updateTaskIndicator();
            updatePartnerBubble();
        }

        // 确认完成（用户说已完成）
        function confirmComplete() {
            hideExitConfirmModal();

            const inProgress = getInProgressTask();
            if (inProgress) {
                inProgress.status = TaskStatus.COMPLETED;
                inProgress.steps.forEach(s => s.completed = true);
                inProgress.currentStep = inProgress.steps.length;
            }

            // 停止计时器
            if (execTimer) clearInterval(execTimer);

            // 关闭执行界面
            document.getElementById('exec-overlay').classList.remove('active');
            appState = 'IDLE';

            // 显示简单庆祝
            const bubble = document.getElementById('partner-bubble');
            if (bubble.querySelector('.bubble-text')) {
                bubble.querySelector('.bubble-text').innerHTML = `太棒了！🎉<br><strong>${inProgress?.name || '任务'}</strong>完成啦！`;
                bubble.querySelector('.bubble-actions').innerHTML = `
                    <button class="bubble-btn primary" onclick="updatePartnerBubble()">好的！</button>
                `;
            }

            updateTaskIndicator();
        }

        // 确认放弃任务
        function confirmAbandon() {
            hideExitConfirmModal();

            const inProgress = getInProgressTask();
            if (inProgress) {
                inProgress.status = TaskStatus.ENDED;
            }

            // 停止计时器
            if (execTimer) clearInterval(execTimer);

            // 关闭执行界面
            document.getElementById('exec-overlay').classList.remove('active');
            appState = 'IDLE';

            // 伙伴安慰
            const bubble = document.getElementById('partner-bubble');
            if (bubble.querySelector('.bubble-text')) {
                bubble.querySelector('.bubble-text').innerHTML = `没关系~😊<br>休息一下，想做的时候随时叫我！`;
                bubble.querySelector('.bubble-actions').innerHTML = `
                    <button class="bubble-btn primary" onclick="updatePartnerBubble()">好的</button>
                `;
            }

            updateTaskIndicator();
        }

        // 直接退出（不经过确认，用于已完成任务后）
        function forceExitExec() {
            if (execTimer) clearInterval(execTimer);
            document.getElementById('exec-overlay').classList.remove('active');
            appState = 'IDLE';
            updateTaskIndicator();
            updatePartnerBubble();
        }

        function showStepTimeAdjust() {
            alert('调整时间功能开发中...');
        }

        // 模拟AI生成步骤
        function generateMockSteps(taskName) {
            // 简单的关键词匹配
            if (taskName.includes('作业')) {
                return [
                    { desc: '拿出作业本和笔', time: '2分钟' },
                    { desc: '完成语文生字练习', time: '15分钟' },
                    { desc: '检查并收拾书包', time: '3分钟' }
                ];
            } else if (taskName.includes('房间') || taskName.includes('整理')) {
                return [
                    { desc: '把地上的玩具收进箱子', time: '5分钟' },
                    { desc: '把衣服挂回衣柜', time: '5分钟' },
                    { desc: '擦桌子', time: '3分钟' }
                ];
            } else {
                return [
                    { desc: '第一步：准备好心情', time: '1分钟' },
                    { desc: '第二步：专心做这件事', time: '10分钟' },
                    { desc: '第三步：给自己一个奖励', time: '1分钟' }
                ];
            }
        }

        // 2. 任务抽屉控制
        function toggleTaskDrawer() {
            const drawer = document.getElementById('task-drawer');
            const backdrop = document.getElementById('drawer-backdrop');
            drawer.classList.toggle('active');
            backdrop.classList.toggle('active');

            // 打开时渲染任务列表
            if (drawer.classList.contains('active')) {
                renderDrawerTasks();
                renderDrawerLongTermSection();
            }
        }

        // 渲染抽屉中的即时任务列表
        function renderDrawerTasks() {
            const listContainer = document.getElementById('drawer-task-list');
            if (!listContainer) return;

            let html = '';
            todayTasks.forEach(task => {
                const isDone = task.status === TaskStatus.COMPLETED;
                const isPaused = task.status === TaskStatus.PAUSED;
                const isActive = task.status === TaskStatus.ACTIVE;

                let statusText = '待开始';
                let actionIcon = '▶';
                let cardClass = 'task-card-minimal';

                if (isDone) {
                    statusText = '已完成';
                    actionIcon = '✓';
                    cardClass += ' done';
                } else if (isPaused) {
                    statusText = '暂停中';
                    actionIcon = '▶';
                    cardClass += ' paused';
                } else if (isActive) {
                    statusText = '进行中';
                    actionIcon = '⏸';
                }

                html += `
                    <div class="${cardClass}" onclick="startTaskFromDrawer('${task.id}')">
                        <div class="task-icon">${task.icon}</div>
                        <div class="task-info">
                            <div class="task-name">${task.name}</div>
                            <div class="task-status">${statusText}</div>
                        </div>
                        <div class="task-action">${actionIcon}</div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
        }

        // 渲染抽屉中的长期计划分区
        function renderDrawerLongTermSection() {
            const section = document.getElementById('drawer-long-term-section');
            const plan = getActiveLongTermPlan();

            if (!plan) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            const progress = Math.round((plan.currentDay / plan.totalDays) * 100);

            section.innerHTML = `
                <div class="drawer-section-title">📆 长期计划进行中</div>
                <div class="plan-mini-card" onclick="showPlanDetail()">
                    <div class="plan-mini-header">
                        <span class="plan-mini-icon">${plan.icon}</span>
                        <div class="plan-mini-info">
                            <div class="plan-mini-name">${plan.title}</div>
                            <div class="plan-mini-day">Day ${plan.currentDay}/${plan.totalDays}</div>
                        </div>
                    </div>
                    <div class="plan-mini-today">今日：阅读第${plan.currentDay}章（约${plan.dailyTask.estimatedTime}分钟）</div>
                    <div class="plan-mini-progress">
                        <div class="plan-mini-progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="plan-mini-action" onclick="event.stopPropagation(); startLongTermDailyTask()">开始 →</div>
                </div>
            `;
        }

        // 从抽屉开始任务
        function startTaskFromDrawer(taskId) {
            const task = todayTasks.find(t => t.id === taskId);
            if (!task || task.status === TaskStatus.COMPLETED) return;

            // 关闭抽屉
            toggleTaskDrawer();

            // 设置任务状态
            task.status = TaskStatus.ACTIVE;
            activeTask = task;
            currentExecutionSteps = task.steps;
            currentStepIndex = task.currentStep || 0;
            execSeconds = task.elapsedSeconds || 0;

            // 进入执行模式
            appState = 'FOCUS';
            document.getElementById('exec-overlay').classList.add('active');
            renderCurrentStep();
            startTimer();

            updateTaskIndicator();
        }

        // 3. 伙伴互动
        function interactWithPartner() {
            if (appState !== 'IDLE') return; // 只有闲置时可互动

            const bubble = document.getElementById('partner-bubble');
            const responses = [
                "加油！你是最棒的！✨",
                "今天的天气真好呀~☀️",
                "别忘了喝水哦！💧",
                "我准备好和你一起冒险了！🛡️"
            ];
            const randomText = responses[Math.floor(Math.random() * responses.length)];

            bubble.style.opacity = '1';
            bubble.style.top = '-50px';
            bubble.innerText = randomText;

            setTimeout(() => {
                bubble.style.top = '-40px';
            }, 200);
        }

        // 4. 角落入口跳转
        function openRewards() {
            alert('打开心愿宝箱 (后续实现)');
        }

        function openSettings() {
            alert('打开家长控制台 (后续实现)');
        }

        // =========================================
        // 新增：PlanCoach 风格交互
        // =========================================

        // 当前推荐任务
        let suggestedTask = {
            name: '跳绳训练',
            icon: '🏃',
            steps: [
                { desc: '热身拉伸', time: '3分钟' },
                { desc: '跳绳100下', time: '5分钟' },
                { desc: '休息放松', time: '2分钟' }
            ]
        };

        // 点击输入框时（可扩展为展开输入面板）
        function focusChatInput() {
            document.getElementById('chat-input-field').focus();
        }

        // 输入框回车事件
        document.addEventListener('DOMContentLoaded', function () {
            const input = document.getElementById('chat-input-field');
            if (input) {
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        handleChatInput();
                    }
                });
            }
        });

        // 处理输入
        function handleChatInput() {
            const input = document.getElementById('chat-input-field');
            const text = input.value.trim();
            if (text) {
                input.value = '';

                // 更新伙伴气泡
                const bubble = document.getElementById('partner-bubble');
                bubble.querySelector('.bubble-text').innerHTML = `好的！让我帮你规划<strong>${text}</strong>...⚡️`;
                bubble.querySelector('.bubble-actions').style.display = 'none';

                // 进入拆解
                setTimeout(() => {
                    showDecomposition(text);
                }, 800);
            }
        }

        // 语音输入（占位）
        function startVoiceInput() {
            alert('语音输入功能开发中...');
        }

        // 查看全部任务
        function showAllTasks() {
            toggleTaskDrawer();
        }

        // 开始推荐任务
        function startSuggestedTask() {
            const nextTask = getNextPendingTask();
            if (!nextTask) return;

            // 设置任务状态
            nextTask.status = TaskStatus.ACTIVE;
            activeTask = nextTask;
            currentExecutionSteps = nextTask.steps;
            currentStepIndex = nextTask.currentStep || 0;
            execSeconds = nextTask.elapsedSeconds || 0;

            // 进入执行模式
            appState = 'FOCUS';
            document.getElementById('exec-overlay').classList.add('active');
            renderCurrentStep();
            startTimer();

            updateTaskIndicator();
        }

        // 更新伙伴提醒（可由后台定时调用）
        function updatePartnerReminder(taskName, emoji) {
            const bubble = document.getElementById('partner-bubble');
            bubble.querySelector('.bubble-text').innerHTML =
                `嗨~小星星！接下来该<strong>${taskName}</strong>啦！${emoji}`;
            bubble.querySelector('.bubble-actions').style.display = 'flex';
            bubble.style.opacity = '1';
        }

        // =========================================
        // 长期任务管理函数
        // =========================================

        // 显示长期任务详情页
        function showPlanDetail() {
            const plan = getActiveLongTermPlan();
            if (!plan) return;

            // 更新详情页内容
            document.getElementById('plan-detail-title').innerHTML = `${plan.icon} ${plan.title}`;
            document.getElementById('plan-day-display').textContent = `Day ${plan.currentDay}/${plan.totalDays}`;

            const progress = Math.round((plan.currentDay / plan.totalDays) * 100);
            document.getElementById('plan-progress-percent').textContent = `${progress}%`;

            // 更新进度环
            const circumference = 314; // 2 * PI * 50
            const offset = circumference - (circumference * progress / 100);
            document.getElementById('plan-progress-ring').setAttribute('stroke-dashoffset', offset);

            // 显示详情页
            document.getElementById('plan-detail-overlay').classList.add('active');
        }

        // 关闭长期任务详情页
        function closePlanDetail() {
            document.getElementById('plan-detail-overlay').classList.remove('active');
        }

        // 开始长期任务的今日部分
        function startLongTermDailyTask() {
            const plan = getActiveLongTermPlan();
            if (!plan) return;

            // 关闭详情页（如果打开的话）
            closePlanDetail();

            // 创建今日任务对象
            const dailyTask = getLongTermDailyTask();
            if (!dailyTask) return;

            // 设置为进行中
            dailyTask.status = TaskStatus.ACTIVE;
            activeTask = dailyTask;
            currentExecutionSteps = dailyTask.steps;
            currentStepIndex = 0;
            execSeconds = 0;

            // 进入执行模式
            appState = 'FOCUS';
            document.getElementById('exec-overlay').classList.add('active');
            renderCurrentStep();
            startTimer();

            // 隐藏长期任务卡
            document.getElementById('long-term-card').style.opacity = '0.3';
        }

        // 更新长期任务卡显示
        // 更新长期任务卡显示 (兼容方案 B)
        function updateLongTermCard() {
            const plan = getActiveLongTermPlan();

            // 1. 更新顶部大卡片 (方案A遗留，虽然隐藏了但保留逻辑防止报错)
            const card = document.getElementById('long-term-card');
            if (card && plan) {
                // 简化处理，保持DOM但不显示
                card.style.display = 'none';
            }

            // 2. 更新方案 B 左侧浮动小卡片
            const floatCard = document.getElementById('float-long-term');
            if (floatCard) {
                if (!plan) {
                    floatCard.style.display = 'none';
                } else {
                    floatCard.style.display = 'flex';
                    const progress = Math.round((plan.currentDay / plan.totalDays) * 100);

                    // 标题
                    const titleEl = floatCard.querySelector('.float-title');
                    if (titleEl) titleEl.textContent = plan.title;

                    // 进度环 (r=18, C=113)
                    const offset = 113 - (113 * progress / 100);
                    const ring = floatCard.querySelector('#mini-ring');
                    if (ring) ring.setAttribute('stroke-dashoffset', offset);

                    const text = floatCard.querySelector('#mini-ring-text');
                    if (text) text.textContent = progress + '%';

                    // Day
                    const dayEls = floatCard.querySelectorAll('.float-title');
                    if (dayEls.length > 1) dayEls[1].textContent = `Day ${plan.currentDay}`;
                }
            }

            // 刷新底部横向任务列表
            renderHorizontalTaskList();
        }

        // 渲染底部横向任务列表 (方案 B)
        // 渲染底部横向任务列表 (方案 B)
        function renderHorizontalTaskList() {
            const listContainer = document.getElementById('horizontal-task-list');
            if (!listContainer) return;

            let html = '';

            // 简单分类逻辑
            function getTaskTypeClass(icon) {
                if (['🏃', '🛹', '🏊', '🏀'].includes(icon)) return 'type-sport';
                if (['📚', '📖', '✏️', '📕'].includes(icon)) return 'type-study';
                return 'type-life';
            }

            // 1. 长期计划的今日任务 (如果未完成)
            const plan = getActiveLongTermPlan();
            if (plan && plan.weeklyRecord[3] !== 'completed') {
                html += `
                    <div class="task-square-card active type-study" onclick="startLongTermDailyTask()">
                        <div class="sq-icon">${plan.icon}</div>
                        <div class="sq-title" style="font-size:12px">今日阅读</div>
                        <div class="task-state-badge">进行中</div>
                    </div>
                `;
            }

            // 2. 普通任务
            todayTasks.forEach(task => {
                let cardClass = 'task-square-card';
                let stateHtml = '';
                const typeClass = getTaskTypeClass(task.icon);

                cardClass += ` ${typeClass}`;

                if (task.status === TaskStatus.COMPLETED) {
                    cardClass += ' done';
                    stateHtml = '<div class="task-state-badge">✓</div>';
                } else if (task.status === TaskStatus.ACTIVE) {
                    cardClass += ' active';
                    stateHtml = '<div class="task-state-badge">进行中</div>';
                } else {
                    stateHtml = '<div class="task-state-badge">待办</div>';
                }

                html += `
                    <div class="${cardClass}" onclick="startTaskFromDrawer('${task.id}')">
                        <div class="sq-icon">${task.icon}</div>
                        <div class="sq-title">${task.name}</div>
                        ${stateHtml}
                    </div>
                `;
            });

            // 占位
            html += `<div style="display:inline-block; width:20px;"></div>`;

            listContainer.innerHTML = html;
        }

        // 打开奖励详情 (模拟)
        function openRewards() {
            const plan = getActiveLongTermPlan();
            const total = 150; // 模拟数据

            // 使用自定义弹窗而不是 alert
            const confirmDiv = document.getElementById('exit-confirm-overlay');
            if (!confirmDiv) { alert('今日奖励：+150'); return; }

            document.querySelector('.exit-emoji').textContent = '🌟';
            document.querySelector('.exit-title').textContent = '今日奖励明细';
            document.getElementById('exit-confirm-desc').innerHTML =
                `<div style="text-align:left; font-size:14px; line-height:1.8; margin-top:10px;">
                 ✨ 每日登录：+10<br>
                 📚 阅读计划：+80<br>
                 🏃 跳绳训练：+60<br>
                 <hr style="border:0; border-top:1px dashed #ddd; margin:10px 0;">
                 <strong>💰 总计获得：${total}</strong>
                 </div>`;

            document.querySelector('.exit-actions').innerHTML = `
                <button class="exit-btn primary" onclick="hideExitConfirmModal()">开心收下！</button>
            `;

            confirmDiv.classList.add('active');
        }

        // 暂停计划
        function pausePlan() {
            const plan = getActiveLongTermPlan();
            if (plan) {
                plan.status = 'paused';
                closePlanDetail();
                updateLongTermCard();

                // 伙伴反馈
                const bubble = document.getElementById('partner-bubble');
                if (bubble.querySelector('.bubble-text')) {
                    bubble.querySelector('.bubble-text').innerHTML =
                        `好的，计划暂停啦~😊<br>想继续的时候随时叫我！`;
                }
            }
        }

        // 调整计划（占位）
        function adjustPlan() {
            alert('调整计划功能开发中...\n可以调整每日时长、阶段划分等');
        }

        // 显示放弃计划确认
        function showAbandonPlanConfirm() {
            const plan = getActiveLongTermPlan();
            if (!plan) return;

            const confirmDiv = document.getElementById('exit-confirm-overlay');
            document.querySelector('.exit-emoji').textContent = '🥺';
            document.querySelector('.exit-title').textContent = '确定要结束这个计划吗？';
            document.getElementById('exit-confirm-desc').innerHTML =
                `你已经坚持了${plan.completedDays}天，这真的很棒！<br>已获得的 🌟${plan.earnedRewards.totalStars} 会保留哦~`;

            document.querySelector('.exit-actions').innerHTML = `
                <button class="exit-btn primary" onclick="hideExitConfirmModal(); closePlanDetail();">我再想想</button>
                <button class="exit-btn secondary" onclick="pausePlanFromConfirm()">暂停计划（以后继续）</button>
                <button class="exit-btn danger" onclick="abandonPlan()">彻底结束</button>
            `;

            confirmDiv.classList.add('active');
        }

        // 从确认框暂停计划
        function pausePlanFromConfirm() {
            hideExitConfirmModal();
            pausePlan();
        }

        // 放弃计划
        function abandonPlan() {
            const plan = getActiveLongTermPlan();
            if (plan) {
                plan.status = 'ended';
            }

            hideExitConfirmModal();
            closePlanDetail();
            updateLongTermCard();

            // 伙伴安慰
            const bubble = document.getElementById('partner-bubble');
            if (bubble.querySelector('.bubble-text')) {
                bubble.querySelector('.bubble-text').innerHTML =
                    `没关系~你已经很努力了！🌟<br>获得的${getActiveLongTermPlan()?.earnedRewards?.totalStars || 0}星星币都是你的！`;
            }
        }

        // 完成长期任务今日打卡
        function completeLongTermDailyTask() {
            const plan = getActiveLongTermPlan();
            if (plan) {
                // 更新打卡记录
                plan.weeklyRecord[3] = 'completed'; // 周四
                plan.completedDays++;
                plan.streakDays++;
                plan.earnedRewards.totalStars += plan.dailyTask.reward;

                // 检查是否需要进入下一天
                if (plan.currentDay < plan.totalDays) {
                    plan.currentDay++;
                }

                // 更新UI
                updateLongTermCard();
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化任务指示条
            if (typeof updateTaskIndicator === 'function') updateTaskIndicator();
            // 初始化伙伴气泡
            if (typeof updatePartnerBubble === 'function') updatePartnerBubble();
            // 初始化长期任务卡 - 即使 activePlan 为 null 也调用一下防止报错
            if (typeof updateLongTermCard === 'function') updateLongTermCard();

            // 强制渲染一次
            setTimeout(renderHorizontalTaskList, 100);
        });
        // [Final Clean V6] 纵向任务流 + 空状态 + 视觉优化 + 动态拆解支持

        // --- 1. 拆解流程逻辑 ---

        // 1.0 Dashboard 控制
        function openTaskDashboard() {
            const el = document.getElementById('task-dashboard-overlay');
            if (el) el.classList.add('active');
        }
        function closeTaskDashboard() {
            const el = document.getElementById('task-dashboard-overlay');
            if (el) el.classList.remove('active');
        }

        // 1.0 Dashboard 控制
        function openTaskDashboard() {
            const el = document.getElementById('task-dashboard-overlay');
            if (el) el.classList.add('active');
        }
        function closeTaskDashboard() {
            const el = document.getElementById('task-dashboard-overlay');
            if (el) el.classList.remove('active');
        }

        // 1.1 监听输入并触发处理
        function activateInput() {
            const text = prompt("你想做什么任务？\n(试试输入: '数学作业', '整理房间', 或 '30天钢琴练习')");
            if (text) {
                handleQuickInput(text);
            }
        }

        // 1.2 处理输入 - 进入对话流
        function handleQuickInput(text) {
            openTaskDashboard();
            startDialogueFlow(text);
        }

        // 1.3 Mock AI 分析引擎
        function mockAIAnalysis(text) {
            if (text.includes('整理') || text.includes('大扫除') || text.includes('画画')) {
                return {
                    type: 'medium',
                    title: text,
                    duration: '2小时',
                    stages: [
                        { icon: '📦', name: '准备阶段', time: '20min', color: '#0ea5e9', bg: '#f0f9ff' },
                        { icon: '⚙️', name: '执行阶段', time: '1h', color: '#374151', bg: '#fff' },
                        { icon: '✨', name: '收尾整理', time: '40min', color: '#374151', bg: '#fff' }
                    ]
                };
            } else if (text.includes('天') || text.includes('挑战') || text.includes('马拉松') || text.includes('考级')) {
                return {
                    type: 'long',
                    title: text,
                    totalDays: 30,
                    milestones: [
                        { icon: '🌱', name: '初次尝试', status: 'done' },
                        { icon: '🌿', name: '基础巩固', status: 'active' },
                        { icon: '🌳', name: '进阶提升', status: 'pending' },
                        { icon: '🍎', name: '最终成果', status: 'pending' }
                    ]
                };
            } else {
                return {
                    type: 'short',
                    title: text,
                    time: '30分钟',
                    steps: [
                        { name: '准备工作', desc: '拿出相关课本和文具' },
                        { name: '专注执行', desc: '设定闹钟，开始第一项' },
                        { name: '检查回顾', desc: '核对答案，整理书包' }
                    ]
                };
            }
        }

        // 1.4 启动对话流 (Interactive Chat)
        function startDialogueFlow(text) {
            const content = document.querySelector('.td-content');
            content.innerHTML = `<div class="chat-container"></div>`;
            const container = content.querySelector('.chat-container');

            // Helper to add message
            const addMsg = (role, msg, delay = 0) => {
                setTimeout(() => {
                    const div = document.createElement('div');
                    div.className = `chat-bubble ${role}`;
                    div.innerHTML = msg;
                    container.appendChild(div);
                    container.scrollTop = container.scrollHeight;
                }, delay);
            };

            // 1. User Input Echo
            addMsg('user', text, 0);

            // 2. AI Acknowledgement
            addMsg('ai', `收到！你想挑战 "<b>${text}</b>" 对吗？这个想法真棒！✨`, 600);

            // 3. AI Analysis & Result
            setTimeout(() => {
                // Analyze
                const result = mockAIAnalysis(text);

                let comment = "";
                if (result.type === 'long') comment = "这是一个很有挑战的长期目标！我们需要把它拆分成几个重要的里程碑。🚩";
                else if (result.type === 'medium') comment = "这个任务需要一点耐心，我建议把它分成几个阶段来执行。🗓️";
                else comment = "这个简单！我帮你列好了执行步骤，马上就能搞定！⚡️";

                addMsg('ai', comment, 0);

                // 4. Show Result Card
                setTimeout(() => {
                    const cardDiv = document.createElement('div');
                    cardDiv.innerHTML = generateTaskCardHTML(result);
                    cardDiv.style.opacity = '0';
                    cardDiv.style.transition = 'opacity 0.6s ease';
                    cardDiv.style.marginTop = '10px';
                    container.appendChild(cardDiv);

                    // Trigger fade in
                    setTimeout(() => {
                        cardDiv.style.opacity = '1';
                        container.scrollTop = container.scrollHeight;
                    }, 50);

                }, 1200);

            }, 1800);
        }

        // 1.5 生成拆解卡片 HTML (纯渲染)
        function generateTaskCardHTML(data) {
            let html = ``;

            if (data.type === 'short') {
                html += `
<div class="breakdown-card">
    <div class="bd-header">
        <div style="font-weight:700; font-size:16px;">${data.title}</div>
        <div class="bd-tag tag-short">⚡️ 短任务</div>
    </div>
    <div style="font-size:13px; color:#6b7280; margin-bottom:12px;">预计耗时 ${data.time} • ${data.steps.length}个步骤</div>
    <div class="steps-flow">
        ${data.steps.map((s, i) => `
        <div class="step-item ${i === 0 ? 'active' : ''}">
            <div style="font-weight:600; font-size:14px; color:#374151;">Step ${i + 1}: ${s.name}</div>
            <div style="font-size:12px; color:#9ca3af; margin-top:2px;">${s.desc}</div>
        </div>
        `).join('')}
    </div>
</div>
`;
            } else if (data.type === 'medium') {
                html += `
<div class="breakdown-card">
    <div class="bd-header">
        <div style="font-weight:700; font-size:16px;">${data.title}</div>
        <div class="bd-tag tag-medium">📆 中任务</div>
    </div>
    <div style="font-size:13px; color:#6b7280; margin-bottom:16px;">预计耗时 ${data.duration} • ${data.stages.length}个阶段
    </div>
    <div style="display:flex; gap:10px; overflow-x:auto;">
        ${data.stages.map(s => `
        <div
            style="flex:1; min-width:100px; background:${s.bg}; padding:12px; border-radius:16px; border:1px solid ${s.color === '#0ea5e9' ? '#bae6fd' : '#e5e7eb'};">
            <div style="font-size:24px; margin-bottom:8px;">${s.icon}</div>
            <div style="font-size:12px; font-weight:700; color:${s.color};">${s.name}</div>
            <div style="font-size:10px; color:#9ca3af;">${s.time}</div>
        </div>
        `).join('')}
    </div>
</div>
`;
            } else if (data.type === 'long') {
                html += `
<div class="breakdown-card">
    <div class="bd-header">
        <div style="font-weight:700; font-size:16px;">${data.title}</div>
        <div class="bd-tag tag-long">🚩 长任务</div>
    </div>
    <div style="font-size:13px; color:#6b7280; margin-bottom:16px;">周期 ${data.totalDays}天 •
        ${data.milestones.length}个里程碑</div>
    <div class="milestone-track">
        ${data.milestones.map(m => `
        <div class="milestone-node ${m.status === 'done' ? 'done' : (m.status === 'active' ? 'active' : '')}">
            <div class="node-icon">${m.icon}</div>
            <div class="node-label">${m.name}</div>
        </div>
        `).join('')}
    </div>
</div>
`;
            }

            // 底部确认按钮 (直接拼接)
            html += `
<div style="margin-top:20px; display:flex; gap:16px;">
    <button onclick="closeTaskDashboard()"
        style="flex:1; padding:16px; border-radius:24px; border:none; background:#f3f4f6; color:#4b5563; font-weight:600; font-size:16px;">再想想</button>
    <button onclick="confirmAddTask('${data.title}', '${data.type}')"
        style="flex:2; padding:16px; border-radius:24px; border:none; background:linear-gradient(135deg, #8b5cf6, #7c3aed); color:white; font-weight:600; font-size:16px; box-shadow:0 8px 20px rgba(139, 92, 246, 0.3);">确认添加任务</button>
</div>
<div style="height:20px;"></div>
`;
            return html;
        }

        // 1.5 确认添加
        function confirmAddTask(title, type) {
            closeTaskDashboard();

            const listContainer = document.getElementById('horizontal-task-list');
            if (listContainer) {
                const newCard = document.createElement('div');
                newCard.className = `task-wide-card type-${type === 'long' ? 'study' : 'life'}`;
                newCard.innerHTML = `
<div class="wide-icon">${type === 'long' ? '🚩' : '⚡️'}</div>
<div class="wide-content">
    <div class="wide-title">${title}</div>
    <div class="wide-subtitle">刚刚添加 • ${type === 'short' ? '30min' : '进行中'}</div>
</div>
<div class="wide-action">
    <button class="status-btn">开始</button>
</div>
`;
                // 插入到列表中的第一个位置
                listContainer.prepend(newCard);
                // 隐藏可能存在的空状态
                const es = document.querySelector('.empty-state-box');
                if (es) es.style.display = 'none';
            }
        }


        // --- 2. 核心渲染逻辑 (V6) ---

        renderHorizontalTaskList = function () {
            const listContainer = document.getElementById('horizontal-task-list');
            if (!listContainer) return;

            // 1. 强制应用纵向布局样式
            listContainer.className = 'vertical-task-list';
            listContainer.style.display = 'flex';

            let html = '';

            // --- 初始空状态配置 ---
            // 这里我们配置为空，以便展示"空状态"和"Input引导"
            let activePlan = null;
            let currentTasks = [];

            if (!activePlan && currentTasks.length === 0) {
                html = `
<div class="empty-state-box">
    <div style="font-size:64px; margin-bottom:16px;">✨</div>
    <div style="font-size:18px; font-weight:700; color:#374151; margin-bottom:8px;">准备好开始新的一天了吗？</div>
    <div style="font-size:14px; opacity:0.8; margin-bottom:24px;">试试输入: "数学作业" 或 "整理房间"</div>

    <div class="quick-chips-row">
        <div class="quick-chip type-reading" onclick="handleQuickInput('数学作业')">
            <span>📖</span>数学作业
        </div>
        <div class="quick-chip type-sport" onclick="handleQuickInput('整理房间')">
            <span>🧹</span>整理房间
        </div>
    </div>

    <button class="status-btn"
        style="margin-top:32px; width:auto; padding:0 32px; height:48px; background:linear-gradient(135deg, #8b5cf6, #7c3aed); color:white; font-size:16px; box-shadow:0 8px 20px rgba(124, 58, 237, 0.3);"
        onclick="activateInput()">
        🎙️ 我要自己说...
    </button>
</div>
`;
            }

            // 底部入口 (Always visible)
            html += `
<div onclick="openTaskDashboard()" style="
                    margin-top: 20px;
                    padding: 16px; 
                    background: rgba(255,255,255,0.4); 
                    border-radius: 20px; 
                    text-align: center; 
                    font-weight: 600; 
                    color: #6b7280; 
                    border: 2px dashed rgba(0,0,0,0.05); 
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">
    <span>📓</span> 管理所有任务与拆解
</div>
<div style="height:100px; flex-shrink:0;"></div>
`;

            listContainer.innerHTML = html;
        };
        // [Force Init] 立即执行渲染以显示空状态
        setTimeout(renderHorizontalTaskList, 200);
    </script>

    <style>
        /* 补全可能的样式缺失 */
        .empty-state-box {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 24px;
            border: 2px dashed rgba(0, 0, 0, 0.05);
            margin: 0 20px;
        }

        /* [Hotfix] 移除可能的调试背景色 */
        #horizontal-task-list {
            background: transparent !important;
        }

        /* 确保输入prompt不被遮挡 */

        /* Dashboard Overlay Styles */
        .task-dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: none;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .task-dashboard-overlay.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .td-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            background: rgba(255, 255, 255, 0.95);
        }

        .td-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background: #f9fafb;
        }

        /* [New] Chat UI Styles */
        .chat-container {
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 80vh;
            padding-bottom: 100px;
        }

        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
            animation: popIn 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .chat-bubble.ai {
            background: white;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
    <!-- [Inject] Task Dashboard Overlay -->
    <div id="task-dashboard-overlay" class="task-dashboard-overlay">
        <div style="width:100%; height:100%; display:flex; flex-direction:column; background:white; position:relative;">
            <!-- Header -->
            <div class="td-header">
                <div style="font-size:18px; font-weight:700; color:#111;">📋 任务控制台</div>
                <div onclick="closeTaskDashboard()" style="padding:8px; cursor:pointer; font-size:20px; color:#6b7280;">
                    ✕</div>
            </div>

            <!-- Content Area (Chat Flow) -->
            <div class="td-content">
                <!-- Chat will be injected here -->
            </div>
        </div>
    </div>

</body>

</html>